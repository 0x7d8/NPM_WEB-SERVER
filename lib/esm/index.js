var Y=(s=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(s,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):s)(function(s){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+s+'" is not supported')});var E=(s,e)=>()=>(s&&(e=s(s=0)),e);var be=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);import*as O from"fs";var z,Z,ee=E(()=>{z=(s,e)=>(e=e||[],O.readdirSync(s).forEach(n=>{if(O.statSync(`${s}/${n}`).isDirectory())e=z(`${s}/${n}`,e);else{let d=`${s}/${n}`;e.push(d)}}),e),Z=(s,e,r)=>(r=r||[],r=z(s,r).filter(n=>n.endsWith(e)),r)});var L,F=E(()=>{L=["OPTIONS","DELETE","PATCH","STATIC","HEAD","POST","PUT","GET"]});import*as te from"path";import*as re from"fs";var b,B,G=E(()=>{ee();F();b=(s,e)=>(s=s.replace(/\/{2,}/g,"/"),s.endsWith("/")&&s!=="/"?s.slice(0,-1):!s.startsWith("/")&&s!=="/"?`/${s}`:s.includes("/?")?s.replace("/?","?"):e&&s==="/"?"":s),B=class{constructor(e,r){e=e!=null?e:[],r=r!=null?r:[],this.routes=e,this.events=r}event(e,r){return this.events.some(n=>n.event===e)?!1:this.events.push({event:e,code:r})-1}set(e,r,n){if(r=b(r),!L.includes(e))throw TypeError(`No Valid Request Type: ${e}, Possible Values: ${L.join(", ")}`);return this.routes.some(d=>d.method===e&&d.path===r)?!1:this.routes.push({method:e,path:r,pathArray:r.split("/"),code:n,data:{addTypes:!1}})-1}setBlock(e,r){e=b(e);let n=[];for(let d=0;d<=r.length-1;d++){let m=r[d];n.push(this.routes.push({method:m.method,path:`${e}${b(m.path,!0)}`,pathArray:`${e}${b(m.path,!0)}`.split("/"),code:m.code,data:{addTypes:!1}})-1)}return n}setRedirects(e){let r=[];for(let n=0;n<=e.length-1;n++){let d=e[n];r.push(this.routes.push({method:d.method,path:b(d.path),pathArray:b(d.path,!0).split("/"),code:async m=>m.redirect(d.destination),data:{addTypes:!1}})-1)}return r}static(e,r,n){var c,i,t;e=b(e);let d=(c=n==null?void 0:n.preload)!=null?c:!1,m=(i=n==null?void 0:n.remHTML)!=null?i:!1,w=(t=n==null?void 0:n.addTypes)!=null?t:!0,g=[];for(let l of z(r)){let y=l.replace(r,"");m&&(y=y.replace("/index.html","/").replace(".html",""));let f=b(y),T=this.routes.push({method:"STATIC",path:f,pathArray:f.split("/"),code:async()=>{},data:{addTypes:w,file:l}});d&&(this.routes[T-1].data.content=re.readFileSync(l)),g.push(T-1)}return g}load(e){let r=Z(e,".js"),n=[];for(let d of r){let m=Y(te.resolve(d));if(!(!("path"in m)||!("method"in m)||!("code"in m))){if(!L.includes(m.method))throw TypeError(`No Valid Request Type: ${m.method}, Possible Values: ${L.join(", ")}`);n.push(this.routes.push({method:m.method,path:b(m.path),pathArray:b(m.path).split("/"),code:m.code,data:{addTypes:!1}})-1)}}return n}list(){return{routes:this.routes,events:this.events}}}});var x,K=E(()=>{G();x=class{constructor(e){this.data=this.mergeOptions({routes:new B,rateLimits:{enabled:!1,message:"Rate Limited",list:[],functions:new Map},body:{enabled:!0,parse:!0,maxSize:5,message:"Payload too large"},https:{enabled:!1,keyFile:"/ssl/key/path",certFile:"/ssl/cert/path"},dashboard:{enabled:!1,path:"/rjweb-dashboard"},headers:{},bind:"0.0.0.0",proxy:!1,compression:"none",cors:!1,port:2023,poweredBy:!0},e)}mergeOptions(...e){let r=n=>n&&typeof n=="object";return e.reduce((n,d)=>(Object.keys(d).forEach(m=>{let w=n[m],g=d[m];m!=="functions"&&m!=="routes"?Array.isArray(w)&&Array.isArray(g)?n[m]=w.concat(...g):r(w)&&r(g)?n[m]=this.mergeOptions(w,g):n[m]=g:n[m]=g}),n),{})}getOptions(){return this.data}}});var C,se=E(()=>{C=class{constructor(e,r){this.data={};e=e!=null?e:{},r=r!=null?r:n=>n;for(let n in e)this.data[n]=r(e[n])}has(e){return e in this.data}get(e){return this.data[e]}set(e,r){let n=e in this.data;return this.data[e]=r,n}objectCount(){return Object.keys(this.data).length}clear(e){e=e!=null?e:[];let r=0;for(let n in this.data)e.includes(n)||(delete this.data[n],r++);return r}toJSON(e){e=e!=null?e:[];let r={};for(let n in this.data)e.includes(n)||(r[n]=this.data[n]);return r}toArray(e){e=e!=null?e:[];let r=[];for(let n in this.data)e.includes(n)||r.push(this.data[n]);return r}forEach(e,r){e=e!=null?e:()=>{},r=r!=null?r:[];let n=0;for(let d in this.data)r.includes(d)||(e(d,this.data[d]),n++);return n}}});var oe,ne,ae=E(()=>{oe=(c=>(c.options="OPTIONS",c.delete="DELETE",c.patch="PATCH",c.post="POST",c.head="HEAD",c.put="PUT",c.get="GET",c.static="STATIC",c))(oe||{}),ne=oe});import{PassThrough as ve}from"stream";import*as P from"zlib";function I(s){switch(s){case"gzip":return P.createGzip();case"brotli":return P.createBrotliCompress();case"deflate":return P.createDeflate();default:return new M}}var $,M,J=E(()=>{$={gzip:"gzip",brotli:"br",deflate:"deflate",none:"none"},M=class extends ve{}});function D(s,e,r){if(!e.compressed&&!s.rawRes.headersSent&&String(s.headers.get("accept-encoding")).includes($[r.compression])){s.rawRes.setHeader("Content-Encoding",$[r.compression]),s.rawRes.setHeader("Vary","Accept-Encoding");let n=I(r.compression);n.pipe(s.rawRes),n.end(e.content,"binary")}else s.rawRes.end(e.content,"binary")}var ie=E(()=>{J()});var q,ue=E(()=>{K();q=class{constructor(e,r,n){this.globalContext=e,this.optionsCache={},this.server=r,this.options=n,this.globalContext.controller=this}setRoutes(e){let{routes:r,events:n}=e.list();return this.optionsCache.normal=r,this.optionsCache.event=n,this}setOptions(e){return this.options=new x(e).getOptions(),this}start(){return this.globalContext.routes.normal=this.optionsCache.normal,this.globalContext.routes.event=this.optionsCache.event,this.server.listen(this.options.port,this.options.bind),new Promise((e,r)=>{this.server.once("listening",()=>e({success:!0,port:this.options.port,message:"WEBSERVER STARTED"})),this.server.once("error",n=>{this.server.close(),r({success:!1,error:n,message:"WEBSERVER ERRORED"})})})}async reload(){return this.globalContext.pageDisplay="",this.globalContext.cache.files.clear(),this.globalContext.cache.routes.clear(),this.globalContext.routes.normal=this.optionsCache.normal,this.globalContext.routes.event=this.optionsCache.event,this.globalContext.data={incoming:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},outgoing:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}},this.globalContext.requests={total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},await this.stop(),await this.start(),this}stop(){return this.server.close(),this.globalContext.pageDisplay="",this.globalContext.cache.files.clear(),this.globalContext.cache.routes.clear(),this.globalContext.routes.normal=this.optionsCache.normal,this.globalContext.routes.event=this.optionsCache.event,this.globalContext.data={incoming:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},outgoing:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}},this.globalContext.requests={total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},new Promise((e,r)=>{this.server.once("close",()=>e({success:!0,message:"WEBSERVER CLOSED"})),this.server.once("error",n=>{this.server.close(),r({success:!1,error:n,message:"WEBSERVER CLOSING ERRORED"})})})}}});import*as ce from"fs/promises";import*as pe from"os";async function X(s,e,r,n,d){switch(s.url.path.replace(b(n.dashboard.path,!1),"")||"/"){case"/":let w=(await ce.readFile(`${__dirname}/stats/index.html`,"utf8")).replaceAll("/rjweb-dashboard",b(n.dashboard.path));return s.print(w);case"/stats":let g=new Date,c=g.getTime(),i=process.cpuUsage(),t=await new Promise(l=>setTimeout(()=>{let y=process.cpuUsage(i),T=(new Date().getTime()-c)*5*Ce;l((y.system+y.user)/T)},500));return s.print({requests:[e.requests.total,{hour:r.previousHours[0],amount:e.requests[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.requests[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.requests[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.requests[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.requests[r.previousHours[4]]}],data:{incoming:[e.data.incoming.total,{hour:r.previousHours[0],amount:e.data.incoming[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.data.incoming[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.data.incoming[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.data.incoming[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.data.incoming[r.previousHours[4]]}],outgoing:[e.data.outgoing.total,{hour:r.previousHours[0],amount:e.data.outgoing[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.data.outgoing[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.data.outgoing[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.data.outgoing[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.data.outgoing[r.previousHours[4]]}]},cpu:{time:`${g.getHours()}:${g.getMinutes()}:${g.getSeconds()}`,usage:t.toFixed(2)},memory:{time:`${g.getHours()}:${g.getMinutes()}:${g.getSeconds()}`,usage:(process.memoryUsage().heapUsed/1e3/1e3).toFixed(2)},routes:d,cached:e.cache.files.objectCount()+e.cache.routes.objectCount()})}}var Ce,me=E(()=>{G();Ce=pe.cpus().length});import{EventEmitter as we}from"stream";import*as Te from"http";import*as He from"https";import*as de from"querystring";import*as fe from"zlib";import*as he from"path";import*as le from"url";import*as A from"fs";var Se=be((rt,ge)=>{G();K();se();ae();J();ie();ue();me();F();ge.exports={routeList:B,serverOptions:x,valueCollection:C,types:ne,initialize(s){s=new x(s).getOptions();let e={controller:null,requests:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},pageDisplay:"",data:{incoming:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},outgoing:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}},routes:{normal:[],event:[]},cache:{files:new C,routes:new C}},r=async(c,i,t)=>{switch(c){case"error":{let l=e.routes.event.find(y=>y.event==="error");l?Promise.resolve(l.code(i)).catch(y=>{console.log(y),i.status(500),t.content=Buffer.from(`An Error occured in your Error Event (what the hell?)
${y.stack}`)}):(console.log(i.error),i.status(500),t.content=Buffer.from(`An Error occured
${i.error.stack}`))}case"request":{let l=!1,y=e.routes.event.find(f=>f.event==="request");return y&&await Promise.resolve(y.code(i)).catch(f=>{l=!0,console.log(f),i.status(500),t.content=Buffer.from(`An Error occured in your Request Event
${f.stack}`)}),l}case"notfound":{let l=!1,y=e.routes.event.find(f=>f.event==="notfound");if(y)await Promise.resolve(y.code(i)).catch(f=>{l=!0,console.log(f),i.status(500),t.content=Buffer.from(`An Error occured in your Notfound Event
${f.stack}`)});else{let f="";if(e.pageDisplay)f=e.pageDisplay;else{for(let T of e.routes.normal){let u=T.method==="STATIC"?"GET":T.method;f+=`[-] [${u}] ${T.path}
`}e.pageDisplay=f}i.status(404),t.content=Buffer.from(`[!] COULDNT FIND [${i.url.method}]: ${i.url.pathname.toUpperCase()}
[i] AVAILABLE PAGES:

${f}`)}return l}}},n=()=>Array.from({length:5},(c,i)=>(new Date().getHours()-(4-i)+24)%24);setInterval(()=>{let c=n();e.requests[c[0]-1]=0,e.data.incoming[c[0]-1]=0,e.data.outgoing[c[0]-1]=0},3e5);let d={},m,w;if(s.https.enabled){try{m=A.readFileSync(s.https.keyFile),w=A.readFileSync(s.https.certFile)}catch(c){throw new Error(`Cant access your HTTPS Key or Cert file! (${s.https.keyFile} / ${s.https.certFile})`)}d={key:m,cert:w}}let g=(s.https.enabled?He:Te).createServer(d,async(c,i)=>{let t={content:Buffer.from(""),compressed:!1,events:new we,waiting:!1,continue:!0,execute:{route:null,static:!1,exists:!1,dashboard:!1},body:{raw:Buffer.from(""),parsed:""},url:{...le.parse(b(c.url)),method:c.method},previousHours:n()};t.events.on("noWaiting",()=>t.waiting=!1),i.once("close",()=>t.events.emit("endRequest")),s.body.enabled&&c.on("data",l=>{if(t.body.raw=Buffer.concat([t.body.raw,Buffer.from(l)]),t.body.raw.byteLength>=s.body.maxSize*1e6){switch(i.statusCode=413,t.continue=!1,typeof s.body.message){case"object":i.setHeader("Content-Type","application/json"),t.content=Buffer.from(JSON.stringify(s.body.message));break;case"string":t.content=Buffer.from(s.body.message);break;case"symbol":t.content=Buffer.from(s.body.message.toString());break;case"bigint":case"number":case"boolean":t.content=Buffer.from(String(s.body.message));break;case"undefined":t.content=Buffer.from("");break}return D({headers:new C(c.headers,decodeURIComponent),rawRes:i},t,s)}else e.data.incoming.total+=t.body.raw.byteLength,e.data.incoming[t.previousHours[4]]+=t.body.raw.byteLength}).on("end",()=>{t.continue&&t.events.emit("startRequest")}),t.events.once("startRequest",async()=>{var _,Q;if(Object.keys(s.headers).forEach(o=>{i.setHeader(o,s.headers[o])}),s.cors&&(i.setHeader("Access-Control-Allow-Headers","*"),i.setHeader("Access-Control-Allow-Origin","*"),i.setHeader("Access-Control-Request-Method","*"),i.setHeader("Access-Control-Allow-Methods",L.join(",")),c.method==="OPTIONS"))return i.end("");let l={},y=t.url.pathname.split("/");for(let o=0;o<=e.routes.normal.length-1;o++){let a=e.routes.normal[o];if(e.cache.routes.has(`route::${t.url.pathname}`)){let h=e.cache.routes.get(`route::${t.url.pathname}`);l=h.params,t.execute.route=h.route,t.execute.static=h.route.method==="STATIC",t.execute.exists=!0;break}if(s.dashboard.enabled&&(t.url.pathname===b(s.dashboard.path)||t.url.pathname===b(s.dashboard.path)+"/stats")){t.execute.route={method:"GET",path:a.path,pathArray:a.path.split("/"),code:async h=>await X(h,e,t,s,e.routes.normal.length),data:{addTypes:!1}},t.execute.static=!1,t.execute.exists=!0,t.execute.dashboard=!0;break}if(!(a.method!=="STATIC"&&a.method!==c.method)&&!(a.method==="STATIC"&&c.method!=="GET")&&a.pathArray.length===y.length){if(t.execute.exists)break;if(a.path===t.url.pathname&&a.method===c.method){t.execute.route=a,t.execute.exists=!0,e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:{}});break}if(a.path===t.url.pathname&&a.method==="STATIC"){t.execute.route=a,t.execute.static=!0,t.execute.exists=!0,e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:{}});break}for(let h=0;h<=a.pathArray.length-1;h++){let p=a.pathArray[h],v=y[h];if(!/^:.*:$/.test(p)&&v!==p)break;if(p===v)continue;if(/^:.*:$/.test(p)){l[p.substring(1,p.length-1)]=v,t.execute.route=a,t.execute.exists=!0;continue}}if(t.execute.exists){e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:l});break}}}s.poweredBy&&i.setHeader("X-Powered-By","rjweb-server");let f;s.proxy&&c.headers["x-forwarded-for"]?f=c.headers["x-forwarded-for"]:f=c.socket.remoteAddress;let T={};if(c.headers.cookie&&c.headers.cookie.split(";").forEach(o=>{let a=o.split("=");T[a.shift().trim()]=a.join("=")}),c.headers["content-encoding"]==="gzip"&&(t.body.raw=await new Promise(o=>fe.gunzip(t.body.raw,(a,h)=>{o(a?t.body.raw:h)}))),s.body.parse)try{JSON.parse(t.body.raw.toString())}catch(o){t.body.parsed=t.body.raw.toString()}else t.body.parsed=t.body.raw.toString();let u={controller:e.controller,headers:new C(c.headers,decodeURIComponent),cookies:new C(T,decodeURIComponent),params:new C(l,decodeURIComponent),queries:new C(de.parse(t.url.query),decodeURIComponent),client:{userAgent:c.headers["user-agent"],httpVersion:c.httpVersion,port:c.socket.remotePort,ip:f},body:t.body.parsed,url:t.url,rawServer:g,rawReq:c,rawRes:i,"@":{},setHeader(o,a){return i.setHeader(o,a),u},setCustom(o,a){return u["@"][o]=a,u},redirect(o,a){return i.statusCode=a!=null?a:302,i.setHeader("Location",o),u},print(o,a){var H,k,j;let h=(H=a==null?void 0:a.niceJSON)!=null?H:!1,p=(k=a==null?void 0:a.contentType)!=null?k:"",v=(j=a==null?void 0:a.returnFunctions)!=null?j:!1;switch(typeof o){case"object":i.setHeader("Content-Type","application/json"),h?t.content=Buffer.from(JSON.stringify(o,void 0,1)):t.content=Buffer.from(JSON.stringify(o));break;case"string":p&&i.setHeader("Content-Type",p),t.content=Buffer.from(o);break;case"symbol":p&&i.setHeader("Content-Type",p),t.content=Buffer.from(o.toString());break;case"bigint":case"number":case"boolean":p&&i.setHeader("Content-Type",p),t.content=Buffer.from(String(o));break;case"function":t.waiting=!0,(async()=>{let W=await o();if(typeof W!="function")u.print(W,{niceJSON:h,contentType:p});else if(v)u.print(W,{niceJSON:h,contentType:p,returnFunctions:v});else return u.error=new Error("Cant return functions from functions, consider using async/await"),r("error",u,t);let N=t.content;t.content=N,t.events.emit("noWaiting")})();break;case"undefined":p&&i.setHeader("Content-Type",p),t.content=Buffer.from("");break}return u},status(o){return i.statusCode=o!=null?o:200,u},printFile(o,a){var j,W,N;let h=(j=a==null?void 0:a.addTypes)!=null?j:!0,p=(W=a==null?void 0:a.contentType)!=null?W:"",v=(N=a==null?void 0:a.cache)!=null?N:!1;h&&!p?(o.endsWith(".pdf")&&u.setHeader("Content-Type","application/pdf"),o.endsWith(".js")&&u.setHeader("Content-Type","text/javascript"),o.endsWith(".html")&&u.setHeader("Content-Type","text/html"),o.endsWith(".css")&&u.setHeader("Content-Type","text/css"),o.endsWith(".csv")&&u.setHeader("Content-Type","text/csv"),o.endsWith(".mpeg")&&u.setHeader("Content-Type","video/mpeg"),o.endsWith(".mp4")&&u.setHeader("Content-Type","video/mp4"),o.endsWith(".webm")&&u.setHeader("Content-Type","video/webm"),o.endsWith(".bmp")&&u.setHeader("Content-Type","image/bmp")):p&&i.setHeader("Content-Type",p);let H,k=!1;if(u.headers.get("accept-encoding").includes($[s.compression])){if(u.rawRes.setHeader("Content-Encoding",$[s.compression]),u.rawRes.setHeader("Vary","Accept-Encoding"),t.continue=!1,e.cache.files.has(`file::${o}`))return e.data.outgoing.total+=e.cache.files.get(`file::${o}`).byteLength,e.data.outgoing[t.previousHours[4]]+=e.cache.files.get(`file::${o}`).byteLength,t.content=e.cache.files.get(`file::${o}`),t.continue=!0,u;if(e.cache.files.has(`file::${s.compression}::${o}`))return t.compressed=!0,e.data.outgoing.total+=e.cache.files.get(`file::${s.compression}::${o}`).byteLength,e.data.outgoing[t.previousHours[4]]+=e.cache.files.get(`file::${s.compression}::${o}`).byteLength,t.content=e.cache.files.get(`file::${s.compression}::${o}`),t.continue=!0,u;let S=I(s.compression);try{H=A.createReadStream(o),t.waiting=!0,H.pipe(S),S.pipe(i)}catch(R){k=!0,u.error=R,r("error",u,t)}if(k)return;S.on("data",R=>{var U;if(e.data.outgoing.total+=R.byteLength,e.data.outgoing[t.previousHours[4]]+=R.byteLength,v){let ye=(U=e.cache.files.get(`file::${s.compression}::${o}`))!=null?U:Buffer.from("");e.cache.files.set(`file::${s.compression}::${o}`,Buffer.concat([ye,R]))}}),S.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>{H.close(),S.close()})}else{try{H=A.createReadStream(o),t.waiting=!0,H.pipe(i)}catch(S){k=!0,u.error=S,r("error",u,t)}H.on("data",S=>{var R;if(e.data.outgoing.total+=S.byteLength,e.data.outgoing[t.previousHours[4]]+=S.byteLength,v){let U=(R=e.cache.files.get(`file::${s.compression}::${o}`))!=null?R:Buffer.from("");e.cache.files.set(`file::${s.compression}::${o}`,Buffer.concat([U,S]))}}),H.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>H.close())}return u}},V=!1;if(t.execute.dashboard||(V=await r("request",u,t)),!V){if(s.rateLimits.enabled){for(let o of s.rateLimits.list)if(t.url.pathname.startsWith(o.path)&&(i.setHeader("X-RateLimit-Limit",o.times),i.setHeader("X-RateLimit-Remaining",o.times-((_=await s.rateLimits.functions.get(f+o.path))!=null?_:0)),i.setHeader("X-RateLimit-Reset-Every",o.timeout),await s.rateLimits.functions.set(f+o.path,((Q=await s.rateLimits.functions.get(f+o.path))!=null?Q:0)+1),setTimeout(async()=>{var a;await s.rateLimits.functions.set(f+o.path,((a=await s.rateLimits.functions.get(f+o.path))!=null?a:0)-1)},o.timeout),await s.rateLimits.functions.get(f+o.path)>o.times))return i.statusCode=429,V=!0,u.print(s.rateLimits.message),D(u,t,s)}if(s.dashboard.enabled&&!t.execute.dashboard&&(e.requests.total++,e.requests[t.previousHours[4]]++),!await new Promise(o=>{if(!t.waiting)return o(!1);t.events.once("noWaiting",()=>o(!1)),t.events.once("endRequest",()=>o(!0))}))if(t.execute.exists&&!V){if(!t.execute.static)await Promise.resolve(t.execute.route.code(u)).catch(o=>{u.error=o,V=!0,r("error",u,t)});else if(t.execute.route.data.addTypes&&(t.execute.route.path.endsWith(".pdf")&&u.setHeader("Content-Type","application/pdf"),t.execute.route.path.endsWith(".js")&&u.setHeader("Content-Type","text/javascript"),t.execute.route.path.endsWith(".html")&&u.setHeader("Content-Type","text/html"),t.execute.route.path.endsWith(".css")&&u.setHeader("Content-Type","text/css"),t.execute.route.path.endsWith(".csv")&&u.setHeader("Content-Type","text/csv"),t.execute.route.path.endsWith(".mpeg")&&u.setHeader("Content-Type","video/mpeg"),t.execute.route.path.endsWith(".mp4")&&u.setHeader("Content-Type","video/mp4"),t.execute.route.path.endsWith(".webm")&&u.setHeader("Content-Type","video/webm"),t.execute.route.path.endsWith(".bmp")&&u.setHeader("Content-Type","image/bmp")),t.continue=!1,"content"in t.execute.route.data)e.data.outgoing.total+=t.execute.route.data.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.execute.route.data.content.byteLength,t.content=t.execute.route.data.content;else{let o=he.resolve(t.execute.route.data.file),a,h=!1;if(s.compression&&String(u.headers.get("accept-encoding")).includes($[s.compression])){u.rawRes.setHeader("Content-Encoding",$[s.compression]),u.rawRes.setHeader("Vary","Accept-Encoding");let p=I(s.compression);try{a=A.createReadStream(o),t.waiting=!0,a.pipe(p),p.pipe(i)}catch(v){h=!0,u.error=v,r("error",u,t)}if(h)return;p.on("data",v=>{e.data.outgoing.total+=v.byteLength,e.data.outgoing[t.previousHours[4]]+=v.byteLength}),p.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>{a.close(),p.close()})}else{try{a=A.createReadStream(o),t.waiting=!0,a.pipe(i)}catch(p){h=!0,u.error=p,r("error",u,t)}a.on("data",p=>{e.data.outgoing.total+=p.byteLength,e.data.outgoing[t.previousHours[4]]+=p.byteLength}),a.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>a.close())}}await new Promise(o=>{if(!t.waiting)return o(!0);t.events.once("noWaiting",()=>o(!1))}),t.content&&t.continue?(e.data.outgoing.total+=t.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.content.byteLength,D(u,t,s)):i.end()}else r("notfound",u,t),await new Promise(o=>{if(!t.waiting)return o(!0);t.events.once("noWaiting",()=>o(!1))}),t.content&&t.continue?(e.data.outgoing.total+=t.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.content.byteLength,D(u,t,s)):i.end()}}),s.body.enabled||t.events.emit("startRequest")});return e.controller=new q(e,g,s),e.controller}}});export default Se();
