#!/usr/bin/env node
var Ee=Object.create;var oe=Object.defineProperty;var Be=Object.getOwnPropertyDescriptor;var Le=Object.getOwnPropertyNames;var Ae=Object.getPrototypeOf,We=Object.prototype.hasOwnProperty;var ne=(s=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(s,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):s)(function(s){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+s+'" is not supported')});var $=(s,e)=>()=>(s&&(e=s(s=0)),e);var ke=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var je=(s,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let c of Le(e))!We.call(s,c)&&c!==r&&oe(s,c,{get:()=>e[c],enumerable:!(o=Be(e,c))||o.enumerable});return s};var Pe=(s,e,r)=>(r=s!=null?Ee(Ae(s)):{},je(e||!s||!s.__esModule?oe(r,"default",{value:s,enumerable:!0}):r,s));import*as J from"fs";var G,ie,ue=$(()=>{G=(s,e)=>(e=e||[],J.readdirSync(s).forEach(o=>{if(J.statSync(`${s}/${o}`).isDirectory())e=G(`${s}/${o}`,e);else{let c=`${s}/${o}`;e.push(c)}}),e),ie=(s,e,r)=>(r=r||[],r=G(s,r).filter(o=>o.endsWith(e)),r)});var k,_=$(()=>{k=["OPTIONS","DELETE","PATCH","STATIC","HEAD","POST","PUT","GET"]});import*as ce from"path";import*as le from"fs";var v,j,K=$(()=>{ue();_();v=(s,e)=>(s=s.replace(/\/{2,}/g,"/"),s.endsWith("/")&&s!=="/"?s.slice(0,-1):!s.startsWith("/")&&s!=="/"?`/${s}`:s.includes("/?")?s.replace("/?","?"):e&&s==="/"?"":s),j=class{constructor(e,r){e=e!=null?e:[],r=r!=null?r:[],this.routes=e,this.events=r}event(e,r){return this.events.some(o=>o.event===e)?!1:this.events.push({event:e,code:r})-1}set(e,r,o){if(r=v(r),!k.includes(e))throw TypeError(`No Valid Request Type: ${e}, Possible Values: ${k.join(", ")}`);return this.routes.some(c=>c.method===e&&c.path===r)?!1:this.routes.push({method:e,path:r,pathArray:r.split("/"),code:o,data:{addTypes:!1}})-1}setBlock(e,r){e=v(e);let o=[];for(let c=0;c<=r.length-1;c++){let l=r[c];o.push(this.routes.push({method:l.method,path:`${e}${v(l.path,!0)}`,pathArray:`${e}${v(l.path,!0)}`.split("/"),code:l.code,data:{addTypes:!1}})-1)}return o}setRedirects(e){let r=[];for(let o=0;o<=e.length-1;o++){let c=e[o];r.push(this.routes.push({method:c.method,path:v(c.path),pathArray:v(c.path,!0).split("/"),code:async l=>l.redirect(c.destination),data:{addTypes:!1}})-1)}return r}static(e,r,o){var m,i,t;e=v(e);let c=(m=o==null?void 0:o.preload)!=null?m:!1,l=(i=o==null?void 0:o.remHTML)!=null?i:!1,T=(t=o==null?void 0:o.addTypes)!=null?t:!0,b=[];for(let g of G(r)){let y=g.replace(r,"");l&&(y=y.replace("/index.html","/").replace(".html",""));let f=v(y),H=this.routes.push({method:"STATIC",path:f,pathArray:f.split("/"),code:async()=>{},data:{addTypes:T,file:g}});c&&(this.routes[H-1].data.content=le.readFileSync(g)),b.push(H-1)}return b}load(e){let r=ie(e,".js"),o=[];for(let c of r){let l=ne(ce.resolve(c));if(!(!("path"in l)||!("method"in l)||!("code"in l))){if(!k.includes(l.method))throw TypeError(`No Valid Request Type: ${l.method}, Possible Values: ${k.join(", ")}`);o.push(this.routes.push({method:l.method,path:v(l.path),pathArray:v(l.path).split("/"),code:l.code,data:{addTypes:!1}})-1)}}return o}list(){return{routes:this.routes,events:this.events}}}});var L,X=$(()=>{K();L=class{constructor(e){this.data=this.mergeOptions({routes:new j,rateLimits:{enabled:!1,message:"Rate Limited",list:[],functions:new Map},body:{enabled:!0,parse:!0,maxSize:5,message:"Payload too large"},https:{enabled:!1,keyFile:"/ssl/key/path",certFile:"/ssl/cert/path"},dashboard:{enabled:!1,path:"/rjweb-dashboard"},headers:{},bind:"0.0.0.0",proxy:!1,compression:"none",cors:!1,port:2023,poweredBy:!0},e)}mergeOptions(...e){let r=o=>o&&typeof o=="object";return e.reduce((o,c)=>(Object.keys(c).forEach(l=>{let T=o[l],b=c[l];l!=="functions"&&l!=="routes"?Array.isArray(T)&&Array.isArray(b)?o[l]=T.concat(...b):r(T)&&r(b)?o[l]=this.mergeOptions(T,b):o[l]=b:o[l]=b}),o),{})}getOptions(){return this.data}}});var x,me=$(()=>{x=class{constructor(e,r){this.data={};e=e!=null?e:{},r=r!=null?r:o=>o;for(let o in e)this.data[o]=r(e[o])}has(e){return e in this.data}get(e){return this.data[e]}set(e,r){let o=e in this.data;return this.data[e]=r,o}objectCount(){return Object.keys(this.data).length}clear(e){e=e!=null?e:[];let r=0;for(let o in this.data)e.includes(o)||(delete this.data[o],r++);return r}toJSON(e){e=e!=null?e:[];let r={};for(let o in this.data)e.includes(o)||(r[o]=this.data[o]);return r}toArray(e){e=e!=null?e:[];let r=[];for(let o in this.data)e.includes(o)||r.push(this.data[o]);return r}forEach(e,r){e=e!=null?e:()=>{},r=r!=null?r:[];let o=0;for(let c in this.data)r.includes(c)||(e(c,this.data[c]),o++);return o}}});var pe,de,fe=$(()=>{pe=(m=>(m.options="OPTIONS",m.delete="DELETE",m.patch="PATCH",m.post="POST",m.head="HEAD",m.put="PUT",m.get="GET",m.static="STATIC",m))(pe||{}),de=pe});import{PassThrough as Ve}from"stream";import*as D from"zlib";function V(s){switch(s){case"gzip":return D.createGzip();case"brotli":return D.createBrotliCompress();case"deflate":return D.createDeflate();default:return new Q}}var A,Q,Y=$(()=>{A={gzip:"gzip",brotli:"br",deflate:"deflate",none:"none"},Q=class extends Ve{}});function N(s,e,r){if(!e.compressed&&!s.rawRes.headersSent&&String(s.headers.get("accept-encoding")).includes(A[r.compression])){s.rawRes.setHeader("Content-Encoding",A[r.compression]),s.rawRes.setHeader("Vary","Accept-Encoding");let o=V(r.compression);o.pipe(s.rawRes),o.end(e.content,"binary")}else s.rawRes.end(e.content,"binary")}var he=$(()=>{Y()});var F,ge=$(()=>{X();F=class{constructor(e,r,o){this.globalContext=e,this.optionsCache={},this.server=r,this.options=o,this.globalContext.controller=this}setRoutes(e){let{routes:r,events:o}=e.list();return this.optionsCache.normal=r,this.optionsCache.event=o,this}setOptions(e){return this.options=new L(e).getOptions(),this}start(){return this.globalContext.routes.normal=this.optionsCache.normal,this.globalContext.routes.event=this.optionsCache.event,this.server.listen(this.options.port,this.options.bind),new Promise((e,r)=>{this.server.once("listening",()=>e({success:!0,port:this.options.port,message:"WEBSERVER STARTED"})),this.server.once("error",o=>{this.server.close(),r({success:!1,error:o,message:"WEBSERVER ERRORED"})})})}async reload(){return this.globalContext.pageDisplay="",this.globalContext.cache.files.clear(),this.globalContext.cache.routes.clear(),this.globalContext.routes.normal=this.optionsCache.normal,this.globalContext.routes.event=this.optionsCache.event,this.globalContext.data={incoming:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},outgoing:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}},this.globalContext.requests={total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},await this.stop(),await this.start(),this}stop(){return this.server.close(),this.globalContext.pageDisplay="",this.globalContext.cache.files.clear(),this.globalContext.cache.routes.clear(),this.globalContext.routes.normal=this.optionsCache.normal,this.globalContext.routes.event=this.optionsCache.event,this.globalContext.data={incoming:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},outgoing:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}},this.globalContext.requests={total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},new Promise((e,r)=>{this.server.once("close",()=>e({success:!0,message:"WEBSERVER CLOSED"})),this.server.once("error",o=>{this.server.close(),r({success:!1,error:o,message:"WEBSERVER CLOSING ERRORED"})})})}}});import*as be from"fs/promises";import*as ye from"os";async function Z(s,e,r,o,c){switch(s.url.path.replace(v(o.dashboard.path,!1),"")||"/"){case"/":let T=(await be.readFile(`${__dirname}/stats/index.html`,"utf8")).replaceAll("/rjweb-dashboard",v(o.dashboard.path));return s.print(T);case"/stats":let b=new Date,m=b.getTime(),i=process.cpuUsage(),t=await new Promise(g=>setTimeout(()=>{let y=process.cpuUsage(i),H=(new Date().getTime()-m)*5*Ne;g((y.system+y.user)/H)},500));return s.print({requests:[e.requests.total,{hour:r.previousHours[0],amount:e.requests[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.requests[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.requests[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.requests[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.requests[r.previousHours[4]]}],data:{incoming:[e.data.incoming.total,{hour:r.previousHours[0],amount:e.data.incoming[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.data.incoming[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.data.incoming[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.data.incoming[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.data.incoming[r.previousHours[4]]}],outgoing:[e.data.outgoing.total,{hour:r.previousHours[0],amount:e.data.outgoing[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.data.outgoing[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.data.outgoing[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.data.outgoing[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.data.outgoing[r.previousHours[4]]}]},cpu:{time:`${b.getHours()}:${b.getMinutes()}:${b.getSeconds()}`,usage:t.toFixed(2)},memory:{time:`${b.getHours()}:${b.getMinutes()}:${b.getSeconds()}`,usage:(process.memoryUsage().heapUsed/1e3/1e3).toFixed(2)},routes:c,cached:e.cache.files.objectCount()+e.cache.routes.objectCount()})}}var Ne,ve=$(()=>{K();Ne=ye.cpus().length});import{EventEmitter as Oe}from"stream";import*as Me from"http";import*as qe from"https";import*as we from"querystring";import*as Ce from"zlib";import*as xe from"path";import*as Te from"url";import*as W from"fs";var Re=ke((wt,He)=>{K();X();me();fe();Y();he();ge();ve();_();He.exports={routeList:j,serverOptions:L,valueCollection:x,types:de,initialize(s){s=new L(s).getOptions();let e={controller:null,requests:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},pageDisplay:"",data:{incoming:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},outgoing:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}},routes:{normal:[],event:[]},cache:{files:new x,routes:new x}},r=async(m,i,t)=>{switch(m){case"error":{let g=e.routes.event.find(y=>y.event==="error");g?Promise.resolve(g.code(i)).catch(y=>{console.log(y),i.status(500),t.content=Buffer.from(`An Error occured in your Error Event (what the hell?)
${y.stack}`)}):(console.log(i.error),i.status(500),t.content=Buffer.from(`An Error occured
${i.error.stack}`))}case"request":{let g=!1,y=e.routes.event.find(f=>f.event==="request");return y&&await Promise.resolve(y.code(i)).catch(f=>{g=!0,console.log(f),i.status(500),t.content=Buffer.from(`An Error occured in your Request Event
${f.stack}`)}),g}case"notfound":{let g=!1,y=e.routes.event.find(f=>f.event==="notfound");if(y)await Promise.resolve(y.code(i)).catch(f=>{g=!0,console.log(f),i.status(500),t.content=Buffer.from(`An Error occured in your Notfound Event
${f.stack}`)});else{let f="";if(e.pageDisplay)f=e.pageDisplay;else{for(let H of e.routes.normal){let u=H.method==="STATIC"?"GET":H.method;f+=`[-] [${u}] ${H.path}
`}e.pageDisplay=f}i.status(404),t.content=Buffer.from(`[!] COULDNT FIND [${i.url.method}]: ${i.url.pathname.toUpperCase()}
[i] AVAILABLE PAGES:

${f}`)}return g}}},o=()=>Array.from({length:5},(m,i)=>(new Date().getHours()-(4-i)+24)%24);setInterval(()=>{let m=o();e.requests[m[0]-1]=0,e.data.incoming[m[0]-1]=0,e.data.outgoing[m[0]-1]=0},3e5);let c={},l,T;if(s.https.enabled){try{l=W.readFileSync(s.https.keyFile),T=W.readFileSync(s.https.certFile)}catch(m){throw new Error(`Cant access your HTTPS Key or Cert file! (${s.https.keyFile} / ${s.https.certFile})`)}c={key:l,cert:T}}let b=(s.https.enabled?qe:Me).createServer(c,async(m,i)=>{let t={content:Buffer.from(""),compressed:!1,events:new Oe,waiting:!1,continue:!0,execute:{route:null,static:!1,exists:!1,dashboard:!1},body:{raw:Buffer.from(""),parsed:""},url:{...Te.parse(v(m.url)),method:m.method},previousHours:o()};t.events.on("noWaiting",()=>t.waiting=!1),i.once("close",()=>t.events.emit("endRequest")),s.body.enabled&&m.on("data",g=>{if(t.body.raw=Buffer.concat([t.body.raw,Buffer.from(g)]),t.body.raw.byteLength>=s.body.maxSize*1e6){switch(i.statusCode=413,t.continue=!1,typeof s.body.message){case"object":i.setHeader("Content-Type","application/json"),t.content=Buffer.from(JSON.stringify(s.body.message));break;case"string":t.content=Buffer.from(s.body.message);break;case"symbol":t.content=Buffer.from(s.body.message.toString());break;case"bigint":case"number":case"boolean":t.content=Buffer.from(String(s.body.message));break;case"undefined":t.content=Buffer.from("");break}return N({headers:new x(m.headers,decodeURIComponent),rawRes:i},t,s)}else e.data.incoming.total+=t.body.raw.byteLength,e.data.incoming[t.previousHours[4]]+=t.body.raw.byteLength}).on("end",()=>{t.continue&&t.events.emit("startRequest")}),t.events.once("startRequest",async()=>{var re,se;if(Object.keys(s.headers).forEach(n=>{i.setHeader(n,s.headers[n])}),s.cors&&(i.setHeader("Access-Control-Allow-Headers","*"),i.setHeader("Access-Control-Allow-Origin","*"),i.setHeader("Access-Control-Request-Method","*"),i.setHeader("Access-Control-Allow-Methods",k.join(",")),m.method==="OPTIONS"))return i.end("");let g={},y=t.url.pathname.split("/");for(let n=0;n<=e.routes.normal.length-1;n++){let a=e.routes.normal[n];if(e.cache.routes.has(`route::${t.url.pathname}`)){let h=e.cache.routes.get(`route::${t.url.pathname}`);g=h.params,t.execute.route=h.route,t.execute.static=h.route.method==="STATIC",t.execute.exists=!0;break}if(s.dashboard.enabled&&(t.url.pathname===v(s.dashboard.path)||t.url.pathname===v(s.dashboard.path)+"/stats")){t.execute.route={method:"GET",path:a.path,pathArray:a.path.split("/"),code:async h=>await Z(h,e,t,s,e.routes.normal.length),data:{addTypes:!1}},t.execute.static=!1,t.execute.exists=!0,t.execute.dashboard=!0;break}if(!(a.method!=="STATIC"&&a.method!==m.method)&&!(a.method==="STATIC"&&m.method!=="GET")&&a.pathArray.length===y.length){if(t.execute.exists)break;if(a.path===t.url.pathname&&a.method===m.method){t.execute.route=a,t.execute.exists=!0,e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:{}});break}if(a.path===t.url.pathname&&a.method==="STATIC"){t.execute.route=a,t.execute.static=!0,t.execute.exists=!0,e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:{}});break}for(let h=0;h<=a.pathArray.length-1;h++){let p=a.pathArray[h],w=y[h];if(!/^:.*:$/.test(p)&&w!==p)break;if(p===w)continue;if(/^:.*:$/.test(p)){g[p.substring(1,p.length-1)]=w,t.execute.route=a,t.execute.exists=!0;continue}}if(t.execute.exists){e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:g});break}}}s.poweredBy&&i.setHeader("X-Powered-By","rjweb-server");let f;s.proxy&&m.headers["x-forwarded-for"]?f=m.headers["x-forwarded-for"]:f=m.socket.remoteAddress;let H={};if(m.headers.cookie&&m.headers.cookie.split(";").forEach(n=>{let a=n.split("=");H[a.shift().trim()]=a.join("=")}),m.headers["content-encoding"]==="gzip"&&(t.body.raw=await new Promise(n=>Ce.gunzip(t.body.raw,(a,h)=>{n(a?t.body.raw:h)}))),s.body.parse)try{JSON.parse(t.body.raw.toString())}catch(n){t.body.parsed=t.body.raw.toString()}else t.body.parsed=t.body.raw.toString();let u={controller:e.controller,headers:new x(m.headers,decodeURIComponent),cookies:new x(H,decodeURIComponent),params:new x(g,decodeURIComponent),queries:new x(we.parse(t.url.query),decodeURIComponent),client:{userAgent:m.headers["user-agent"],httpVersion:m.httpVersion,port:m.socket.remotePort,ip:f},body:t.body.parsed,url:t.url,rawServer:b,rawReq:m,rawRes:i,"@":{},setHeader(n,a){return i.setHeader(n,a),u},setCustom(n,a){return u["@"][n]=a,u},redirect(n,a){return i.statusCode=a!=null?a:302,i.setHeader("Location",n),u},print(n,a){var R,P,q;let h=(R=a==null?void 0:a.niceJSON)!=null?R:!1,p=(P=a==null?void 0:a.contentType)!=null?P:"",w=(q=a==null?void 0:a.returnFunctions)!=null?q:!1;switch(typeof n){case"object":i.setHeader("Content-Type","application/json"),h?t.content=Buffer.from(JSON.stringify(n,void 0,1)):t.content=Buffer.from(JSON.stringify(n));break;case"string":p&&i.setHeader("Content-Type",p),t.content=Buffer.from(n);break;case"symbol":p&&i.setHeader("Content-Type",p),t.content=Buffer.from(n.toString());break;case"bigint":case"number":case"boolean":p&&i.setHeader("Content-Type",p),t.content=Buffer.from(String(n));break;case"function":t.waiting=!0,(async()=>{let I=await n();if(typeof I!="function")u.print(I,{niceJSON:h,contentType:p});else if(w)u.print(I,{niceJSON:h,contentType:p,returnFunctions:w});else return u.error=new Error("Cant return functions from functions, consider using async/await"),r("error",u,t);let U=t.content;t.content=U,t.events.emit("noWaiting")})();break;case"undefined":p&&i.setHeader("Content-Type",p),t.content=Buffer.from("");break}return u},status(n){return i.statusCode=n!=null?n:200,u},printFile(n,a){var q,I,U;let h=(q=a==null?void 0:a.addTypes)!=null?q:!0,p=(I=a==null?void 0:a.contentType)!=null?I:"",w=(U=a==null?void 0:a.cache)!=null?U:!1;h&&!p?(n.endsWith(".pdf")&&u.setHeader("Content-Type","application/pdf"),n.endsWith(".js")&&u.setHeader("Content-Type","text/javascript"),n.endsWith(".html")&&u.setHeader("Content-Type","text/html"),n.endsWith(".css")&&u.setHeader("Content-Type","text/css"),n.endsWith(".csv")&&u.setHeader("Content-Type","text/csv"),n.endsWith(".mpeg")&&u.setHeader("Content-Type","video/mpeg"),n.endsWith(".mp4")&&u.setHeader("Content-Type","video/mp4"),n.endsWith(".webm")&&u.setHeader("Content-Type","video/webm"),n.endsWith(".bmp")&&u.setHeader("Content-Type","image/bmp")):p&&i.setHeader("Content-Type",p);let R,P=!1;if(u.headers.get("accept-encoding").includes(A[s.compression])){if(u.rawRes.setHeader("Content-Encoding",A[s.compression]),u.rawRes.setHeader("Vary","Accept-Encoding"),t.continue=!1,e.cache.files.has(`file::${n}`))return e.data.outgoing.total+=e.cache.files.get(`file::${n}`).byteLength,e.data.outgoing[t.previousHours[4]]+=e.cache.files.get(`file::${n}`).byteLength,t.content=e.cache.files.get(`file::${n}`),t.continue=!0,u;if(e.cache.files.has(`file::${s.compression}::${n}`))return t.compressed=!0,e.data.outgoing.total+=e.cache.files.get(`file::${s.compression}::${n}`).byteLength,e.data.outgoing[t.previousHours[4]]+=e.cache.files.get(`file::${s.compression}::${n}`).byteLength,t.content=e.cache.files.get(`file::${s.compression}::${n}`),t.continue=!0,u;let S=V(s.compression);try{R=W.createReadStream(n),t.waiting=!0,R.pipe(S),S.pipe(i)}catch(B){P=!0,u.error=B,r("error",u,t)}if(P)return;S.on("data",B=>{var z;if(e.data.outgoing.total+=B.byteLength,e.data.outgoing[t.previousHours[4]]+=B.byteLength,w){let $e=(z=e.cache.files.get(`file::${s.compression}::${n}`))!=null?z:Buffer.from("");e.cache.files.set(`file::${s.compression}::${n}`,Buffer.concat([$e,B]))}}),S.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>{R.close(),S.close()})}else{try{R=W.createReadStream(n),t.waiting=!0,R.pipe(i)}catch(S){P=!0,u.error=S,r("error",u,t)}R.on("data",S=>{var B;if(e.data.outgoing.total+=S.byteLength,e.data.outgoing[t.previousHours[4]]+=S.byteLength,w){let z=(B=e.cache.files.get(`file::${s.compression}::${n}`))!=null?B:Buffer.from("");e.cache.files.set(`file::${s.compression}::${n}`,Buffer.concat([z,S]))}}),R.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>R.close())}return u}},M=!1;if(t.execute.dashboard||(M=await r("request",u,t)),!M){if(s.rateLimits.enabled){for(let n of s.rateLimits.list)if(t.url.pathname.startsWith(n.path)&&(i.setHeader("X-RateLimit-Limit",n.times),i.setHeader("X-RateLimit-Remaining",n.times-((re=await s.rateLimits.functions.get(f+n.path))!=null?re:0)),i.setHeader("X-RateLimit-Reset-Every",n.timeout),await s.rateLimits.functions.set(f+n.path,((se=await s.rateLimits.functions.get(f+n.path))!=null?se:0)+1),setTimeout(async()=>{var a;await s.rateLimits.functions.set(f+n.path,((a=await s.rateLimits.functions.get(f+n.path))!=null?a:0)-1)},n.timeout),await s.rateLimits.functions.get(f+n.path)>n.times))return i.statusCode=429,M=!0,u.print(s.rateLimits.message),N(u,t,s)}if(s.dashboard.enabled&&!t.execute.dashboard&&(e.requests.total++,e.requests[t.previousHours[4]]++),!await new Promise(n=>{if(!t.waiting)return n(!1);t.events.once("noWaiting",()=>n(!1)),t.events.once("endRequest",()=>n(!0))}))if(t.execute.exists&&!M){if(!t.execute.static)await Promise.resolve(t.execute.route.code(u)).catch(n=>{u.error=n,M=!0,r("error",u,t)});else if(t.execute.route.data.addTypes&&(t.execute.route.path.endsWith(".pdf")&&u.setHeader("Content-Type","application/pdf"),t.execute.route.path.endsWith(".js")&&u.setHeader("Content-Type","text/javascript"),t.execute.route.path.endsWith(".html")&&u.setHeader("Content-Type","text/html"),t.execute.route.path.endsWith(".css")&&u.setHeader("Content-Type","text/css"),t.execute.route.path.endsWith(".csv")&&u.setHeader("Content-Type","text/csv"),t.execute.route.path.endsWith(".mpeg")&&u.setHeader("Content-Type","video/mpeg"),t.execute.route.path.endsWith(".mp4")&&u.setHeader("Content-Type","video/mp4"),t.execute.route.path.endsWith(".webm")&&u.setHeader("Content-Type","video/webm"),t.execute.route.path.endsWith(".bmp")&&u.setHeader("Content-Type","image/bmp")),t.continue=!1,"content"in t.execute.route.data)e.data.outgoing.total+=t.execute.route.data.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.execute.route.data.content.byteLength,t.content=t.execute.route.data.content;else{let n=xe.resolve(t.execute.route.data.file),a,h=!1;if(s.compression&&String(u.headers.get("accept-encoding")).includes(A[s.compression])){u.rawRes.setHeader("Content-Encoding",A[s.compression]),u.rawRes.setHeader("Vary","Accept-Encoding");let p=V(s.compression);try{a=W.createReadStream(n),t.waiting=!0,a.pipe(p),p.pipe(i)}catch(w){h=!0,u.error=w,r("error",u,t)}if(h)return;p.on("data",w=>{e.data.outgoing.total+=w.byteLength,e.data.outgoing[t.previousHours[4]]+=w.byteLength}),p.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>{a.close(),p.close()})}else{try{a=W.createReadStream(n),t.waiting=!0,a.pipe(i)}catch(p){h=!0,u.error=p,r("error",u,t)}a.on("data",p=>{e.data.outgoing.total+=p.byteLength,e.data.outgoing[t.previousHours[4]]+=p.byteLength}),a.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>a.close())}}await new Promise(n=>{if(!t.waiting)return n(!0);t.events.once("noWaiting",()=>n(!1))}),t.content&&t.continue?(e.data.outgoing.total+=t.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.content.byteLength,N(u,t,s)):i.end()}else r("notfound",u,t),await new Promise(n=>{if(!t.waiting)return n(!0);t.events.once("noWaiting",()=>n(!1))}),t.content&&t.continue?(e.data.outgoing.total+=t.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.content.byteLength,N(u,t,s)):i.end()}}),s.body.enabled||t.events.emit("startRequest")});return e.controller=new F(e,b,s),e.controller}}});import*as ee from"fs";import*as O from"path";var ae="3.0.1";var te=Pe(Re()),d={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m",gray:"\x1B[90m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m",gray:"\x1B[100m",crimson:"\x1B[48m"}},Se=()=>!E[0]||E.includes("-h")||E.includes("--help"),C={dashboard:{}},E=process.argv.slice(2);if(E.includes("-v")||E.includes("--version"))console.log(`${d.fg.yellow}[RJW] ${d.reset}Version:`),console.log(`v${ae}`);else if(!Se()&&ee.existsSync(O.join(process.cwd(),E[0]))){let s=!1,e=!0,r="";for(let o of E.slice(1)){let[c,l]=o.slice(2).split("=");c==="port"&&(C.port=Number(l)),c==="bind"&&(C.bind=l),c==="remHTML"&&(s=Boolean(l)),c==="addTypes"&&(s=Boolean(l)),c==="compression"&&(C.compression=l),c==="cors"&&(C.cors=Boolean(l)),c==="proxy"&&(C.proxy=Boolean(l)),c==="dashboard"&&(C.dashboard.enabled=Boolean(l)),c==="404"&&(r=String(l).replaceAll('"',""))}C.routes=new te.default.routeList,C.routes.static("/",O.join(process.cwd(),E[0]),{remHTML:s,addTypes:e}),r&&C.routes.event("notfound",async o=>o.status(404).printFile(O.join(process.cwd(),r))),C.routes.event("request",async o=>{console.log(`${d.fg.yellow}[RJW] ${d.fg.gray}[${o.url.method}] ${d.fg.blue,d.underscore}${o.url.href}${d.reset} FROM ${o.client.ip}`)}),te.default.initialize(C).setRoutes(C.routes).start().then(o=>{console.log(`${d.fg.yellow}[RJW] ${d.reset}Server started on ${d.fg.yellow}${o.port}${d.reset}`)}).catch(o=>{var c;console.log(`${d.fg.yellow}[RJW] ${d.reset}Error:`),console.log(`${d.fg.yellow}[RJW] ${d.reset}Maybe port ${d.fg.yellow}${(c=C.port)!=null?c:2023}${d.reset} isnt available`),console.error(`${d.fg.red}[ERR]${d.reset}`,o.error)})}else!Se()&&!ee.existsSync(O.join(process.cwd(),E[0]))?(console.log(`${d.fg.yellow}[RJW] ${d.reset}Error:`),console.log(`Folder ${d.fg.red,d.underscore}${O.join(process.cwd(),E[0])}${d.reset} couldnt be found`)):(console.log(`${d.fg.yellow}[RJW] ${d.reset}Help:`),console.log(`rjw-srv ${d.fg.blue}[folder] ${d.fg.red}[arguments]`),console.log(""),console.log(`[arguments] ${d.reset}`),console.log(" --port=2023"),console.log(" --compress=false"),console.log(" --proxy=false"),console.log(" --cors=false"),console.log(" --bind=0.0.0.0"),console.log(" --remHTML=false"),console.log(" --addTypes=true"),console.log(" --dashboard=false"),console.log(' --404="static/404.html"'));
