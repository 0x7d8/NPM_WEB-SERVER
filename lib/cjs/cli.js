#!/usr/bin/env node
var Le=Object.create;var ne=Object.defineProperty;var Ae=Object.getOwnPropertyDescriptor;var We=Object.getOwnPropertyNames;var ke=Object.getPrototypeOf,je=Object.prototype.hasOwnProperty;var E=(s,e)=>()=>(s&&(e=s(s=0)),e);var Pe=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var Ie=(s,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let c of We(e))!je.call(s,c)&&c!==r&&ne(s,c,{get:()=>e[c],enumerable:!(o=Ae(e,c))||o.enumerable});return s};var w=(s,e,r)=>(r=s!=null?Le(ke(s)):{},Ie(e||!s||!s.__esModule?ne(r,"default",{value:s,enumerable:!0}):r,s));var G,K,ie,ue=E(()=>{G=w(require("fs")),K=(s,e)=>(e=e||[],G.readdirSync(s).forEach(o=>{if(G.statSync(`${s}/${o}`).isDirectory())e=K(`${s}/${o}`,e);else{let c=`${s}/${o}`;e.push(c)}}),e),ie=(s,e,r)=>(r=r||[],r=K(s,r).filter(o=>o.endsWith(e)),r)});var j,X=E(()=>{j=["OPTIONS","DELETE","PATCH","STATIC","HEAD","POST","PUT","GET"]});var ce,le,v,P,_=E(()=>{ue();X();ce=w(require("path")),le=w(require("fs")),v=(s,e)=>(s=s.replace(/\/{2,}/g,"/"),s.endsWith("/")&&s!=="/"?s.slice(0,-1):!s.startsWith("/")&&s!=="/"?`/${s}`:s.includes("/?")?s.replace("/?","?"):e&&s==="/"?"":s),P=class{constructor(e,r){e=e!=null?e:[],r=r!=null?r:[],this.routes=e,this.events=r}event(e,r){return this.events.some(o=>o.event===e)?!1:this.events.push({event:e,code:r})-1}set(e,r,o){if(r=v(r),!j.includes(e))throw TypeError(`No Valid Request Type: ${e}, Possible Values: ${j.join(", ")}`);return this.routes.some(c=>c.method===e&&c.path===r)?!1:this.routes.push({method:e,path:r,pathArray:r.split("/"),code:o,data:{addTypes:!1}})-1}setBlock(e,r){e=v(e);let o=[];for(let c=0;c<=r.length-1;c++){let l=r[c];o.push(this.routes.push({method:l.method,path:`${e}${v(l.path,!0)}`,pathArray:`${e}${v(l.path,!0)}`.split("/"),code:l.code,data:{addTypes:!1}})-1)}return o}setRedirects(e){let r=[];for(let o=0;o<=e.length-1;o++){let c=e[o];r.push(this.routes.push({method:c.method,path:v(c.path),pathArray:v(c.path,!0).split("/"),code:async l=>l.redirect(c.destination),data:{addTypes:!1}})-1)}return r}static(e,r,o){var m,i,t;e=v(e);let c=(m=o==null?void 0:o.preload)!=null?m:!1,l=(i=o==null?void 0:o.remHTML)!=null?i:!1,H=(t=o==null?void 0:o.addTypes)!=null?t:!0,b=[];for(let g of K(r)){let y=g.replace(r,"");l&&(y=y.replace("/index.html","/").replace(".html",""));let f=v(y),R=this.routes.push({method:"STATIC",path:f,pathArray:f.split("/"),code:async()=>{},data:{addTypes:H,file:g}});c&&(this.routes[R-1].data.content=le.readFileSync(g)),b.push(R-1)}return b}load(e){let r=ie(e,".js"),o=[];for(let c of r){let l=require(ce.resolve(c));if(!(!("path"in l)||!("method"in l)||!("code"in l))){if(!j.includes(l.method))throw TypeError(`No Valid Request Type: ${l.method}, Possible Values: ${j.join(", ")}`);o.push(this.routes.push({method:l.method,path:v(l.path),pathArray:v(l.path).split("/"),code:l.code,data:{addTypes:!1}})-1)}}return o}list(){return{routes:this.routes,events:this.events}}}});var A,Q=E(()=>{_();A=class{constructor(e){this.data=this.mergeOptions({routes:new P,rateLimits:{enabled:!1,message:"Rate Limited",list:[],functions:new Map},body:{enabled:!0,parse:!0,maxSize:5,message:"Payload too large"},https:{enabled:!1,keyFile:"/ssl/key/path",certFile:"/ssl/cert/path"},dashboard:{enabled:!1,path:"/rjweb-dashboard"},headers:{},bind:"0.0.0.0",proxy:!1,compression:"none",cors:!1,port:2023,poweredBy:!0},e)}mergeOptions(...e){let r=o=>o&&typeof o=="object";return e.reduce((o,c)=>(Object.keys(c).forEach(l=>{let H=o[l],b=c[l];l!=="functions"&&l!=="routes"?Array.isArray(H)&&Array.isArray(b)?o[l]=H.concat(...b):r(H)&&r(b)?o[l]=this.mergeOptions(H,b):o[l]=b:o[l]=b}),o),{})}getOptions(){return this.data}}});var T,me=E(()=>{T=class{constructor(e,r){this.data={};e=e!=null?e:{},r=r!=null?r:o=>o;for(let o in e)this.data[o]=r(e[o])}has(e){return e in this.data}get(e){return this.data[e]}set(e,r){let o=e in this.data;return this.data[e]=r,o}objectCount(){return Object.keys(this.data).length}clear(e){e=e!=null?e:[];let r=0;for(let o in this.data)e.includes(o)||(delete this.data[o],r++);return r}toJSON(e){e=e!=null?e:[];let r={};for(let o in this.data)e.includes(o)||(r[o]=this.data[o]);return r}toArray(e){e=e!=null?e:[];let r=[];for(let o in this.data)e.includes(o)||r.push(this.data[o]);return r}forEach(e,r){e=e!=null?e:()=>{},r=r!=null?r:[];let o=0;for(let c in this.data)r.includes(c)||(e(c,this.data[c]),o++);return o}}});var pe,de,fe=E(()=>{pe=(m=>(m.options="OPTIONS",m.delete="DELETE",m.patch="PATCH",m.post="POST",m.head="HEAD",m.put="PUT",m.get="GET",m.static="STATIC",m))(pe||{}),de=pe});function N(s){switch(s){case"gzip":return V.createGzip();case"brotli":return V.createBrotliCompress();case"deflate":return V.createDeflate();default:return new Y}}var he,V,W,Y,Z=E(()=>{he=require("stream"),V=w(require("zlib")),W={gzip:"gzip",brotli:"br",deflate:"deflate",none:"none"},Y=class extends he.PassThrough{}});function O(s,e,r){if(!e.compressed&&!s.rawRes.headersSent&&String(s.headers.get("accept-encoding")).includes(W[r.compression])){s.rawRes.setHeader("Content-Encoding",W[r.compression]),s.rawRes.setHeader("Vary","Accept-Encoding");let o=N(r.compression);o.pipe(s.rawRes),o.end(e.content,"binary")}else s.rawRes.end(e.content,"binary")}var ge=E(()=>{Z()});var U,be=E(()=>{Q();U=class{constructor(e,r,o){this.globalContext=e,this.optionsCache={},this.server=r,this.options=o,this.globalContext.controller=this}setRoutes(e){let{routes:r,events:o}=e.list();return this.optionsCache.normal=r,this.optionsCache.event=o,this}setOptions(e){return this.options=new A(e).getOptions(),this}start(){return this.globalContext.routes.normal=this.optionsCache.normal,this.globalContext.routes.event=this.optionsCache.event,this.server.listen(this.options.port,this.options.bind),new Promise((e,r)=>{this.server.once("listening",()=>e({success:!0,port:this.options.port,message:"WEBSERVER STARTED"})),this.server.once("error",o=>{this.server.close(),r({success:!1,error:o,message:"WEBSERVER ERRORED"})})})}async reload(){return this.globalContext.pageDisplay="",this.globalContext.cache.files.clear(),this.globalContext.cache.routes.clear(),this.globalContext.routes.normal=this.optionsCache.normal,this.globalContext.routes.event=this.optionsCache.event,this.globalContext.data={incoming:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},outgoing:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}},this.globalContext.requests={total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},await this.stop(),await this.start(),this}stop(){return this.server.close(),this.globalContext.pageDisplay="",this.globalContext.cache.files.clear(),this.globalContext.cache.routes.clear(),this.globalContext.routes.normal=this.optionsCache.normal,this.globalContext.routes.event=this.optionsCache.event,this.globalContext.data={incoming:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},outgoing:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}},this.globalContext.requests={total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},new Promise((e,r)=>{this.server.once("close",()=>e({success:!0,message:"WEBSERVER CLOSED"})),this.server.once("error",o=>{this.server.close(),r({success:!1,error:o,message:"WEBSERVER CLOSING ERRORED"})})})}}});async function ee(s,e,r,o,c){switch(s.url.path.replace(v(o.dashboard.path,!1),"")||"/"){case"/":let H=(await ye.readFile(`${__dirname}/stats/index.html`,"utf8")).replaceAll("/rjweb-dashboard",v(o.dashboard.path));return s.print(H);case"/stats":let b=new Date,m=b.getTime(),i=process.cpuUsage(),t=await new Promise(g=>setTimeout(()=>{let y=process.cpuUsage(i),R=(new Date().getTime()-m)*5*Ne;g((y.system+y.user)/R)},500));return s.print({requests:[e.requests.total,{hour:r.previousHours[0],amount:e.requests[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.requests[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.requests[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.requests[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.requests[r.previousHours[4]]}],data:{incoming:[e.data.incoming.total,{hour:r.previousHours[0],amount:e.data.incoming[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.data.incoming[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.data.incoming[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.data.incoming[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.data.incoming[r.previousHours[4]]}],outgoing:[e.data.outgoing.total,{hour:r.previousHours[0],amount:e.data.outgoing[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.data.outgoing[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.data.outgoing[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.data.outgoing[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.data.outgoing[r.previousHours[4]]}]},cpu:{time:`${b.getHours()}:${b.getMinutes()}:${b.getSeconds()}`,usage:t.toFixed(2)},memory:{time:`${b.getHours()}:${b.getMinutes()}:${b.getSeconds()}`,usage:(process.memoryUsage().heapUsed/1e3/1e3).toFixed(2)},routes:c,cached:e.cache.files.objectCount()+e.cache.routes.objectCount()})}}var ye,ve,Ne,we=E(()=>{_();ye=w(require("fs/promises")),ve=w(require("os")),Ne=ve.cpus().length});var $e=Pe((gt,Se)=>{_();Q();me();fe();Z();ge();be();var Ce=require("stream");we();X();var Oe=w(require("http")),Me=w(require("https")),xe=w(require("querystring")),Te=w(require("zlib")),He=w(require("path")),Re=w(require("url")),k=w(require("fs"));Se.exports={routeList:P,serverOptions:A,valueCollection:T,types:de,initialize(s){s=new A(s).getOptions();let e={controller:null,requests:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},pageDisplay:"",data:{incoming:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},outgoing:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}},routes:{normal:[],event:[]},cache:{files:new T,routes:new T}},r=async(m,i,t)=>{switch(m){case"error":{let g=e.routes.event.find(y=>y.event==="error");g?Promise.resolve(g.code(i)).catch(y=>{console.log(y),i.status(500),t.content=Buffer.from(`An Error occured in your Error Event (what the hell?)
${y.stack}`)}):(console.log(i.error),i.status(500),t.content=Buffer.from(`An Error occured
${i.error.stack}`))}case"request":{let g=!1,y=e.routes.event.find(f=>f.event==="request");return y&&await Promise.resolve(y.code(i)).catch(f=>{g=!0,console.log(f),i.status(500),t.content=Buffer.from(`An Error occured in your Request Event
${f.stack}`)}),g}case"notfound":{let g=!1,y=e.routes.event.find(f=>f.event==="notfound");if(y)await Promise.resolve(y.code(i)).catch(f=>{g=!0,console.log(f),i.status(500),t.content=Buffer.from(`An Error occured in your Notfound Event
${f.stack}`)});else{let f="";if(e.pageDisplay)f=e.pageDisplay;else{for(let R of e.routes.normal){let u=R.method==="STATIC"?"GET":R.method;f+=`[-] [${u}] ${R.path}
`}e.pageDisplay=f}i.status(404),t.content=Buffer.from(`[!] COULDNT FIND [${i.url.method}]: ${i.url.pathname.toUpperCase()}
[i] AVAILABLE PAGES:

${f}`)}return g}}},o=()=>Array.from({length:5},(m,i)=>(new Date().getHours()-(4-i)+24)%24);setInterval(()=>{let m=o();e.requests[m[0]-1]=0,e.data.incoming[m[0]-1]=0,e.data.outgoing[m[0]-1]=0},3e5);let c={},l,H;if(s.https.enabled){try{l=k.readFileSync(s.https.keyFile),H=k.readFileSync(s.https.certFile)}catch(m){throw new Error(`Cant access your HTTPS Key or Cert file! (${s.https.keyFile} / ${s.https.certFile})`)}c={key:l,cert:H}}let b=(s.https.enabled?Me:Oe).createServer(c,async(m,i)=>{let t={content:Buffer.from(""),compressed:!1,events:new Ce.EventEmitter,waiting:!1,continue:!0,execute:{route:null,static:!1,exists:!1,dashboard:!1},body:{raw:Buffer.from(""),parsed:""},url:{...Re.parse(v(m.url)),method:m.method},previousHours:o()};t.events.on("noWaiting",()=>t.waiting=!1),i.once("close",()=>t.events.emit("endRequest")),s.body.enabled&&m.on("data",g=>{if(t.body.raw=Buffer.concat([t.body.raw,Buffer.from(g)]),t.body.raw.byteLength>=s.body.maxSize*1e6){switch(i.statusCode=413,t.continue=!1,typeof s.body.message){case"object":i.setHeader("Content-Type","application/json"),t.content=Buffer.from(JSON.stringify(s.body.message));break;case"string":t.content=Buffer.from(s.body.message);break;case"symbol":t.content=Buffer.from(s.body.message.toString());break;case"bigint":case"number":case"boolean":t.content=Buffer.from(String(s.body.message));break;case"undefined":t.content=Buffer.from("");break}return O({headers:new T(m.headers,decodeURIComponent),rawRes:i},t,s)}else e.data.incoming.total+=t.body.raw.byteLength,e.data.incoming[t.previousHours[4]]+=t.body.raw.byteLength}).on("end",()=>{t.continue&&t.events.emit("startRequest")}),t.events.once("startRequest",async()=>{var se,oe;if(Object.keys(s.headers).forEach(n=>{i.setHeader(n,s.headers[n])}),s.cors&&(i.setHeader("Access-Control-Allow-Headers","*"),i.setHeader("Access-Control-Allow-Origin","*"),i.setHeader("Access-Control-Request-Method","*"),i.setHeader("Access-Control-Allow-Methods",j.join(",")),m.method==="OPTIONS"))return i.end("");let g={},y=t.url.pathname.split("/");for(let n=0;n<=e.routes.normal.length-1;n++){let a=e.routes.normal[n];if(e.cache.routes.has(`route::${t.url.pathname}`)){let h=e.cache.routes.get(`route::${t.url.pathname}`);g=h.params,t.execute.route=h.route,t.execute.static=h.route.method==="STATIC",t.execute.exists=!0;break}if(s.dashboard.enabled&&(t.url.pathname===v(s.dashboard.path)||t.url.pathname===v(s.dashboard.path)+"/stats")){t.execute.route={method:"GET",path:a.path,pathArray:a.path.split("/"),code:async h=>await ee(h,e,t,s,e.routes.normal.length),data:{addTypes:!1}},t.execute.static=!1,t.execute.exists=!0,t.execute.dashboard=!0;break}if(!(a.method!=="STATIC"&&a.method!==m.method)&&!(a.method==="STATIC"&&m.method!=="GET")&&a.pathArray.length===y.length){if(t.execute.exists)break;if(a.path===t.url.pathname&&a.method===m.method){t.execute.route=a,t.execute.exists=!0,e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:{}});break}if(a.path===t.url.pathname&&a.method==="STATIC"){t.execute.route=a,t.execute.static=!0,t.execute.exists=!0,e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:{}});break}for(let h=0;h<=a.pathArray.length-1;h++){let p=a.pathArray[h],C=y[h];if(!/^:.*:$/.test(p)&&C!==p)break;if(p===C)continue;if(/^:.*:$/.test(p)){g[p.substring(1,p.length-1)]=C,t.execute.route=a,t.execute.exists=!0;continue}}if(t.execute.exists){e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:g});break}}}s.poweredBy&&i.setHeader("X-Powered-By","rjweb-server");let f;s.proxy&&m.headers["x-forwarded-for"]?f=m.headers["x-forwarded-for"]:f=m.socket.remoteAddress;let R={};if(m.headers.cookie&&m.headers.cookie.split(";").forEach(n=>{let a=n.split("=");R[a.shift().trim()]=a.join("=")}),m.headers["content-encoding"]==="gzip"&&(t.body.raw=await new Promise(n=>Te.gunzip(t.body.raw,(a,h)=>{n(a?t.body.raw:h)}))),s.body.parse)try{JSON.parse(t.body.raw.toString())}catch(n){t.body.parsed=t.body.raw.toString()}else t.body.parsed=t.body.raw.toString();let u={controller:e.controller,headers:new T(m.headers,decodeURIComponent),cookies:new T(R,decodeURIComponent),params:new T(g,decodeURIComponent),queries:new T(xe.parse(t.url.query),decodeURIComponent),client:{userAgent:m.headers["user-agent"],httpVersion:m.httpVersion,port:m.socket.remotePort,ip:f},body:t.body.parsed,url:t.url,rawServer:b,rawReq:m,rawRes:i,"@":{},setHeader(n,a){return i.setHeader(n,a),u},setCustom(n,a){return u["@"][n]=a,u},redirect(n,a){return i.statusCode=a!=null?a:302,i.setHeader("Location",n),u},print(n,a){var S,I,F;let h=(S=a==null?void 0:a.niceJSON)!=null?S:!1,p=(I=a==null?void 0:a.contentType)!=null?I:"",C=(F=a==null?void 0:a.returnFunctions)!=null?F:!1;switch(typeof n){case"object":i.setHeader("Content-Type","application/json"),h?t.content=Buffer.from(JSON.stringify(n,void 0,1)):t.content=Buffer.from(JSON.stringify(n));break;case"string":p&&i.setHeader("Content-Type",p),t.content=Buffer.from(n);break;case"symbol":p&&i.setHeader("Content-Type",p),t.content=Buffer.from(n.toString());break;case"bigint":case"number":case"boolean":p&&i.setHeader("Content-Type",p),t.content=Buffer.from(String(n));break;case"function":t.waiting=!0,(async()=>{let D=await n();if(typeof D!="function")u.print(D,{niceJSON:h,contentType:p});else if(C)u.print(D,{niceJSON:h,contentType:p,returnFunctions:C});else return u.error=new Error("Cant return functions from functions, consider using async/await"),r("error",u,t);let z=t.content;t.content=z,t.events.emit("noWaiting")})();break;case"undefined":p&&i.setHeader("Content-Type",p),t.content=Buffer.from("");break}return u},status(n){return i.statusCode=n!=null?n:200,u},printFile(n,a){var F,D,z;let h=(F=a==null?void 0:a.addTypes)!=null?F:!0,p=(D=a==null?void 0:a.contentType)!=null?D:"",C=(z=a==null?void 0:a.cache)!=null?z:!1;h&&!p?(n.endsWith(".pdf")&&u.setHeader("Content-Type","application/pdf"),n.endsWith(".js")&&u.setHeader("Content-Type","text/javascript"),n.endsWith(".html")&&u.setHeader("Content-Type","text/html"),n.endsWith(".css")&&u.setHeader("Content-Type","text/css"),n.endsWith(".csv")&&u.setHeader("Content-Type","text/csv"),n.endsWith(".mpeg")&&u.setHeader("Content-Type","video/mpeg"),n.endsWith(".mp4")&&u.setHeader("Content-Type","video/mp4"),n.endsWith(".webm")&&u.setHeader("Content-Type","video/webm"),n.endsWith(".bmp")&&u.setHeader("Content-Type","image/bmp")):p&&i.setHeader("Content-Type",p);let S,I=!1;if(u.headers.get("accept-encoding").includes(W[s.compression])){if(u.rawRes.setHeader("Content-Encoding",W[s.compression]),u.rawRes.setHeader("Vary","Accept-Encoding"),t.continue=!1,e.cache.files.has(`file::${n}`))return e.data.outgoing.total+=e.cache.files.get(`file::${n}`).byteLength,e.data.outgoing[t.previousHours[4]]+=e.cache.files.get(`file::${n}`).byteLength,t.content=e.cache.files.get(`file::${n}`),t.continue=!0,u;if(e.cache.files.has(`file::${s.compression}::${n}`))return t.compressed=!0,e.data.outgoing.total+=e.cache.files.get(`file::${s.compression}::${n}`).byteLength,e.data.outgoing[t.previousHours[4]]+=e.cache.files.get(`file::${s.compression}::${n}`).byteLength,t.content=e.cache.files.get(`file::${s.compression}::${n}`),t.continue=!0,u;let $=N(s.compression);try{S=k.createReadStream(n),t.waiting=!0,S.pipe($),$.pipe(i)}catch(L){I=!0,u.error=L,r("error",u,t)}if(I)return;$.on("data",L=>{var J;if(e.data.outgoing.total+=L.byteLength,e.data.outgoing[t.previousHours[4]]+=L.byteLength,C){let Be=(J=e.cache.files.get(`file::${s.compression}::${n}`))!=null?J:Buffer.from("");e.cache.files.set(`file::${s.compression}::${n}`,Buffer.concat([Be,L]))}}),$.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>{S.close(),$.close()})}else{try{S=k.createReadStream(n),t.waiting=!0,S.pipe(i)}catch($){I=!0,u.error=$,r("error",u,t)}S.on("data",$=>{var L;if(e.data.outgoing.total+=$.byteLength,e.data.outgoing[t.previousHours[4]]+=$.byteLength,C){let J=(L=e.cache.files.get(`file::${s.compression}::${n}`))!=null?L:Buffer.from("");e.cache.files.set(`file::${s.compression}::${n}`,Buffer.concat([J,$]))}}),S.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>S.close())}return u}},q=!1;if(t.execute.dashboard||(q=await r("request",u,t)),!q){if(s.rateLimits.enabled){for(let n of s.rateLimits.list)if(t.url.pathname.startsWith(n.path)&&(i.setHeader("X-RateLimit-Limit",n.times),i.setHeader("X-RateLimit-Remaining",n.times-((se=await s.rateLimits.functions.get(f+n.path))!=null?se:0)),i.setHeader("X-RateLimit-Reset-Every",n.timeout),await s.rateLimits.functions.set(f+n.path,((oe=await s.rateLimits.functions.get(f+n.path))!=null?oe:0)+1),setTimeout(async()=>{var a;await s.rateLimits.functions.set(f+n.path,((a=await s.rateLimits.functions.get(f+n.path))!=null?a:0)-1)},n.timeout),await s.rateLimits.functions.get(f+n.path)>n.times))return i.statusCode=429,q=!0,u.print(s.rateLimits.message),O(u,t,s)}if(s.dashboard.enabled&&!t.execute.dashboard&&(e.requests.total++,e.requests[t.previousHours[4]]++),!await new Promise(n=>{if(!t.waiting)return n(!1);t.events.once("noWaiting",()=>n(!1)),t.events.once("endRequest",()=>n(!0))}))if(t.execute.exists&&!q){if(!t.execute.static)await Promise.resolve(t.execute.route.code(u)).catch(n=>{u.error=n,q=!0,r("error",u,t)});else if(t.execute.route.data.addTypes&&(t.execute.route.path.endsWith(".pdf")&&u.setHeader("Content-Type","application/pdf"),t.execute.route.path.endsWith(".js")&&u.setHeader("Content-Type","text/javascript"),t.execute.route.path.endsWith(".html")&&u.setHeader("Content-Type","text/html"),t.execute.route.path.endsWith(".css")&&u.setHeader("Content-Type","text/css"),t.execute.route.path.endsWith(".csv")&&u.setHeader("Content-Type","text/csv"),t.execute.route.path.endsWith(".mpeg")&&u.setHeader("Content-Type","video/mpeg"),t.execute.route.path.endsWith(".mp4")&&u.setHeader("Content-Type","video/mp4"),t.execute.route.path.endsWith(".webm")&&u.setHeader("Content-Type","video/webm"),t.execute.route.path.endsWith(".bmp")&&u.setHeader("Content-Type","image/bmp")),t.continue=!1,"content"in t.execute.route.data)e.data.outgoing.total+=t.execute.route.data.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.execute.route.data.content.byteLength,t.content=t.execute.route.data.content;else{let n=He.resolve(t.execute.route.data.file),a,h=!1;if(s.compression&&String(u.headers.get("accept-encoding")).includes(W[s.compression])){u.rawRes.setHeader("Content-Encoding",W[s.compression]),u.rawRes.setHeader("Vary","Accept-Encoding");let p=N(s.compression);try{a=k.createReadStream(n),t.waiting=!0,a.pipe(p),p.pipe(i)}catch(C){h=!0,u.error=C,r("error",u,t)}if(h)return;p.on("data",C=>{e.data.outgoing.total+=C.byteLength,e.data.outgoing[t.previousHours[4]]+=C.byteLength}),p.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>{a.close(),p.close()})}else{try{a=k.createReadStream(n),t.waiting=!0,a.pipe(i)}catch(p){h=!0,u.error=p,r("error",u,t)}a.on("data",p=>{e.data.outgoing.total+=p.byteLength,e.data.outgoing[t.previousHours[4]]+=p.byteLength}),a.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>a.close())}}await new Promise(n=>{if(!t.waiting)return n(!0);t.events.once("noWaiting",()=>n(!1))}),t.content&&t.continue?(e.data.outgoing.total+=t.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.content.byteLength,O(u,t,s)):i.end()}else r("notfound",u,t),await new Promise(n=>{if(!t.waiting)return n(!0);t.events.once("noWaiting",()=>n(!1))}),t.content&&t.continue?(e.data.outgoing.total+=t.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.content.byteLength,O(u,t,s)):i.end()}}),s.body.enabled||t.events.emit("startRequest")});return e.controller=new U(e,b,s),e.controller}}});var te=w(require("fs")),M=w(require("path"));var ae="3.0.1";var re=w($e()),d={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m",gray:"\x1B[90m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m",gray:"\x1B[100m",crimson:"\x1B[48m"}},Ee=()=>!B[0]||B.includes("-h")||B.includes("--help"),x={dashboard:{}},B=process.argv.slice(2);if(B.includes("-v")||B.includes("--version"))console.log(`${d.fg.yellow}[RJW] ${d.reset}Version:`),console.log(`v${ae}`);else if(!Ee()&&te.existsSync(M.join(process.cwd(),B[0]))){let s=!1,e=!0,r="";for(let o of B.slice(1)){let[c,l]=o.slice(2).split("=");c==="port"&&(x.port=Number(l)),c==="bind"&&(x.bind=l),c==="remHTML"&&(s=Boolean(l)),c==="addTypes"&&(s=Boolean(l)),c==="compression"&&(x.compression=l),c==="cors"&&(x.cors=Boolean(l)),c==="proxy"&&(x.proxy=Boolean(l)),c==="dashboard"&&(x.dashboard.enabled=Boolean(l)),c==="404"&&(r=String(l).replaceAll('"',""))}x.routes=new re.default.routeList,x.routes.static("/",M.join(process.cwd(),B[0]),{remHTML:s,addTypes:e}),r&&x.routes.event("notfound",async o=>o.status(404).printFile(M.join(process.cwd(),r))),x.routes.event("request",async o=>{console.log(`${d.fg.yellow}[RJW] ${d.fg.gray}[${o.url.method}] ${d.fg.blue,d.underscore}${o.url.href}${d.reset} FROM ${o.client.ip}`)}),re.default.initialize(x).setRoutes(x.routes).start().then(o=>{console.log(`${d.fg.yellow}[RJW] ${d.reset}Server started on ${d.fg.yellow}${o.port}${d.reset}`)}).catch(o=>{var c;console.log(`${d.fg.yellow}[RJW] ${d.reset}Error:`),console.log(`${d.fg.yellow}[RJW] ${d.reset}Maybe port ${d.fg.yellow}${(c=x.port)!=null?c:2023}${d.reset} isnt available`),console.error(`${d.fg.red}[ERR]${d.reset}`,o.error)})}else!Ee()&&!te.existsSync(M.join(process.cwd(),B[0]))?(console.log(`${d.fg.yellow}[RJW] ${d.reset}Error:`),console.log(`Folder ${d.fg.red,d.underscore}${M.join(process.cwd(),B[0])}${d.reset} couldnt be found`)):(console.log(`${d.fg.yellow}[RJW] ${d.reset}Help:`),console.log(`rjw-srv ${d.fg.blue}[folder] ${d.fg.red}[arguments]`),console.log(""),console.log(`[arguments] ${d.reset}`),console.log(" --port=2023"),console.log(" --compress=false"),console.log(" --proxy=false"),console.log(" --cors=false"),console.log(" --bind=0.0.0.0"),console.log(" --remHTML=false"),console.log(" --addTypes=true"),console.log(" --dashboard=false"),console.log(' --404="static/404.html"'));
