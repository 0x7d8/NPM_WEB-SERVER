var se=Object.create;var F=Object.defineProperty;var oe=Object.getOwnPropertyDescriptor;var ie=Object.getOwnPropertyNames;var ue=Object.getPrototypeOf,ce=Object.prototype.hasOwnProperty;var de=(r,t)=>()=>(t||r((t={exports:{}}).exports,t),t.exports);var fe=(r,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of ie(t))!ce.call(r,s)&&s!==o&&F(r,s,{get:()=>t[s],enumerable:!(n=oe(t,s))||n.enumerable});return r};var x=(r,t,o)=>(o=r!=null?se(ue(r)):{},fe(t||!r||!r.__esModule?F(o,"default",{value:r,enumerable:!0}):o,r));var V=de((ge,M)=>{M.exports=["OPTIONS","DELETE","PATCH","STATIC","POST","PUT","GET"]});var P=x(require("fs")),I=(r,t)=>(t=t||[],P.readdirSync(r).forEach(n=>{if(P.statSync(r+"/"+n).isDirectory())t=I(r+"/"+n,t);else{let s=r+"/"+n;t.push(s)}}),t),K=(r,t,o)=>(o=o||[],o=I(r,o).filter(n=>n.endsWith(t)),o);var O=x(V()),G=x(require("path")),J=x(require("fs")),v=r=>(r=r.replace(/\/{2,}/g,"/"),r.endsWith("/")&&r!=="/"?r.slice(0,-1):!r.startsWith("/")&&r!=="/"?`/${r}`:r),A=class{constructor(t,o){t=t!=null?t:[],o=o!=null?o:[],this.routes=t,this.events=o}event(t,o){return this.events.some(n=>n.event===t)?!1:this.events.push({event:t,code:o})-1}set(t,o,n){if(o=v(o),!O.default.includes(t))throw TypeError(`No Valid Request Type: ${t}
Possible Values: ${O.default.join(", ")}`);return this.routes.some(s=>s.method===t&&s.path===o)?!1:this.routes.push({method:t,path:o,pathArray:o.split("/"),code:n,data:{addTypes:!1}})-1}static(t,o,n){var C,l,i;t=v(t);let s=(C=n==null?void 0:n.preload)!=null?C:!1,f=(l=n==null?void 0:n.remHTML)!=null?l:!1,b=(i=n==null?void 0:n.addTypes)!=null?i:!0,p=[];for(let e of I(o)){let y=e.replace(o,"");f&&(y=y.replace("/index.html","/").replace(".html",""));let w=v(y),m=this.routes.push({method:"STATIC",path:w,pathArray:w.split("/"),code:async()=>{},data:{addTypes:b,file:e}});s&&(this.routes[m-1].data.content=J.readFileSync(e)),p.push(m-1)}return p}load(t){let o=K(t,".js"),n=[];for(let s of o){let f=require(G.resolve(s));if(!(!("path"in f)||!("method"in f)||!("code"in f))){if(!O.default.includes(f.method))throw TypeError(`No Valid Request Type: ${f.method}
Possible Values: ${O.default.join(", ")}`);n.push(this.routes.push({method:f.method,path:v(f.path),pathArray:v(f.path).split("/"),code:f.code,data:{addTypes:!1}})-1)}}return n}list(){return{routes:this.routes,events:this.events}}};var H=class{constructor(t){this.data=this.mergeOptions({routes:new A,rateLimits:{enabled:!1,message:"Rate Limited",list:[],functions:new Map},body:{enabled:!0,maxSize:5,message:"Payload too large"},https:{enabled:!1,keyFile:"/ssl/key/path",certFile:"/ssl/cert/path"},dashboard:{enabled:!1,path:"/rjweb-dashboard"},bind:"0.0.0.0",proxy:!1,cors:!1,port:2023,poweredBy:!0},t)}mergeOptions(...t){let o=n=>n&&typeof n=="object";return t.reduce((n,s)=>(Object.keys(s).forEach(f=>{let b=n[f],p=s[f];f!=="functions"&&f!=="routes"?Array.isArray(b)&&Array.isArray(p)?n[f]=b.concat(...p):o(b)&&o(p)?n[f]=this.mergeOptions(b,p):n[f]=p:n[f]=p}),n),{})}getOptions(){return this.data}};var S=class{constructor(t,o){this.data={};t=t!=null?t:{},o=o!=null?o:n=>n;for(let n in t)this.data[n]=o(t[n])}has(t){return t in this.data}get(t){return this.data[t]}set(t,o){let n=t in this.data;return this.data[t]=o,n}objectCount(){return Object.keys(this.data).length}toJSON(t){t=t!=null?t:[];let o={};for(let n in this.data)t.includes(n)||(o[n]=this.data[n]);return o}toArray(t){t=t!=null?t:[];let o=[];for(let n in this.data)t.includes(n)||o.push(this.data[n]);return o}forEach(t,o){t=t!=null?t:()=>{},o=o!=null?o:[];let n=0;for(let s in this.data)o.includes(s)||(t(s,this.data[s]),n++);return n}};var X=(p=>(p.options="OPTIONS",p.delete="DELETE",p.patch="PATCH",p.post="POST",p.put="PUT",p.get="GET",p.static="STATIC",p))(X||{}),z=X;var _=require("stream"),Q=x(V()),me=x(require("http")),le=x(require("https")),Y=x(require("querystring")),Z=x(require("path")),ee=x(require("url")),L=x(require("fs")),te=x(require("os"));module.exports={routeList:A,serverOptions:H,valueCollection:S,types:z,async start(r){r=new H(r).getOptions();let{routes:t,events:o}=r.routes.list(),n=new S,s={requests:{total:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0},pageDisplay:"",data:{incoming:{total:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0},outgoing:{total:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0}}},f=async(l,i,e)=>{switch(l){case"error":{let y=o.find(w=>w.event==="error");y?Promise.resolve(y.code(i)).catch(w=>{console.log(w),i.status(500),e.content=Buffer.from(`An Error occured in your Error Event (what the hell?)
${w.stack}`)}):(console.log(i.error),i.status(500),e.content=Buffer.from(`An Error occured
${i.error.stack}`))}case"request":{let y=!1,w=o.find(m=>m.event==="request");return w&&await Promise.resolve(w.code(i)).catch(m=>{y=!0,console.log(m),i.status(500),e.content=Buffer.from(`An Error occured in your Request Event
${m.stack}`)}),y}case"notfound":{let y=!1,w=o.find(m=>m.event==="notfound");if(w)await Promise.resolve(w.code(i)).catch(m=>{y=!0,console.log(m),i.status(500),e.content=Buffer.from(`An Error occured in your Notfound Event
${m.stack}`)});else{let m="";if(s.pageDisplay)m=s.pageDisplay;else{for(let R of t){let W=R.method==="STATIC"?"GET":R.method;m+=`[-] [${W}] ${R.path}
`}s.pageDisplay=m}i.status(404),e.content=Buffer.from(`[!] COULDNT FIND [${i.url.method}]: ${i.url.pathname.toUpperCase()}
[i] AVAILABLE PAGES:

${m}`)}return y}}},b=()=>Array.from({length:5},(l,i)=>(new Date().getHours()-(4-i)+24)%24),p={};r.https.enabled?p={key:await L.promises.readFile(r.https.keyFile).catch(()=>{throw new Error(`Cant access your HTTPS Key file! (${r.https.keyFile})`)}),cert:await L.promises.readFile(r.https.certFile).catch(()=>{throw new Error(`Cant access your HTTPS Cert file! (${r.https.certFile})`)})}:p={};let C=(r.https.enabled?le:me).createServer(p,async(l,i)=>{let e={content:Buffer.from(""),events:new _.EventEmitter,waiting:!1,continue:!0,execute:{route:null,static:!1,exists:!1,dashboard:!1},url:{...ee.parse(v(l.url)),method:l.method},body:Buffer.from("")};e.events.on("noWaiting",()=>e.waiting=!1),i.once("close",()=>e.events.emit("endRequest")),r.body.enabled&&l.on("data",y=>{if(e.body=Buffer.concat([e.body,Buffer.from(y)]),e.body.byteLength>=r.body.maxSize*1e6){switch(i.statusCode=413,e.continue=!1,typeof r.body.message){case"object":i.setHeader("Content-Type","application/json"),e.content=Buffer.from(JSON.stringify(r.body.message));break;case"string":e.content=Buffer.from(r.body.message);break;case"symbol":e.content=Buffer.from(r.body.message.toString());break;case"bigint":case"number":case"boolean":e.content=Buffer.from(String(r.body.message));break;case"undefined":e.content=Buffer.from("");break}return i.end(e.content,"binary")}else s.data.incoming.total+=e.body.byteLength,s.data.incoming[b()[4]]+=e.body.byteLength}).on("end",()=>{e.continue&&e.events.emit("startRequest")}),e.events.once("startRequest",async()=>{var D,N,q;if(r.cors&&(i.setHeader("Access-Control-Allow-Headers","*"),i.setHeader("Access-Control-Allow-Origin","*"),i.setHeader("Access-Control-Request-Method","*"),i.setHeader("Access-Control-Allow-Methods",Q.default.join(",")),l.method==="OPTIONS"))return i.end("");let y={},w=e.url.pathname.split("/");for(let a=0;a<=t.length-1;a++){let u=t[a];if(n.has(`route::${e.url.pathname}`)){let g=n.get(`route::${e.url.pathname}`);e.execute.route=g,e.execute.static=g.method==="STATIC",e.execute.exists=!0;break}if(r.dashboard.enabled&&(e.url.pathname===v(r.dashboard.path)||e.url.pathname===v(r.dashboard.path)+"/stats")){e.execute.route={method:"GET",path:u.path,pathArray:u.path.split("/"),code:async g=>{if(g.url.path.endsWith("/stats")){let h=new Date,T=h.getTime(),B=process.cpuUsage(),d=b(),$=await new Promise(E=>setTimeout(()=>{let j=process.cpuUsage(B),re=(new Date().getTime()-T)*5*te.cpus().length,{user:ne,system:ae}=j;E((ae+ne)/re)},500));return g.print({requests:[s.requests.total,{hour:d[0],amount:s.requests[d[0]]},{hour:d[1],amount:s.requests[d[1]]},{hour:d[2],amount:s.requests[d[2]]},{hour:d[3],amount:s.requests[d[3]]},{hour:d[4],amount:s.requests[d[4]]}],data:{incoming:[s.data.incoming.total,{hour:d[0],amount:s.data.incoming[d[0]]},{hour:d[1],amount:s.data.incoming[d[1]]},{hour:d[2],amount:s.data.incoming[d[2]]},{hour:d[3],amount:s.data.incoming[d[3]]},{hour:d[4],amount:s.data.incoming[d[4]]}],outgoing:[s.data.outgoing.total,{hour:d[0],amount:s.data.outgoing[d[0]]},{hour:d[1],amount:s.data.outgoing[d[1]]},{hour:d[2],amount:s.data.outgoing[d[2]]},{hour:d[3],amount:s.data.outgoing[d[3]]},{hour:d[4],amount:s.data.outgoing[d[4]]}]},cpu:{time:`${h.getHours()}:${h.getMinutes()}:${h.getSeconds()}`,usage:$.toFixed(2)},memory:{time:`${h.getHours()}:${h.getMinutes()}:${h.getSeconds()}`,usage:(process.memoryUsage().heapUsed/1e3/1e3).toFixed(2)},routes:t.length,cached:n.objectCount()})}else{let h=(await L.promises.readFile(__dirname+"/stats/index.html","utf8")).replaceAll("/rjweb-dashboard",v(r.dashboard.path));return g.print(h)}},data:{addTypes:!1}},e.execute.static=!1,e.execute.exists=!0,e.execute.dashboard=!0;break}if(!(u.method!=="STATIC"&&u.method!==l.method)&&!(u.method==="STATIC"&&l.method!=="GET")&&u.pathArray.length===w.length){if(e.execute.exists)break;if(u.path===e.url.pathname&&u.method===l.method){e.execute.route=u,e.execute.exists=!0,n.set(`route::${e.url.pathname}`,u);break}if(u.path===e.url.pathname&&u.method==="STATIC"){e.execute.route=u,e.execute.static=!0,e.execute.exists=!0,n.set(`route::${e.url.pathname}`,u);break}for(let g=0;g<=u.pathArray.length-1;g++){let h=u.pathArray[g],T=w[g];if(!h.startsWith(":")&&T!==h)break;if(h===T)continue;if(h.startsWith(":")){y[h.substring(1)]=T,e.execute.route=u,e.execute.exists=!0;continue}}if(e.execute.exists)break}}r.poweredBy&&i.setHeader("X-Powered-By","rjweb-server");let m;r.proxy&&l.headers["x-forwarded-for"]?m=l.headers["x-forwarded-for"]:m=l.socket.remoteAddress;let R={};l.headers.cookie&&l.headers.cookie.split(";").forEach(a=>{let u=a.split("=");R[u.shift().trim()]=u.join("=")});let W="";try{W=JSON.parse(e.body.toString())}catch(a){W=(D=e.body.toString())!=null?D:""}let c={headers:new S(l.headers,decodeURIComponent),cookies:new S(R,decodeURIComponent),params:new S(y,decodeURIComponent),queries:new S(Y.parse(e.url.query),decodeURIComponent),client:{userAgent:l.headers["user-agent"],httpVersion:l.httpVersion,port:l.socket.remotePort,ip:m},body:W,url:e.url,rawServer:C,rawReq:l,rawRes:i,"@":{},setHeader(a,u){return i.setHeader(a,u),c},setCustom(a,u){return c["@"][a]=u,c},print(a,u){var h;let g=(h=u==null?void 0:u.niceJSON)!=null?h:!1;switch(typeof a){case"object":i.setHeader("Content-Type","application/json"),g?e.content=Buffer.from(JSON.stringify(a,void 0,1)):e.content=Buffer.from(JSON.stringify(a));break;case"string":e.content=Buffer.from(a);break;case"symbol":e.content=Buffer.from(a.toString());break;case"bigint":case"number":case"boolean":e.content=Buffer.from(String(a));break;case"function":e.waiting=!0,(async()=>{let T=await a();if(typeof T!="function")c.print(T,{niceJSON:g});else return c.error=new Error("Cant return functions from functions, consider using async/await"),f("error",c,e);let B=e.content;e.content=B,e.events.emit("noWaiting")})();break;case"undefined":e.content=Buffer.from("");break}return c},status(a){return i.statusCode=a,c},printFile(a,u){var d,$;let g=(d=u==null?void 0:u.addTypes)!=null?d:!0,h=($=u==null?void 0:u.cache)!=null?$:!1;if(g&&(a.endsWith(".pdf")&&c.setHeader("Content-Type","application/pdf"),a.endsWith(".js")&&c.setHeader("Content-Type","text/javascript"),a.endsWith(".html")&&c.setHeader("Content-Type","text/html"),a.endsWith(".css")&&c.setHeader("Content-Type","text/css"),a.endsWith(".csv")&&c.setHeader("Content-Type","text/csv"),a.endsWith(".mpeg")&&c.setHeader("Content-Type","video/mpeg"),a.endsWith(".mp4")&&c.setHeader("Content-Type","video/mp4"),a.endsWith(".webm")&&c.setHeader("Content-Type","video/webm"),a.endsWith(".bmp")&&c.setHeader("Content-Type","image/bmp")),n.has(`file::${a}`))return s.data.outgoing.total+=n.get(`file::${a}`).byteLength,s.data.outgoing[b()[4]]+=n.get(`file::${a}`).byteLength,e.content=n.get(`file::${a}`),c;let T,B=!1;try{T=L.createReadStream(a),e.waiting=!0,T.pipe(i)}catch(E){B=!0,c.error=E,f("error",c,e)}return B||(T.on("data",E=>{var U;s.data.outgoing.total+=E.byteLength,s.data.outgoing[b()[4]]+=E.byteLength;let j=(U=n.get(`file::${a}`))!=null?U:Buffer.from("");h&&n.set(`file::${a}`,Buffer.concat([j,E]))}),T.once("end",()=>{e.events.emit("noWaiting"),e.content=Buffer.from("")}),i.once("close",()=>T.close())),c}},k=!1;if(e.execute.dashboard||(k=await f("request",c,e)),!k){if(r.rateLimits.enabled){for(let a of r.rateLimits.list)if(e.url.pathname.startsWith(a.path)&&(i.setHeader("X-RateLimit-Limit",a.times),i.setHeader("X-RateLimit-Remaining",a.times-((N=await r.rateLimits.functions.get(m+a.path))!=null?N:0)),i.setHeader("X-RateLimit-Reset-Every",a.timeout),await r.rateLimits.functions.set(m+a.path,((q=await r.rateLimits.functions.get(m+a.path))!=null?q:0)+1),setTimeout(async()=>{var u;await r.rateLimits.functions.set(m+a.path,((u=await r.rateLimits.functions.get(m+a.path))!=null?u:0)-1)},a.timeout),await r.rateLimits.functions.get(m+a.path)>a.times))return i.statusCode=429,k=!0,c.print(r.rateLimits.message),i.end(e.content,"binary")}if(r.dashboard.enabled&&!e.execute.dashboard&&(s.requests.total++,s.requests[b()[4]]++),!await new Promise(a=>{if(!e.waiting)return a(!1);e.events.once("noWaiting",()=>a(!1)),e.events.once("endRequest",()=>a(!0))}))if(e.execute.exists&&!k){if(!e.execute.static)await Promise.resolve(e.execute.route.code(c)).catch(a=>{c.error=a,k=!0,f("error",c,e)});else if(e.execute.route.data.addTypes&&(e.execute.route.path.endsWith(".pdf")&&c.setHeader("Content-Type","application/pdf"),e.execute.route.path.endsWith(".js")&&c.setHeader("Content-Type","text/javascript"),e.execute.route.path.endsWith(".html")&&c.setHeader("Content-Type","text/html"),e.execute.route.path.endsWith(".css")&&c.setHeader("Content-Type","text/css"),e.execute.route.path.endsWith(".csv")&&c.setHeader("Content-Type","text/csv"),e.execute.route.path.endsWith(".mpeg")&&c.setHeader("Content-Type","video/mpeg"),e.execute.route.path.endsWith(".mp4")&&c.setHeader("Content-Type","video/mp4"),e.execute.route.path.endsWith(".webm")&&c.setHeader("Content-Type","video/webm"),e.execute.route.path.endsWith(".bmp")&&c.setHeader("Content-Type","image/bmp")),"content"in e.execute.route.data)s.data.outgoing.total+=e.execute.route.data.content.byteLength,s.data.outgoing[b()[4]]+=e.execute.route.data.content.byteLength,e.content=e.execute.route.data.content;else{let a=Z.resolve(e.execute.route.data.file),u,g=!1;try{u=L.createReadStream(a),e.waiting=!0,u.pipe(i)}catch(h){g=!0,c.error=h,f("error",c,e)}if(g)return c;u.on("data",h=>{s.data.outgoing.total+=h.byteLength,s.data.outgoing[b()[4]]+=h.byteLength}),u.once("end",()=>e.events.emit("noWaiting")),i.once("close",()=>u.close())}await new Promise(a=>{if(!e.waiting)return a(!0);e.events.once("noWaiting",()=>a(!1))}),e.content?(s.data.outgoing.total+=e.content.byteLength,s.data.outgoing[b()[4]]+=e.content.byteLength,i.end(e.content,"binary")):i.end()}else f("notfound",c,e),await new Promise(a=>{if(!e.waiting)return a(!0);e.events.once("noWaiting",()=>a(!1))}),e.content?(s.data.outgoing.total+=e.content.byteLength,s.data.outgoing[b()[4]]+=e.content.byteLength,i.end(e.content,"binary")):i.end()}}),r.body.enabled||e.events.emit("startRequest")});return C.listen(r.port,r.bind),new Promise((l,i)=>{C.once("listening",()=>l({success:!0,port:r.port,message:"WEBSERVER STARTED",rawServer:C})),C.once("error",e=>{C.close(),i({success:!1,error:e,message:"WEBSERVER ERRORED"})})})}};
