var ne=Object.create;var j=Object.defineProperty;var se=Object.getOwnPropertyDescriptor;var oe=Object.getOwnPropertyNames;var ae=Object.getPrototypeOf,ie=Object.prototype.hasOwnProperty;var ue=(n,t)=>()=>(t||n((t={exports:{}}).exports,t),t.exports);var ce=(n,t,s,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of oe(t))!ie.call(n,i)&&i!==s&&j(n,i,{get:()=>t[i],enumerable:!(o=se(t,i))||o.enumerable});return n};var w=(n,t,s)=>(s=n!=null?ne(ae(n)):{},ce(t||!n||!n.__esModule?j(s,"default",{value:n,enumerable:!0}):s,n));var k=ue((fe,K)=>{K.exports=["OPTIONS","DELETE","PATCH","STATIC","POST","PUT","GET"]});var I=w(require("fs")),D=(n,t)=>(t=t||[],I.readdirSync(n).forEach(o=>{if(I.statSync(n+"/"+o).isDirectory())t=D(n+"/"+o,t);else{let i=n+"/"+o;t.push(i)}}),t),q=(n,t,s)=>(s=s||[],s=D(n,s).filter(o=>o.endsWith(t)),s);var L=w(k()),M=w(require("path")),G=w(require("fs")),T=n=>(n=n.replace(/\/{2,}/g,"/"),n.endsWith("/")&&n!=="/"?n.slice(0,-1):!n.startsWith("/")&&n!=="/"?`/${n}`:n),x=class{constructor(t,s){t=t!=null?t:[],s=s!=null?s:[],this.routes=t,this.events=s}event(t,s){return this.events.some(o=>o.event===t)?!1:this.events.push({event:t,code:s})-1}set(t,s,o){if(s=T(s),!L.default.includes(t))throw TypeError(`No Valid Request Type: ${t}
Possible Values: ${L.default.join(", ")}`);return this.routes.some(i=>i.method===t&&i.path===s)?!1:this.routes.push({method:t,path:s,pathArray:s.split("/"),code:o,data:{addTypes:!1}})-1}static(t,s,o){var u,e,g;t=T(t);let i=(u=o==null?void 0:o.preload)!=null?u:!1,f=(e=o==null?void 0:o.remHTML)!=null?e:!1,b=(g=o==null?void 0:o.addTypes)!=null?g:!0,m=[];for(let l of D(s)){let h=l.replace(s,"");f&&(h=h.replace("/index.html","/").replace(".html",""));let H=T(h),v=this.routes.push({method:"STATIC",path:H,pathArray:H.split("/"),code:async()=>{},data:{addTypes:b,file:l}});i&&(this.routes[v-1].data.content=G.readFileSync(l)),m.push(v-1)}return m}load(t){let s=q(t,".js"),o=[];for(let i of s){let f=require(M.resolve(i));if(!(!("path"in f)||!("method"in f)||!("code"in f))){if(!L.default.includes(f.method))throw TypeError(`No Valid Request Type: ${f.method}
Possible Values: ${L.default.join(", ")}`);o.push(this.routes.push({method:f.method,path:T(f.path),pathArray:T(f.path).split("/"),code:f.code,data:{addTypes:!1}})-1)}}return o}list(){return{routes:this.routes,events:this.events}}};var A=class{constructor(t){this.data=this.mergeOptions({routes:new x,rateLimits:{enabled:!1,message:"Rate Limited",list:[],functions:new Map},body:{enabled:!0,maxSize:5},dashboard:{enabled:!1,path:"/rjweb-dashboard"},bind:"0.0.0.0",proxy:!1,cors:!1,port:2023,poweredBy:!0},t)}mergeOptions(...t){let s=o=>o&&typeof o=="object";return t.reduce((o,i)=>(Object.keys(i).forEach(f=>{let b=o[f],m=i[f];f!=="functions"&&f!=="routes"?Array.isArray(b)&&Array.isArray(m)?o[f]=b.concat(...m):s(b)&&s(m)?o[f]=this.mergeOptions(b,m):o[f]=m:o[f]=m}),o),{})}getOptions(){return this.data}};var S=class{constructor(t,s){this.data={};t=t!=null?t:{},s=s!=null?s:o=>o;for(let o in t)this.data[o]=s(t[o])}has(t){return t in this.data}get(t){return this.data[t]}set(t,s){let o=t in this.data;return this.data[t]=s,o}toJSON(t){t=t!=null?t:[];let s={};for(let o in this.data)t.includes(o)||(s[o]=this.data[o]);return s}toArray(t){t=t!=null?t:[];let s=[];for(let o in this.data)t.includes(o)||s.push(this.data[o]);return s}forEach(t,s){t=t!=null?t:()=>{},s=s!=null?s:[];let o=0;for(let i in this.data)s.includes(i)||(t(i,this.data[i]),o++);return o}};var J=(m=>(m.options="OPTIONS",m.delete="DELETE",m.patch="PATCH",m.post="POST",m.put="PUT",m.get="GET",m.static="STATIC",m))(J||{}),X=J;var z=require("stream"),F=w(k()),_=w(require("querystring")),Q=w(require("path")),Y=w(require("http")),Z=w(require("url")),W=w(require("fs")),ee=w(require("os"));module.exports={routeList:x,serverOptions:A,valueCollection:S,types:X,async start(n){n=new A(n).getOptions();let{routes:t,events:s}=n.routes.list(),o=new Map,i={requests:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0},data:{incoming:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0},outgoing:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0}}},f=async(m,u,e)=>{switch(m){case"error":{let g=s.find(l=>l.event==="error");g?Promise.resolve(g.code(u)).catch(l=>{console.log(l),u.status(500),e.content=Buffer.from(`An Error occured in your Error Event (what the hell?)
${l.stack}`)}):(console.log(u.error),u.status(500),e.content=Buffer.from(`An Error occured
${u.error.stack}`))}case"request":{let g=!1,l=s.find(h=>h.event==="request");return l&&await Promise.resolve(l.code(u)).catch(h=>{g=!0,console.log(h),u.status(500),e.content=Buffer.from(`An Error occured in your Request Event
${h.stack}`)}),g}case"notfound":{let g=!1,l=s.find(h=>h.event==="notfound");if(l)await Promise.resolve(l.code(u)).catch(h=>{g=!0,console.log(h),u.status(500),e.content=Buffer.from(`An Error occured in your Notfound Event
${h.stack}`)});else{let h="";for(let H of t){let v=H.method==="STATIC"?"GET":H.method;h+=`[-] [${v}] ${H.path}
`}u.status(404),e.content=Buffer.from(`[!] COULDNT FIND [${u.url.method}]: ${u.url.pathname.toUpperCase()}
[i] AVAILABLE PAGES:

${h}`)}return g}}},b=Y.createServer(async(m,u)=>{let e={content:Buffer.from(""),events:new z.EventEmitter,waiting:!1,execute:{route:null,static:!1,exists:!1,dashboard:!1},url:{...Z.parse(T(m.url)),method:m.method},body:Buffer.from("")};e.events.on("noWaiting",()=>e.waiting=!1),u.once("close",()=>e.events.emit("endRequest")),n.body.enabled&&m.on("data",g=>{e.body=Buffer.concat([e.body,Buffer.from(g)]),e.body.byteLength>=n.body.maxSize*1e6?(u.statusCode=413,u.end("Payload Too Large")):i.data.incoming[new Date().getHours()]+=e.body.byteLength}).on("end",()=>e.events.emit("startRequest")),e.events.once("startRequest",async()=>{var U,V,$;if(n.cors&&(u.setHeader("Access-Control-Allow-Headers","*"),u.setHeader("Access-Control-Allow-Origin","*"),u.setHeader("Access-Control-Request-Method","*"),u.setHeader("Access-Control-Allow-Methods",F.default.join(",")),m.method==="OPTIONS"))return u.end("");let g={},l=e.url.pathname.split("/");for(let r=0;r<=t.length-1;r++){let c=t[r];if(n.dashboard.enabled&&(e.url.pathname===T(n.dashboard.path)||e.url.pathname===T(n.dashboard.path)+"/stats")){e.execute.route={method:"GET",path:c.path,pathArray:c.path.split("/"),code:async p=>{if(p.url.path.endsWith("/stats")){let a=new Date,y=new Date().getTime(),E=process.cpuUsage();i.requests[String((a.getHours()-5+24)%24)]=0;let B=await new Promise(O=>setTimeout(()=>{let C=process.cpuUsage(E),P=(new Date().getTime()-y)*5*ee.cpus().length,{user:te,system:re}=C;O((re+te)/P)},500));return p.print({requests:[{hour:a.getHours()-0,amount:i.requests[String((a.getHours()-0+24)%24)]},{hour:a.getHours()-1,amount:i.requests[String((a.getHours()-1+24)%24)]},{hour:a.getHours()-2,amount:i.requests[String((a.getHours()-2+24)%24)]},{hour:a.getHours()-3,amount:i.requests[String((a.getHours()-3+24)%24)]},{hour:a.getHours()-4,amount:i.requests[String((a.getHours()-4+24)%24)]}].reverse(),data:{incoming:[{hour:a.getHours()-0,amount:i.data.incoming[String((a.getHours()-0+24)%24)]},{hour:a.getHours()-1,amount:i.data.incoming[String((a.getHours()-1+24)%24)]},{hour:a.getHours()-2,amount:i.data.incoming[String((a.getHours()-2+24)%24)]},{hour:a.getHours()-3,amount:i.data.incoming[String((a.getHours()-3+24)%24)]},{hour:a.getHours()-4,amount:i.data.incoming[String((a.getHours()-4+24)%24)]}].reverse(),outgoing:[{hour:a.getHours()-0,amount:i.data.outgoing[String((a.getHours()-0+24)%24)]},{hour:a.getHours()-1,amount:i.data.outgoing[String((a.getHours()-1+24)%24)]},{hour:a.getHours()-2,amount:i.data.outgoing[String((a.getHours()-2+24)%24)]},{hour:a.getHours()-3,amount:i.data.outgoing[String((a.getHours()-3+24)%24)]},{hour:a.getHours()-4,amount:i.data.outgoing[String((a.getHours()-4+24)%24)]}].reverse()},cpu:{time:`${a.getHours()}:${a.getMinutes()}:${a.getSeconds()}`,usage:B.toFixed(2)},memory:{time:`${a.getHours()}:${a.getMinutes()}:${a.getSeconds()}`,usage:(process.memoryUsage().heapUsed/1e3/1e3).toFixed(2)},routes:t.length})}else{let a=(await W.promises.readFile(__dirname+"/stats/index.html","utf8")).replaceAll("/rjweb-dashboard",T(n.dashboard.path));return p.print(a)}},data:{addTypes:!1}},e.execute.static=!1,e.execute.exists=!0,e.execute.dashboard=!0;break}if(!(c.method!=="STATIC"&&c.method!==m.method)&&!(c.method==="STATIC"&&m.method!=="GET")&&c.pathArray.length===l.length){if(e.execute.exists)break;if(c.path===e.url.pathname&&c.method===m.method){e.execute.route=c,e.execute.exists=!0;break}if(c.path===e.url.pathname&&c.method==="STATIC"){e.execute.route=c,e.execute.static=!0,e.execute.exists=!0;break}for(let p=0;p<=c.pathArray.length-1;p++){let a=c.pathArray[p],y=l[p];if(!a.startsWith(":")&&y!==a)break;if(a===y)continue;if(a.startsWith(":")){g[a.substring(1)]=y,e.execute.route=c,e.execute.exists=!0;continue}}}}n.poweredBy&&u.setHeader("X-Powered-By","rjweb-server");let h;n.proxy&&m.headers["x-forwarded-for"]?h=m.headers["x-forwarded-for"]:h=m.socket.remoteAddress;let H={};m.headers.cookie&&m.headers.cookie.split(";").forEach(r=>{let c=r.split("=");H[c.shift().trim()]=c.join("=")});let v="";try{v=JSON.parse(e.body.toString())}catch(r){v=e.body.toString()||""}let d={headers:new S(m.headers,decodeURIComponent),cookies:new S(H,decodeURIComponent),params:new S(g,decodeURIComponent),queries:new S(_.parse(e.url.query),decodeURIComponent),client:{userAgent:m.headers["user-agent"],httpVersion:m.httpVersion,port:m.socket.remotePort,ip:h},body:v,url:e.url,rawServer:b,rawReq:m,rawRes:u,"@":{},setHeader(r,c){return u.setHeader(r,c),d},setCustom(r,c){return d["@"][r]=c,d},print(r,c){var a;let p=(a=c==null?void 0:c.niceJSON)!=null?a:!1;switch(typeof r){case"object":u.setHeader("Content-Type","application/json"),p?e.content=Buffer.from(JSON.stringify(r,void 0,1)):e.content=Buffer.from(JSON.stringify(r));break;case"string":e.content=Buffer.from(r);break;case"symbol":e.content=Buffer.from(r.toString());break;case"bigint":case"number":case"boolean":e.content=Buffer.from(String(r));break;case"function":e.waiting=!0,(async()=>{let y=await r();if(typeof y!="function")d.print(y,{niceJSON:p});else return d.error=new Error("Cant return functions from functions, consider using async/await"),f("error",d,e);let E=e.content;e.content=E,e.events.emit("noWaiting")})();break;case"undefined":e.content=Buffer.from("");break}return d},status(r){return u.statusCode=r,d},printFile(r,c){var B,O;let p=(B=c==null?void 0:c.addTypes)!=null?B:!0,a=(O=c==null?void 0:c.cache)!=null?O:!1;if(p&&(r.endsWith(".pdf")&&d.setHeader("Content-Type","application/pdf"),r.endsWith(".js")&&d.setHeader("Content-Type","text/javascript"),r.endsWith(".html")&&d.setHeader("Content-Type","text/html"),r.endsWith(".css")&&d.setHeader("Content-Type","text/css"),r.endsWith(".csv")&&d.setHeader("Content-Type","text/csv"),r.endsWith(".mpeg")&&d.setHeader("Content-Type","video/mpeg"),r.endsWith(".mp4")&&d.setHeader("Content-Type","video/mp4"),r.endsWith(".webm")&&d.setHeader("Content-Type","video/webm"),r.endsWith(".bmp")&&d.setHeader("Content-Type","image/bmp")),o.has(r))return i.data.outgoing[new Date().getHours()]+=o.get(r).byteLength,e.content=o.get(r),d;let y,E=!1;try{y=W.createReadStream(r),e.waiting=!0,y.pipe(u)}catch(C){E=!0,d.error=C,f("error",d,e)}return E||(y.on("data",C=>{var P;i.data.outgoing[new Date().getHours()]+=C.byteLength;let N=(P=o.get(r))!=null?P:Buffer.from("");a&&o.set(r,Buffer.concat([N,C]))}),y.once("end",()=>{e.events.emit("noWaiting"),e.content=null}),u.once("close",()=>y.close())),d}},R=!1;if(e.execute.dashboard||(R=await f("request",d,e)),!R){if(n.rateLimits.enabled){for(let r of n.rateLimits.list)if(e.url.pathname.startsWith(r.path)&&(u.setHeader("X-RateLimit-Limit",r.times),u.setHeader("X-RateLimit-Remaining",r.times-((U=await n.rateLimits.functions.get(h+r.path))!=null?U:0)),u.setHeader("X-RateLimit-Reset-Every",r.timeout),await n.rateLimits.functions.set(h+r.path,((V=await n.rateLimits.functions.get(h+r.path))!=null?V:0)+1),setTimeout(async()=>{var c;await n.rateLimits.functions.set(h+r.path,((c=await n.rateLimits.functions.get(h+r.path))!=null?c:0)-1)},r.timeout),await n.rateLimits.functions.get(h+r.path)>r.times))return u.statusCode=429,R=!0,d.print(($=n.rateLimits.message)!=null?$:"Rate Limited"),u.end()}if(n.dashboard.enabled&&!e.execute.dashboard&&i.requests[new Date().getHours()]++,!await new Promise(r=>{if(!e.waiting)return r(!1);e.events.once("noWaiting",()=>r(!1)),e.events.once("endRequest",()=>r(!0))}))if(e.execute.exists&&!R){if(!e.execute.static)await Promise.resolve(e.execute.route.code(d)).catch(r=>{d.error=r,R=!0,f("error",d,e)});else if(e.execute.route.data.addTypes&&(e.execute.route.path.endsWith(".pdf")&&d.setHeader("Content-Type","application/pdf"),e.execute.route.path.endsWith(".js")&&d.setHeader("Content-Type","text/javascript"),e.execute.route.path.endsWith(".html")&&d.setHeader("Content-Type","text/html"),e.execute.route.path.endsWith(".css")&&d.setHeader("Content-Type","text/css"),e.execute.route.path.endsWith(".csv")&&d.setHeader("Content-Type","text/csv"),e.execute.route.path.endsWith(".mpeg")&&d.setHeader("Content-Type","video/mpeg"),e.execute.route.path.endsWith(".mp4")&&d.setHeader("Content-Type","video/mp4"),e.execute.route.path.endsWith(".webm")&&d.setHeader("Content-Type","video/webm"),e.execute.route.path.endsWith(".bmp")&&d.setHeader("Content-Type","image/bmp")),"content"in e.execute.route.data)i.data.outgoing[new Date().getHours()]+=e.execute.route.data.content.byteLength,e.content=e.execute.route.data.content;else{let r=Q.resolve(e.execute.route.data.file),c,p=!1;try{c=W.createReadStream(r),e.waiting=!0,c.pipe(u)}catch(a){p=!0,d.error=a,f("error",d,e)}if(p)return d;c.on("data",a=>{i.data.outgoing[new Date().getHours()]+=a.byteLength}),c.once("end",()=>e.events.emit("noWaiting")),u.once("close",()=>c.close())}await new Promise(r=>{if(!e.waiting)return r(!0);e.events.once("noWaiting",()=>r(!1))}),e.content?(i.data.outgoing[new Date().getHours()]+=e.content.byteLength,u.end(e.content,"binary")):u.end()}else f("notfound",d,e),await new Promise(r=>{if(!e.waiting)return r(!0);e.events.once("noWaiting",()=>r(!1))}),e.content?(i.data.outgoing[new Date().getHours()]+=e.content.byteLength,u.end(e.content,"binary")):u.end()}}),n.body.enabled||e.events.emit("startRequest")});return b.listen(n.port,n.bind),new Promise((m,u)=>{b.once("listening",()=>m({success:!0,port:n.port,message:"WEBSERVER STARTED",rawServer:b})),b.once("error",e=>{b.close(),u({success:!1,error:e,message:"WEBSERVER ERRORED"})})})}};
