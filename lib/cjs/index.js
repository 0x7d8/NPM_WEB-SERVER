var ae=Object.create;var F=Object.defineProperty;var se=Object.getOwnPropertyDescriptor;var oe=Object.getOwnPropertyNames;var ie=Object.getPrototypeOf,ue=Object.prototype.hasOwnProperty;var ce=(r,t)=>()=>(t||r((t={exports:{}}).exports,t),t.exports);var de=(r,t,a,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of oe(t))!ue.call(r,o)&&o!==a&&F(r,o,{get:()=>t[o],enumerable:!(s=se(t,o))||s.enumerable});return r};var w=(r,t,a)=>(a=r!=null?ae(ie(r)):{},de(t||!r||!r.__esModule?F(a,"default",{value:r,enumerable:!0}):a,r));var $=ce((ge,M)=>{M.exports=["OPTIONS","DELETE","PATCH","STATIC","POST","PUT","GET"]});var k=w(require("fs")),I=(r,t)=>(t=t||[],k.readdirSync(r).forEach(s=>{if(k.statSync(r+"/"+s).isDirectory())t=I(r+"/"+s,t);else{let o=r+"/"+s;t.push(o)}}),t),K=(r,t,a)=>(a=a||[],a=I(r,a).filter(s=>s.endsWith(t)),a);var B=w($()),G=w(require("path")),J=w(require("fs")),H=r=>(r=r.replace(/\/{2,}/g,"/"),r.endsWith("/")&&r!=="/"?r.slice(0,-1):!r.startsWith("/")&&r!=="/"?`/${r}`:r),x=class{constructor(t,a){t=t!=null?t:[],a=a!=null?a:[],this.routes=t,this.events=a}event(t,a){return this.events.some(s=>s.event===t)?!1:this.events.push({event:t,code:a})-1}set(t,a,s){if(a=H(a),!B.default.includes(t))throw TypeError(`No Valid Request Type: ${t}
Possible Values: ${B.default.join(", ")}`);return this.routes.some(o=>o.method===t&&o.path===a)?!1:this.routes.push({method:t,path:a,pathArray:a.split("/"),code:s,data:{addTypes:!1}})-1}static(t,a,s){var h,u,e;t=H(t);let o=(h=s==null?void 0:s.preload)!=null?h:!1,m=(u=s==null?void 0:s.remHTML)!=null?u:!1,T=(e=s==null?void 0:s.addTypes)!=null?e:!0,l=[];for(let g of I(a)){let p=g.replace(a,"");m&&(p=p.replace("/index.html","/").replace(".html",""));let f=H(p),v=this.routes.push({method:"STATIC",path:f,pathArray:f.split("/"),code:async()=>{},data:{addTypes:T,file:g}});o&&(this.routes[v-1].data.content=J.readFileSync(g)),l.push(v-1)}return l}load(t){let a=K(t,".js"),s=[];for(let o of a){let m=require(G.resolve(o));if(!(!("path"in m)||!("method"in m)||!("code"in m))){if(!B.default.includes(m.method))throw TypeError(`No Valid Request Type: ${m.method}
Possible Values: ${B.default.join(", ")}`);s.push(this.routes.push({method:m.method,path:H(m.path),pathArray:H(m.path).split("/"),code:m.code,data:{addTypes:!1}})-1)}}return s}list(){return{routes:this.routes,events:this.events}}};var A=class{constructor(t){this.data=this.mergeOptions({routes:new x,rateLimits:{enabled:!1,message:"Rate Limited",list:[],functions:new Map},body:{enabled:!0,maxSize:5},https:{enabled:!1,keyFile:"/ssl/key/path",certFile:"/ssl/cert/path"},dashboard:{enabled:!1,path:"/rjweb-dashboard"},bind:"0.0.0.0",proxy:!1,cors:!1,port:2023,poweredBy:!0},t)}mergeOptions(...t){let a=s=>s&&typeof s=="object";return t.reduce((s,o)=>(Object.keys(o).forEach(m=>{let T=s[m],l=o[m];m!=="functions"&&m!=="routes"?Array.isArray(T)&&Array.isArray(l)?s[m]=T.concat(...l):a(T)&&a(l)?s[m]=this.mergeOptions(T,l):s[m]=l:s[m]=l}),s),{})}getOptions(){return this.data}};var S=class{constructor(t,a){this.data={};t=t!=null?t:{},a=a!=null?a:s=>s;for(let s in t)this.data[s]=a(t[s])}has(t){return t in this.data}get(t){return this.data[t]}set(t,a){let s=t in this.data;return this.data[t]=a,s}toJSON(t){t=t!=null?t:[];let a={};for(let s in this.data)t.includes(s)||(a[s]=this.data[s]);return a}toArray(t){t=t!=null?t:[];let a=[];for(let s in this.data)t.includes(s)||a.push(this.data[s]);return a}forEach(t,a){t=t!=null?t:()=>{},a=a!=null?a:[];let s=0;for(let o in this.data)a.includes(o)||(t(o,this.data[o]),s++);return s}};var X=(l=>(l.options="OPTIONS",l.delete="DELETE",l.patch="PATCH",l.post="POST",l.put="PUT",l.get="GET",l.static="STATIC",l))(X||{}),z=X;var _=require("stream"),Q=w($()),me=w(require("http")),fe=w(require("https")),Y=w(require("querystring")),Z=w(require("path")),ee=w(require("url")),C=w(require("fs")),te=w(require("os"));module.exports={routeList:x,serverOptions:A,valueCollection:S,types:z,async start(r){r=new A(r).getOptions();let{routes:t,events:a}=r.routes.list(),s=new S,o={requests:{total:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0},pageDisplay:"",data:{incoming:{total:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0},outgoing:{total:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0}}},m=async(h,u,e)=>{switch(h){case"error":{let g=a.find(p=>p.event==="error");g?Promise.resolve(g.code(u)).catch(p=>{console.log(p),u.status(500),e.content=Buffer.from(`An Error occured in your Error Event (what the hell?)
${p.stack}`)}):(console.log(u.error),u.status(500),e.content=Buffer.from(`An Error occured
${u.error.stack}`))}case"request":{let g=!1,p=a.find(f=>f.event==="request");return p&&await Promise.resolve(p.code(u)).catch(f=>{g=!0,console.log(f),u.status(500),e.content=Buffer.from(`An Error occured in your Request Event
${f.stack}`)}),g}case"notfound":{let g=!1,p=a.find(f=>f.event==="notfound");if(p)await Promise.resolve(p.code(u)).catch(f=>{g=!0,console.log(f),u.status(500),e.content=Buffer.from(`An Error occured in your Notfound Event
${f.stack}`)});else{let f="";if(o.pageDisplay)f=o.pageDisplay;else{for(let v of t){let R=v.method==="STATIC"?"GET":v.method;f+=`[-] [${R}] ${v.path}
`}o.pageDisplay=f}u.status(404),e.content=Buffer.from(`[!] COULDNT FIND [${u.url.method}]: ${u.url.pathname.toUpperCase()}
[i] AVAILABLE PAGES:

${f}`)}return g}}},T={};r.https.enabled?T={key:await C.promises.readFile(r.https.keyFile).catch(()=>{throw new Error(`Cant access your HTTPS Key file! (${r.https.keyFile})`)}),cert:await C.promises.readFile(r.https.certFile).catch(()=>{throw new Error(`Cant access your HTTPS Cert file! (${r.https.certFile})`)})}:T={};let l=(r.https.enabled?fe:me).createServer(T,async(h,u)=>{let e={content:Buffer.from(""),events:new _.EventEmitter,waiting:!1,execute:{route:null,static:!1,exists:!1,dashboard:!1},url:{...ee.parse(H(h.url)),method:h.method},body:Buffer.from("")};e.events.on("noWaiting",()=>e.waiting=!1),u.once("close",()=>e.events.emit("endRequest")),r.body.enabled&&h.on("data",g=>{e.body=Buffer.concat([e.body,Buffer.from(g)]),e.body.byteLength>=r.body.maxSize*1e6?(u.statusCode=413,u.end("Payload Too Large")):(o.data.incoming.total+=e.body.byteLength,o.data.incoming[new Date().getHours()]+=e.body.byteLength)}).on("end",()=>e.events.emit("startRequest")),e.events.once("startRequest",async()=>{var U,V,N,q;if(r.cors&&(u.setHeader("Access-Control-Allow-Headers","*"),u.setHeader("Access-Control-Allow-Origin","*"),u.setHeader("Access-Control-Request-Method","*"),u.setHeader("Access-Control-Allow-Methods",Q.default.join(",")),h.method==="OPTIONS"))return u.end("");let g={},p=e.url.pathname.split("/");for(let n=0;n<=t.length-1;n++){let c=t[n];if(r.dashboard.enabled&&(e.url.pathname===H(r.dashboard.path)||e.url.pathname===H(r.dashboard.path)+"/stats")){e.execute.route={method:"GET",path:c.path,pathArray:c.path.split("/"),code:async y=>{if(y.url.path.endsWith("/stats")){let i=new Date,b=new Date().getTime(),E=process.cpuUsage(),O=await new Promise(D=>setTimeout(()=>{let L=process.cpuUsage(E),P=(new Date().getTime()-b)*5*te.cpus().length,{user:re,system:ne}=L;D((ne+re)/P)},500));return y.print({requests:[o.requests.total,{hour:i.getHours()-4,amount:o.requests[String((i.getHours()-4+24)%24)]},{hour:i.getHours()-3,amount:o.requests[String((i.getHours()-3+24)%24)]},{hour:i.getHours()-2,amount:o.requests[String((i.getHours()-2+24)%24)]},{hour:i.getHours()-1,amount:o.requests[String((i.getHours()-1+24)%24)]},{hour:i.getHours()-0,amount:o.requests[String((i.getHours()-0+24)%24)]}],data:{incoming:[o.data.incoming.total,{hour:i.getHours()-4,amount:o.data.incoming[String((i.getHours()-4+24)%24)]},{hour:i.getHours()-3,amount:o.data.incoming[String((i.getHours()-3+24)%24)]},{hour:i.getHours()-2,amount:o.data.incoming[String((i.getHours()-2+24)%24)]},{hour:i.getHours()-1,amount:o.data.incoming[String((i.getHours()-1+24)%24)]},{hour:i.getHours()-0,amount:o.data.incoming[String((i.getHours()-0+24)%24)]}],outgoing:[o.data.outgoing.total,{hour:i.getHours()-4,amount:o.data.outgoing[String((i.getHours()-4+24)%24)]},{hour:i.getHours()-3,amount:o.data.outgoing[String((i.getHours()-3+24)%24)]},{hour:i.getHours()-2,amount:o.data.outgoing[String((i.getHours()-2+24)%24)]},{hour:i.getHours()-1,amount:o.data.outgoing[String((i.getHours()-1+24)%24)]},{hour:i.getHours()-0,amount:o.data.outgoing[String((i.getHours()-0+24)%24)]}]},cpu:{time:`${i.getHours()}:${i.getMinutes()}:${i.getSeconds()}`,usage:O.toFixed(2)},memory:{time:`${i.getHours()}:${i.getMinutes()}:${i.getSeconds()}`,usage:(process.memoryUsage().heapUsed/1e3/1e3).toFixed(2)},routes:t.length})}else{let i=(await C.promises.readFile(__dirname+"/stats/index.html","utf8")).replaceAll("/rjweb-dashboard",H(r.dashboard.path));return y.print(i)}},data:{addTypes:!1}},e.execute.static=!1,e.execute.exists=!0,e.execute.dashboard=!0;break}if(!(c.method!=="STATIC"&&c.method!==h.method)&&!(c.method==="STATIC"&&h.method!=="GET")&&c.pathArray.length===p.length){if(e.execute.exists)break;if(c.path===e.url.pathname&&c.method===h.method){e.execute.route=c,e.execute.exists=!0;break}if(c.path===e.url.pathname&&c.method==="STATIC"){e.execute.route=c,e.execute.static=!0,e.execute.exists=!0;break}for(let y=0;y<=c.pathArray.length-1;y++){let i=c.pathArray[y],b=p[y];if(!i.startsWith(":")&&b!==i)break;if(i===b)continue;if(i.startsWith(":")){g[i.substring(1)]=b,e.execute.route=c,e.execute.exists=!0;continue}}}}r.poweredBy&&u.setHeader("X-Powered-By","rjweb-server");let f;r.proxy&&h.headers["x-forwarded-for"]?f=h.headers["x-forwarded-for"]:f=h.socket.remoteAddress;let v={};h.headers.cookie&&h.headers.cookie.split(";").forEach(n=>{let c=n.split("=");v[c.shift().trim()]=c.join("=")});let R="";try{R=JSON.parse(e.body.toString())}catch(n){R=(U=e.body.toString())!=null?U:""}let d={headers:new S(h.headers,decodeURIComponent),cookies:new S(v,decodeURIComponent),params:new S(g,decodeURIComponent),queries:new S(Y.parse(e.url.query),decodeURIComponent),client:{userAgent:h.headers["user-agent"],httpVersion:h.httpVersion,port:h.socket.remotePort,ip:f},body:R,url:e.url,rawServer:l,rawReq:h,rawRes:u,"@":{},setHeader(n,c){return u.setHeader(n,c),d},setCustom(n,c){return d["@"][n]=c,d},print(n,c){var i;let y=(i=c==null?void 0:c.niceJSON)!=null?i:!1;switch(typeof n){case"object":u.setHeader("Content-Type","application/json"),y?e.content=Buffer.from(JSON.stringify(n,void 0,1)):e.content=Buffer.from(JSON.stringify(n));break;case"string":e.content=Buffer.from(n);break;case"symbol":e.content=Buffer.from(n.toString());break;case"bigint":case"number":case"boolean":e.content=Buffer.from(String(n));break;case"function":e.waiting=!0,(async()=>{let b=await n();if(typeof b!="function")d.print(b,{niceJSON:y});else return d.error=new Error("Cant return functions from functions, consider using async/await"),m("error",d,e);let E=e.content;e.content=E,e.events.emit("noWaiting")})();break;case"undefined":e.content=Buffer.from("");break}return d},status(n){return u.statusCode=n,d},printFile(n,c){var O,D;let y=(O=c==null?void 0:c.addTypes)!=null?O:!0,i=(D=c==null?void 0:c.cache)!=null?D:!1;if(y&&(n.endsWith(".pdf")&&d.setHeader("Content-Type","application/pdf"),n.endsWith(".js")&&d.setHeader("Content-Type","text/javascript"),n.endsWith(".html")&&d.setHeader("Content-Type","text/html"),n.endsWith(".css")&&d.setHeader("Content-Type","text/css"),n.endsWith(".csv")&&d.setHeader("Content-Type","text/csv"),n.endsWith(".mpeg")&&d.setHeader("Content-Type","video/mpeg"),n.endsWith(".mp4")&&d.setHeader("Content-Type","video/mp4"),n.endsWith(".webm")&&d.setHeader("Content-Type","video/webm"),n.endsWith(".bmp")&&d.setHeader("Content-Type","image/bmp")),s.has(n))return o.data.outgoing[new Date().getHours()]+=s.get(n).byteLength,e.content=s.get(n),d;let b,E=!1;try{b=C.createReadStream(n),e.waiting=!0,b.pipe(u)}catch(L){E=!0,d.error=L,m("error",d,e)}return E||(b.on("data",L=>{var P;o.data.outgoing[new Date().getHours()]+=L.byteLength;let j=(P=s.get(n))!=null?P:Buffer.from("");i&&s.set(n,Buffer.concat([j,L]))}),b.once("end",()=>{e.events.emit("noWaiting"),e.content=Buffer.from("")}),u.once("close",()=>b.close())),d}},W=!1;if(e.execute.dashboard||(W=await m("request",d,e)),!W){if(r.rateLimits.enabled){for(let n of r.rateLimits.list)if(e.url.pathname.startsWith(n.path)&&(u.setHeader("X-RateLimit-Limit",n.times),u.setHeader("X-RateLimit-Remaining",n.times-((V=await r.rateLimits.functions.get(f+n.path))!=null?V:0)),u.setHeader("X-RateLimit-Reset-Every",n.timeout),await r.rateLimits.functions.set(f+n.path,((N=await r.rateLimits.functions.get(f+n.path))!=null?N:0)+1),setTimeout(async()=>{var c;await r.rateLimits.functions.set(f+n.path,((c=await r.rateLimits.functions.get(f+n.path))!=null?c:0)-1)},n.timeout),await r.rateLimits.functions.get(f+n.path)>n.times))return u.statusCode=429,W=!0,d.print((q=r.rateLimits.message)!=null?q:"Rate Limited"),u.end()}if(r.dashboard.enabled&&!e.execute.dashboard&&(o.requests.total++,o.requests[new Date().getHours()]++),!await new Promise(n=>{if(!e.waiting)return n(!1);e.events.once("noWaiting",()=>n(!1)),e.events.once("endRequest",()=>n(!0))}))if(e.execute.exists&&!W){if(!e.execute.static)await Promise.resolve(e.execute.route.code(d)).catch(n=>{d.error=n,W=!0,m("error",d,e)});else if(e.execute.route.data.addTypes&&(e.execute.route.path.endsWith(".pdf")&&d.setHeader("Content-Type","application/pdf"),e.execute.route.path.endsWith(".js")&&d.setHeader("Content-Type","text/javascript"),e.execute.route.path.endsWith(".html")&&d.setHeader("Content-Type","text/html"),e.execute.route.path.endsWith(".css")&&d.setHeader("Content-Type","text/css"),e.execute.route.path.endsWith(".csv")&&d.setHeader("Content-Type","text/csv"),e.execute.route.path.endsWith(".mpeg")&&d.setHeader("Content-Type","video/mpeg"),e.execute.route.path.endsWith(".mp4")&&d.setHeader("Content-Type","video/mp4"),e.execute.route.path.endsWith(".webm")&&d.setHeader("Content-Type","video/webm"),e.execute.route.path.endsWith(".bmp")&&d.setHeader("Content-Type","image/bmp")),"content"in e.execute.route.data)o.data.outgoing.total+=e.execute.route.data.content.byteLength,o.data.outgoing[new Date().getHours()]+=e.execute.route.data.content.byteLength,e.content=e.execute.route.data.content;else{let n=Z.resolve(e.execute.route.data.file),c,y=!1;try{c=C.createReadStream(n),e.waiting=!0,c.pipe(u)}catch(i){y=!0,d.error=i,m("error",d,e)}if(y)return d;c.on("data",i=>{o.data.outgoing.total+=i.byteLength,o.data.outgoing[new Date().getHours()]+=i.byteLength}),c.once("end",()=>e.events.emit("noWaiting")),u.once("close",()=>c.close())}await new Promise(n=>{if(!e.waiting)return n(!0);e.events.once("noWaiting",()=>n(!1))}),e.content?(o.data.outgoing.total+=e.content.byteLength,o.data.outgoing[new Date().getHours()]+=e.content.byteLength,u.end(e.content,"binary")):u.end()}else m("notfound",d,e),await new Promise(n=>{if(!e.waiting)return n(!0);e.events.once("noWaiting",()=>n(!1))}),e.content?(o.data.outgoing.total+=e.content.byteLength,o.data.outgoing[new Date().getHours()]+=e.content.byteLength,u.end(e.content,"binary")):u.end()}}),r.body.enabled||e.events.emit("startRequest")});return l.listen(r.port,r.bind),new Promise((h,u)=>{l.once("listening",()=>h({success:!0,port:r.port,message:"WEBSERVER STARTED",rawServer:l})),l.once("error",e=>{l.close(),u({success:!1,error:e,message:"WEBSERVER ERRORED"})})})}};
