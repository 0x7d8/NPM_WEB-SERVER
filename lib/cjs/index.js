var se=Object.create;var M=Object.defineProperty;var oe=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var ae=Object.getPrototypeOf,ie=Object.prototype.hasOwnProperty;var ue=(r,t,n,u)=>{if(t&&typeof t=="object"||typeof t=="function")for(let d of ne(t))!ie.call(r,d)&&d!==n&&M(r,d,{get:()=>t[d],enumerable:!(u=oe(t,d))||u.enumerable});return r};var C=(r,t,n)=>(n=r!=null?se(ae(r)):{},ue(t||!r||!r.__esModule?M(n,"default",{value:r,enumerable:!0}):n,r));var N=C(require("fs")),q=(r,t)=>(t=t||[],N.readdirSync(r).forEach(u=>{if(N.statSync(`${r}/${u}`).isDirectory())t=q(`${r}/${u}`,t);else{let d=`${r}/${u}`;t.push(d)}}),t),J=(r,t,n)=>(n=n||[],n=q(r,n).filter(u=>u.endsWith(t)),n);var $=["OPTIONS","DELETE","PATCH","STATIC","POST","PUT","GET"];var O=C(require("path")),X=C(require("fs")),H=(r,t)=>(r=r.replace(/\/{2,}/g,"/"),r.endsWith("/")&&r!=="/"?r.slice(0,-1):!r.startsWith("/")&&r!=="/"?`/${r}`:r.includes("/?")?r.replace("/?","?"):t&&r==="/"?"":r),W=class{constructor(t,n){t=t!=null?t:[],n=n!=null?n:[],this.routes=t,this.events=n}event(t,n){return this.events.some(u=>u.event===t)?!1:this.events.push({event:t,code:n})-1}set(t,n,u){if(n=H(n),!$.includes(t))throw TypeError(`No Valid Request Type: ${t}
Possible Values: ${$.join(", ")}`);return this.routes.some(d=>d.method===t&&d.path===n)?!1:this.routes.push({method:t,path:n,pathArray:n.split("/"),code:u,data:{addTypes:!1}})-1}setBlock(t,n){t=H(t);let u=[];for(let d=0;d<=n.length-1;d++){let o=n[d];u.push(this.routes.push({method:o.method,path:`${t}${H(o.path,!0)}`,pathArray:`${t}${H(o.path,!0)}`.split("/"),code:o.code,data:{addTypes:!1}})-1)}return u}static(t,n,u){var D,k,S;t=H(t);let d=(D=u==null?void 0:u.preload)!=null?D:!1,o=(k=u==null?void 0:u.remHTML)!=null?k:!1,T=(S=u==null?void 0:u.addTypes)!=null?S:!0,m=[];for(let p of q(n)){let c=p.replace(n,"");o&&(c=c.replace("/index.html","/").replace(".html",""));let e=H(c),l=this.routes.push({method:"STATIC",path:e,pathArray:e.split("/"),code:async()=>{},data:{addTypes:T,file:p}});d&&(this.routes[l-1].data.content=X.readFileSync(p)),m.push(l-1)}return m}load(t){let n=J(t,".js"),u=[];for(let d of n){let o=require(O.resolve(d));if(!(!("path"in o)||!("method"in o)||!("code"in o))){if(!$.includes(o.method))throw TypeError(`No Valid Request Type: ${o.method}
Possible Values: ${$.join(", ")}`);u.push(this.routes.push({method:o.method,path:H(o.path),pathArray:H(o.path).split("/"),code:o.code,data:{addTypes:!1}})-1)}}return u}list(){return{routes:this.routes,events:this.events}}};var z=class{constructor(t){this.data=this.mergeOptions({routes:new W,rateLimits:{enabled:!1,message:"Rate Limited",list:[],functions:new Map},body:{enabled:!0,parse:!0,maxSize:5,message:"Payload too large"},https:{enabled:!1,keyFile:"/ssl/key/path",certFile:"/ssl/cert/path"},dashboard:{enabled:!1,path:"/rjweb-dashboard"},bind:"0.0.0.0",proxy:!1,compress:!1,cors:!1,port:2023,poweredBy:!0},t)}mergeOptions(...t){let n=u=>u&&typeof u=="object";return t.reduce((u,d)=>(Object.keys(d).forEach(o=>{let T=u[o],m=d[o];o!=="functions"&&o!=="routes"?Array.isArray(T)&&Array.isArray(m)?u[o]=T.concat(...m):n(T)&&n(m)?u[o]=this.mergeOptions(T,m):u[o]=m:u[o]=m}),u),{})}getOptions(){return this.data}};var x=class{constructor(t,n){this.data={};t=t!=null?t:{},n=n!=null?n:u=>u;for(let u in t)this.data[u]=n(t[u])}has(t){return t in this.data}get(t){return this.data[t]}set(t,n){let u=t in this.data;return this.data[t]=n,u}objectCount(){return Object.keys(this.data).length}toJSON(t){t=t!=null?t:[];let n={};for(let u in this.data)t.includes(u)||(n[u]=this.data[u]);return n}toArray(t){t=t!=null?t:[];let n=[];for(let u in this.data)t.includes(u)||n.push(this.data[u]);return n}forEach(t,n){t=t!=null?t:()=>{},n=n!=null?n:[];let u=0;for(let d in this.data)n.includes(d)||(t(d,this.data[d]),u++);return u}};var Z=(m=>(m.options="OPTIONS",m.delete="DELETE",m.patch="PATCH",m.post="POST",m.put="PUT",m.get="GET",m.static="STATIC",m))(Z||{}),_=Z;var Q=require("stream");var ce=C(require("http")),de=C(require("https")),Y=C(require("querystring")),V=C(require("zlib")),ee=C(require("path")),te=C(require("url")),E=C(require("fs")),re=C(require("os"));module.exports={routeList:W,serverOptions:z,valueCollection:x,types:_,async start(r){r=new z(r).getOptions();let{routes:t,events:n}=r.routes.list(),u=re.cpus().length,d=new x,o={requests:{total:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0},pageDisplay:"",data:{incoming:{total:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0},outgoing:{total:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0}}},T=(p,c)=>{if(r.compress&&!p.rawRes.headersSent&&p.headers.has("accept-encoding")&&p.headers.get("accept-encoding").includes("gzip")){p.rawRes.setHeader("Content-Encoding","gzip"),p.rawRes.setHeader("Vary","Accept-Encoding");let e=V.createGzip();e.pipe(p.rawRes),e.end(c.content,"binary")}else p.rawRes.end(c.content,"binary")},m=async(p,c,e)=>{switch(p){case"error":{let l=n.find(b=>b.event==="error");l?Promise.resolve(l.code(c)).catch(b=>{console.log(b),c.status(500),e.content=Buffer.from(`An Error occured in your Error Event (what the hell?)
${b.stack}`)}):(console.log(c.error),c.status(500),e.content=Buffer.from(`An Error occured
${c.error.stack}`))}case"request":{let l=!1,b=n.find(h=>h.event==="request");return b&&await Promise.resolve(b.code(c)).catch(h=>{l=!0,console.log(h),c.status(500),e.content=Buffer.from(`An Error occured in your Request Event
${h.stack}`)}),l}case"notfound":{let l=!1,b=n.find(h=>h.event==="notfound");if(b)await Promise.resolve(b.code(c)).catch(h=>{l=!0,console.log(h),c.status(500),e.content=Buffer.from(`An Error occured in your Notfound Event
${h.stack}`)});else{let h="";if(o.pageDisplay)h=o.pageDisplay;else{for(let P of t){let a=P.method==="STATIC"?"GET":P.method;h+=`[-] [${a}] ${P.path}
`}o.pageDisplay=h}c.status(404),e.content=Buffer.from(`[!] COULDNT FIND [${c.url.method}]: ${c.url.pathname.toUpperCase()}
[i] AVAILABLE PAGES:

${h}`)}return l}}},D=()=>Array.from({length:5},(p,c)=>(new Date().getHours()-(4-c)+24)%24),k={};r.https.enabled?k={key:await E.promises.readFile(r.https.keyFile).catch(()=>{throw new Error(`Cant access your HTTPS Key file! (${r.https.keyFile})`)}),cert:await E.promises.readFile(r.https.certFile).catch(()=>{throw new Error(`Cant access your HTTPS Cert file! (${r.https.certFile})`)})}:k={};let S=(r.https.enabled?de:ce).createServer(k,async(p,c)=>{let e={content:Buffer.from(""),events:new Q.EventEmitter,waiting:!1,continue:!0,execute:{route:null,static:!1,exists:!1,dashboard:!1},body:{raw:Buffer.from(""),parsed:""},url:{...te.parse(H(p.url)),method:p.method},previousHours:D()};e.events.on("noWaiting",()=>e.waiting=!1),c.once("close",()=>e.events.emit("endRequest")),r.body.enabled&&p.on("data",l=>{if(e.body.raw=Buffer.concat([e.body.raw,Buffer.from(l)]),e.body.raw.byteLength>=r.body.maxSize*1e6){switch(c.statusCode=413,e.continue=!1,typeof r.body.message){case"object":c.setHeader("Content-Type","application/json"),e.content=Buffer.from(JSON.stringify(r.body.message));break;case"string":e.content=Buffer.from(r.body.message);break;case"symbol":e.content=Buffer.from(r.body.message.toString());break;case"bigint":case"number":case"boolean":e.content=Buffer.from(String(r.body.message));break;case"undefined":e.content=Buffer.from("");break}return T({headers:new x(p.headers,decodeURIComponent),rawRes:c},e)}else o.data.incoming.total+=e.body.raw.byteLength,o.data.incoming[e.previousHours[4]]+=e.body.raw.byteLength}).on("end",()=>{e.continue&&e.events.emit("startRequest")}),e.events.once("startRequest",async()=>{var F,G;if(r.cors&&(c.setHeader("Access-Control-Allow-Headers","*"),c.setHeader("Access-Control-Allow-Origin","*"),c.setHeader("Access-Control-Request-Method","*"),c.setHeader("Access-Control-Allow-Methods",$.join(",")),p.method==="OPTIONS"))return c.end("");let l={},b=e.url.pathname.split("/");for(let s=0;s<=t.length-1;s++){let i=t[s];if(d.has(`route::${e.url.pathname}`)){let g=d.get(`route::${e.url.pathname}`);e.execute.route=g,e.execute.static=g.method==="STATIC",e.execute.exists=!0;break}if(r.dashboard.enabled&&(e.url.pathname===H(r.dashboard.path)||e.url.pathname===H(r.dashboard.path)+"/stats")){e.execute.route={method:"GET",path:i.path,pathArray:i.path.split("/"),code:async g=>{if(g.url.path.endsWith("/stats")){let f=new Date,y=f.getTime(),v=process.cpuUsage(),A=await new Promise(L=>setTimeout(()=>{let B=process.cpuUsage(v),w=(new Date().getTime()-y)*5*u,{user:R,system:I}=B;L((I+R)/w)},500));return g.print({requests:[o.requests.total,{hour:e.previousHours[0],amount:o.requests[e.previousHours[0]]},{hour:e.previousHours[1],amount:o.requests[e.previousHours[1]]},{hour:e.previousHours[2],amount:o.requests[e.previousHours[2]]},{hour:e.previousHours[3],amount:o.requests[e.previousHours[3]]},{hour:e.previousHours[4],amount:o.requests[e.previousHours[4]]}],data:{incoming:[o.data.incoming.total,{hour:e.previousHours[0],amount:o.data.incoming[e.previousHours[0]]},{hour:e.previousHours[1],amount:o.data.incoming[e.previousHours[1]]},{hour:e.previousHours[2],amount:o.data.incoming[e.previousHours[2]]},{hour:e.previousHours[3],amount:o.data.incoming[e.previousHours[3]]},{hour:e.previousHours[4],amount:o.data.incoming[e.previousHours[4]]}],outgoing:[o.data.outgoing.total,{hour:e.previousHours[0],amount:o.data.outgoing[e.previousHours[0]]},{hour:e.previousHours[1],amount:o.data.outgoing[e.previousHours[1]]},{hour:e.previousHours[2],amount:o.data.outgoing[e.previousHours[2]]},{hour:e.previousHours[3],amount:o.data.outgoing[e.previousHours[3]]},{hour:e.previousHours[4],amount:o.data.outgoing[e.previousHours[4]]}]},cpu:{time:`${f.getHours()}:${f.getMinutes()}:${f.getSeconds()}`,usage:A.toFixed(2)},memory:{time:`${f.getHours()}:${f.getMinutes()}:${f.getSeconds()}`,usage:(process.memoryUsage().heapUsed/1e3/1e3).toFixed(2)},routes:t.length,cached:d.objectCount()})}else{let f=(await E.promises.readFile(`${__dirname}/stats/index.html`,"utf8")).replaceAll("/rjweb-dashboard",H(r.dashboard.path));return g.print(f)}},data:{addTypes:!1}},e.execute.static=!1,e.execute.exists=!0,e.execute.dashboard=!0;break}if(!(i.method!=="STATIC"&&i.method!==p.method)&&!(i.method==="STATIC"&&p.method!=="GET")&&i.pathArray.length===b.length){if(e.execute.exists)break;if(i.path===e.url.pathname&&i.method===p.method){e.execute.route=i,e.execute.exists=!0,d.set(`route::${e.url.pathname}`,i);break}if(i.path===e.url.pathname&&i.method==="STATIC"){e.execute.route=i,e.execute.static=!0,e.execute.exists=!0,d.set(`route::${e.url.pathname}`,i);break}for(let g=0;g<=i.pathArray.length-1;g++){let f=i.pathArray[g],y=b[g];if(!f.startsWith(":")&&y!==f)break;if(f===y)continue;if(f.startsWith(":")){l[f.substring(1)]=y,e.execute.route=i,e.execute.exists=!0;continue}}if(e.execute.exists)break}}r.poweredBy&&c.setHeader("X-Powered-By","rjweb-server");let h;r.proxy&&p.headers["x-forwarded-for"]?h=p.headers["x-forwarded-for"]:h=p.socket.remoteAddress;let P={};if(p.headers.cookie&&p.headers.cookie.split(";").forEach(s=>{let i=s.split("=");P[i.shift().trim()]=i.join("=")}),p.headers["content-encoding"]==="gzip"&&(e.body.raw=await new Promise(s=>V.gunzip(e.body.raw,(i,g)=>{s(i?e.body.raw:g)}))),r.body.parse)try{JSON.parse(e.body.raw.toString())}catch(s){e.body.parsed=e.body.raw.toString()}else e.body.parsed=e.body.raw.toString();let a={headers:new x(p.headers,decodeURIComponent),cookies:new x(P,decodeURIComponent),params:new x(l,decodeURIComponent),queries:new x(Y.parse(e.url.query),decodeURIComponent),client:{userAgent:p.headers["user-agent"],httpVersion:p.httpVersion,port:p.socket.remotePort,ip:h},body:e.body.parsed,url:e.url,rawServer:S,rawReq:p,rawRes:c,"@":{},setHeader(s,i){return c.setHeader(s,i),a},setCustom(s,i){return a["@"][s]=i,a},print(s,i){var v,A,L;let g=(v=i==null?void 0:i.niceJSON)!=null?v:!1,f=(A=i==null?void 0:i.contentType)!=null?A:"",y=(L=i==null?void 0:i.returnFunctions)!=null?L:!1;switch(typeof s){case"object":c.setHeader("Content-Type","application/json"),g?e.content=Buffer.from(JSON.stringify(s,void 0,1)):e.content=Buffer.from(JSON.stringify(s));break;case"string":f&&c.setHeader("Content-Type",f),e.content=Buffer.from(s);break;case"symbol":f&&c.setHeader("Content-Type",f),e.content=Buffer.from(s.toString());break;case"bigint":case"number":case"boolean":f&&c.setHeader("Content-Type",f),e.content=Buffer.from(String(s));break;case"function":e.waiting=!0,(async()=>{let B=await s();if(typeof B!="function")a.print(B,{niceJSON:g,contentType:f});else if(y)a.print(B,{niceJSON:g,contentType:f,returnFunctions:y});else return a.error=new Error("Cant return functions from functions, consider using async/await"),m("error",a,e);let j=e.content;e.content=j,e.events.emit("noWaiting")})();break;case"undefined":f&&c.setHeader("Content-Type",f),e.content=Buffer.from("");break}return a},status(s){return c.statusCode=s,a},printFile(s,i){var L,B,j;let g=(L=i==null?void 0:i.addTypes)!=null?L:!0,f=(B=i==null?void 0:i.contentType)!=null?B:"",y=(j=i==null?void 0:i.cache)!=null?j:!1;if(g&&!f?(s.endsWith(".pdf")&&a.setHeader("Content-Type","application/pdf"),s.endsWith(".js")&&a.setHeader("Content-Type","text/javascript"),s.endsWith(".html")&&a.setHeader("Content-Type","text/html"),s.endsWith(".css")&&a.setHeader("Content-Type","text/css"),s.endsWith(".csv")&&a.setHeader("Content-Type","text/csv"),s.endsWith(".mpeg")&&a.setHeader("Content-Type","video/mpeg"),s.endsWith(".mp4")&&a.setHeader("Content-Type","video/mp4"),s.endsWith(".webm")&&a.setHeader("Content-Type","video/webm"),s.endsWith(".bmp")&&a.setHeader("Content-Type","image/bmp")):f&&c.setHeader("Content-Type",f),e.continue=!1,d.has(`file::${s}`))return o.data.outgoing.total+=d.get(`file::${s}`).byteLength,o.data.outgoing[e.previousHours[4]]+=d.get(`file::${s}`).byteLength,e.content=d.get(`file::${s}`),a;if(d.has(`file::gzip::${s}`))return o.data.outgoing.total+=d.get(`file::gzip::${s}`).byteLength,o.data.outgoing[e.previousHours[4]]+=d.get(`file::gzip::${s}`).byteLength,e.content=d.get(`file::gzip::${s}`),a;let v,A=!1;if(r.compress&&a.headers.has("accept-encoding")&&a.headers.get("accept-encoding").includes("gzip")){a.rawRes.setHeader("Content-Encoding","gzip"),a.rawRes.setHeader("Vary","Accept-Encoding");let w=V.createGzip();try{v=E.createReadStream(s),e.waiting=!0,v.pipe(w),w.pipe(c)}catch(R){A=!0,a.error=R,m("error",a,e)}w.on("data",R=>{var K;o.data.outgoing.total+=R.byteLength,o.data.outgoing[e.previousHours[4]]+=R.byteLength;let I=(K=d.get(`file::gzip::${s}`))!=null?K:Buffer.from("");y&&d.set(`file::gzip::${s}`,Buffer.concat([I,R]))}),w.once("end",()=>{e.events.emit("noWaiting"),e.content=Buffer.from("")}),c.once("close",()=>{v.close(),w.close()})}else{try{v=E.createReadStream(s),e.waiting=!0,v.pipe(c)}catch(w){A=!0,a.error=w,m("error",a,e)}v.on("data",w=>{var I;o.data.outgoing.total+=w.byteLength,o.data.outgoing[e.previousHours[4]]+=w.byteLength;let R=(I=d.get(`file::${s}`))!=null?I:Buffer.from("");y&&d.set(`file::${s}`,Buffer.concat([R,w]))}),v.once("end",()=>{e.events.emit("noWaiting"),e.content=Buffer.from("")}),c.once("close",()=>{v.close()})}return a}},U=!1;if(e.execute.dashboard||(U=await m("request",a,e)),!U){if(r.rateLimits.enabled){for(let s of r.rateLimits.list)if(e.url.pathname.startsWith(s.path)&&(c.setHeader("X-RateLimit-Limit",s.times),c.setHeader("X-RateLimit-Remaining",s.times-((F=await r.rateLimits.functions.get(h+s.path))!=null?F:0)),c.setHeader("X-RateLimit-Reset-Every",s.timeout),await r.rateLimits.functions.set(h+s.path,((G=await r.rateLimits.functions.get(h+s.path))!=null?G:0)+1),setTimeout(async()=>{var i;await r.rateLimits.functions.set(h+s.path,((i=await r.rateLimits.functions.get(h+s.path))!=null?i:0)-1)},s.timeout),await r.rateLimits.functions.get(h+s.path)>s.times))return c.statusCode=429,U=!0,a.print(r.rateLimits.message),T(a,e)}if(r.dashboard.enabled&&!e.execute.dashboard&&(o.requests.total++,o.requests[e.previousHours[4]]++),!await new Promise(s=>{if(!e.waiting)return s(!1);e.events.once("noWaiting",()=>s(!1)),e.events.once("endRequest",()=>s(!0))}))if(e.execute.exists&&!U){if(!e.execute.static)await Promise.resolve(e.execute.route.code(a)).catch(s=>{a.error=s,U=!0,m("error",a,e)});else if(e.execute.route.data.addTypes&&(e.execute.route.path.endsWith(".pdf")&&a.setHeader("Content-Type","application/pdf"),e.execute.route.path.endsWith(".js")&&a.setHeader("Content-Type","text/javascript"),e.execute.route.path.endsWith(".html")&&a.setHeader("Content-Type","text/html"),e.execute.route.path.endsWith(".css")&&a.setHeader("Content-Type","text/css"),e.execute.route.path.endsWith(".csv")&&a.setHeader("Content-Type","text/csv"),e.execute.route.path.endsWith(".mpeg")&&a.setHeader("Content-Type","video/mpeg"),e.execute.route.path.endsWith(".mp4")&&a.setHeader("Content-Type","video/mp4"),e.execute.route.path.endsWith(".webm")&&a.setHeader("Content-Type","video/webm"),e.execute.route.path.endsWith(".bmp")&&a.setHeader("Content-Type","image/bmp")),e.continue=!1,"content"in e.execute.route.data)o.data.outgoing.total+=e.execute.route.data.content.byteLength,o.data.outgoing[e.previousHours[4]]+=e.execute.route.data.content.byteLength,e.content=e.execute.route.data.content;else{let s=ee.resolve(e.execute.route.data.file),i,g=!1;if(r.compress&&a.headers.has("accept-encoding")&&a.headers.get("accept-encoding").includes("gzip")){a.rawRes.setHeader("Content-Encoding","gzip"),a.rawRes.setHeader("Vary","Accept-Encoding");let f=V.createGzip();try{i=E.createReadStream(s),e.waiting=!0,i.pipe(f),f.pipe(c)}catch(y){g=!0,a.error=y,m("error",a,e)}f.on("data",y=>{o.data.outgoing.total+=y.byteLength,o.data.outgoing[e.previousHours[4]]+=y.byteLength}),f.once("end",()=>{e.events.emit("noWaiting"),e.content=Buffer.from("")}),c.once("close",()=>{i.close(),f.close()})}else{try{i=E.createReadStream(s),e.waiting=!0,i.pipe(c)}catch(f){g=!0,a.error=f,m("error",a,e)}i.on("data",f=>{o.data.outgoing.total+=f.byteLength,o.data.outgoing[e.previousHours[4]]+=f.byteLength}),i.once("end",()=>{e.events.emit("noWaiting"),e.content=Buffer.from("")}),c.once("close",()=>{i.close()})}if(g)return a}await new Promise(s=>{if(!e.waiting)return s(!0);e.events.once("noWaiting",()=>s(!1))}),e.content&&e.continue?(o.data.outgoing.total+=e.content.byteLength,o.data.outgoing[e.previousHours[4]]+=e.content.byteLength,T(a,e)):c.end()}else m("notfound",a,e),await new Promise(s=>{if(!e.waiting)return s(!0);e.events.once("noWaiting",()=>s(!1))}),e.content&&e.continue?(o.data.outgoing.total+=e.content.byteLength,o.data.outgoing[e.previousHours[4]]+=e.content.byteLength,T(a,e)):c.end()}}),r.body.enabled||e.events.emit("startRequest")});return S.listen(r.port,r.bind),new Promise((p,c)=>{S.once("listening",()=>p({success:!0,port:r.port,message:"WEBSERVER STARTED",rawServer:S})),S.once("error",e=>{S.close(),c({success:!1,error:e,message:"WEBSERVER ERRORED"})})})}};
