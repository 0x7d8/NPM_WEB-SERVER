var ne=Object.create;var q=Object.defineProperty;var ae=Object.getOwnPropertyDescriptor;var oe=Object.getOwnPropertyNames;var ie=Object.getPrototypeOf,ce=Object.prototype.hasOwnProperty;var ue=(r,s)=>()=>(s||r((s={exports:{}}).exports,s),s.exports);var de=(r,s,u,c)=>{if(s&&typeof s=="object"||typeof s=="function")for(let m of oe(s))!ce.call(r,m)&&m!==u&&q(r,m,{get:()=>s[m],enumerable:!(c=ae(s,m))||c.enumerable});return r};var T=(r,s,u)=>(u=r!=null?ne(ie(r)):{},de(s||!r||!r.__esModule?q(u,"default",{value:r,enumerable:!0}):u,r));var $=ue((pe,J)=>{J.exports=["OPTIONS","DELETE","PATCH","STATIC","POST","PUT","GET"]});var P=T(require("fs")),k=(r,s)=>(s=s||[],P.readdirSync(r).forEach(c=>{if(P.statSync(r+"/"+c).isDirectory())s=k(r+"/"+c,s);else{let m=r+"/"+c;s.push(m)}}),s),G=(r,s,u)=>(u=u||[],u=k(r,u).filter(c=>c.endsWith(s)),u);var H=T($()),X=T(require("path")),F=T(require("fs")),x=r=>(r=r.replace(/\/{2,}/g,"/"),r.endsWith("/")&&r!=="/"?r.slice(0,-1):!r.startsWith("/")&&r!=="/"?`/${r}`:r),S=class{constructor(s,u){s=s!=null?s:[],u=u!=null?u:[],this.routes=s,this.events=u}event(s,u){return this.events.some(c=>c.event===s)?!1:this.events.push({event:s,code:u})-1}set(s,u,c){if(u=x(u),!H.default.includes(s))throw TypeError(`No Valid Request Type: ${s}
Possible Values: ${H.default.join(", ")}`);return this.routes.some(m=>m.method===s&&m.path===u)?!1:this.routes.push({method:s,path:u,pathArray:u.split("/"),code:c,data:{addTypes:!1}})-1}static(s,u,c){var a,g,f;s=x(s);let m=(a=c==null?void 0:c.preload)!=null?a:!1,p=(g=c==null?void 0:c.remHTML)!=null?g:!1,w=(f=c==null?void 0:c.addTypes)!=null?f:!0,o=[];for(let e of k(u)){let l=e.replace(u,"");p&&(l=l.replace("/index.html","/").replace(".html",""));let v=x(l),y=this.routes.push({method:"STATIC",path:v,pathArray:v.split("/"),code:async()=>{},data:{addTypes:w,file:e}});m&&(this.routes[y-1].data.content=F.readFileSync(e)),o.push(y-1)}return o}load(s){let u=G(s,".js"),c=[];for(let m of u){let p=require(X.resolve(m));if(!(!("path"in p)||!("method"in p)||!("code"in p))){if(!H.default.includes(p.method))throw TypeError(`No Valid Request Type: ${p.method}
Possible Values: ${H.default.join(", ")}`);c.push(this.routes.push({method:p.method,path:x(p.path),pathArray:x(p.path).split("/"),code:p.code,data:{addTypes:!1}})-1)}}return c}list(){return{routes:this.routes,events:this.events}}};var L=class{constructor(s){this.data=this.mergeOptions({routes:new S,rateLimits:{enabled:!1,message:"Rate Limited",list:[],functions:new Map},dashboard:{enabled:!1,path:"/rjweb-dashboard"},bind:"0.0.0.0",proxy:!1,cors:!1,port:2023,maxBody:5,poweredBy:!0},s)}mergeOptions(...s){let u=c=>c&&typeof c=="object";return s.reduce((c,m)=>(Object.keys(m).forEach(p=>{let w=c[p],o=m[p];Array.isArray(w)&&Array.isArray(o)?c[p]=w.concat(...o):u(w)&&u(o)?c[p]=this.mergeOptions(w,o):c[p]=o}),c),{})}getOptions(){return this.data}};var z=(o=>(o.options="OPTIONS",o.delete="DELETE",o.patch="PATCH",o.post="POST",o.put="PUT",o.get="GET",o.static="STATIC",o))(z||{}),_=z;var K=require("stream"),Q=T($()),Y=T(require("path")),Z=T(require("http")),ee=T(require("url")),R=T(require("fs")),te=T(require("os"));module.exports={routeList:S,types:_,async start(r){r=new L(r).getOptions();let{routes:s,events:u}=r.routes,c=new Map,m={requests:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0}},p=async(o,a,g)=>{switch(o){case"error":{let f=u.find(e=>e.event==="error");f?Promise.resolve(f.code(a)).catch(e=>{console.log(e),a.status(500),g.content=Buffer.from(`An Error occured in your Error Event (what the hell?)
${e.stack}`)}):(console.log(a.error),a.status(500),g.content=Buffer.from(`An Error occured
${a.error.stack}`))}case"request":{let f=!1,e=u.find(l=>l.event==="request");return e&&await Promise.resolve(e.code(a)).catch(l=>{f=!0,console.log(l),a.status(500),g.content=Buffer.from(`An Error occured in your Request Event
${l.stack}`)}),f}case"notfound":{let f=!1,e=u.find(l=>l.event==="notfound");if(e)await Promise.resolve(e.code(a)).catch(l=>{f=!0,console.log(l),a.status(500),g.content=Buffer.from(`An Error occured in your Notfound Event
${l.stack}`)});else{let l="";for(let v of s){let y=v.method==="STATIC"?"GET":v.method;l+=`[-] [${y}] ${v.path}
`}a.status(404),g.content=Buffer.from(`[!] COULDNT FIND ${a.url.pathname.toUpperCase()}
[i] AVAILABLE PAGES:

${l}`)}return f}}},w=Z.createServer(async(o,a)=>{let g="";if(o.headers["content-length"]&&Number(o.headers["content-length"])>=r.maxBody*1e6)return a.statusCode=413,a.write("Payload Too Large"),a.end();o.on("data",f=>{g+=f}).on("end",async()=>{var j,D,M;let f={...ee.parse(o.url),method:o.method};f.path=x(f.path),f.pathname=x(f.pathname);try{g=JSON.parse(g)}catch(t){}if(r.cors&&(a.setHeader("Access-Control-Allow-Headers","*"),a.setHeader("Access-Control-Allow-Origin","*"),a.setHeader("Access-Control-Request-Method","*"),a.setHeader("Access-Control-Allow-Methods",Q.default.join(",")),o.method==="OPTIONS"))return a.end("");let e={content:Buffer.from(""),events:new K.EventEmitter,waiting:!1,execute:{route:null,static:!1,exists:!1,dashboard:!1}};e.events.on("noWaiting",()=>e.waiting=!1),a.once("close",()=>e.events.emit("endRequest"));let l=new Map,v=f.path.split("/");for(let t=0;t<=s.length-1;t++){let n=s[t];if(!(n.method!=="STATIC"&&n.method!==o.method)&&n.pathArray.length===v.length){if(e.execute.exists)break;if(n.path===f.path&&n.method===o.method){e.execute.route=n,e.execute.exists=!0;break}if(n.path===f.path&&n.method==="STATIC"){e.execute.route=n,e.execute.static=!0,e.execute.exists=!0;break}if(r.dashboard.enabled&&(f.path===x(r.dashboard.path)||f.path===x(r.dashboard.path)+"/stats")){e.execute.route={method:"GET",path:n.path,pathArray:n.path.split("/"),code:async h=>{if(h.url.path.endsWith("/stats")){if(h.url.path.endsWith("/stats")){let d=new Date,b=new Date().getTime(),C=process.cpuUsage();m.requests[String((d.getHours()-5+24)%24)]=0;let W=await new Promise(B=>setTimeout(()=>{let A=process.cpuUsage(C),O=(new Date().getTime()-b)*5*te.cpus().length,{user:re,system:se}=A;B((se+re)/O)},500));return h.print({requests:[{hour:d.getHours()-0,amount:m.requests[String((d.getHours()-0+24)%24)]},{hour:d.getHours()-1,amount:m.requests[String((d.getHours()-1+24)%24)]},{hour:d.getHours()-2,amount:m.requests[String((d.getHours()-2+24)%24)]},{hour:d.getHours()-3,amount:m.requests[String((d.getHours()-3+24)%24)]},{hour:d.getHours()-4,amount:m.requests[String((d.getHours()-4+24)%24)]}].reverse(),cpu:{time:`${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}`,usage:W.toFixed(2)},memory:{time:`${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}`,usage:(process.memoryUsage().heapUsed/1e3/1e3).toFixed(2)},routes:s.length})}}else{let d=(await R.promises.readFile(__dirname+"/stats/index.html","utf8")).replaceAll("/rjweb-dashboard",x(r.dashboard.path));return h.print(d)}},data:{addTypes:!1}},e.execute.static=!1,e.execute.exists=!0,e.execute.dashboard=!0;break}for(let h=0;h<=n.pathArray.length-1;h++){let d=n.pathArray[h],b=v[h];if(!d.startsWith(":")&&b!==d)break;if(d!==b&&d.startsWith(":")){l.set(d.replace(":",""),decodeURIComponent(b)),e.execute.route=n,e.execute.exists=!0;continue}}}}let y;r.proxy&&o.headers["x-forwarded-for"]?y=o.headers["x-forwarded-for"]:y=o.socket.remoteAddress;let I=new Map;Object.keys(o.headers).forEach(t=>{I.set(t,o.headers[t])}),I.delete("cookie");let N=new Map;for(let[t,n]of new URLSearchParams(f.search))N.set(t,decodeURIComponent(n));let U=new Map;o.headers.cookie&&o.headers.cookie.split(";").forEach(t=>{let[n,...h]=t.split("=");if(n=n==null?void 0:n.trim(),!n)return;let d=h.join("=").trim();d&&U.set(n,decodeURIComponent(d))}),r.poweredBy&&a.setHeader("X-Powered-By","rjweb-server");let i={headers:I,cookies:U,params:l,queries:N,client:{userAgent:o.headers["user-agent"],httpVersion:o.httpVersion,port:o.socket.remotePort,ip:y},body:g,url:f,rawServer:w,rawReq:o,rawRes:a,"@":{},setHeader(t,n){return a.setHeader(t,n),i},setCustom(t,n){return i["@"][t]=n,i},print(t,n){var d;let h=(d=n==null?void 0:n.niceJSON)!=null?d:!1;switch(typeof t){case"object":a.setHeader("Content-Type","application/json"),h?e.content=Buffer.from(JSON.stringify(t,void 0,1)):e.content=Buffer.from(JSON.stringify(t));break;case"string":e.content=Buffer.from(t);break;case"symbol":e.content=Buffer.from(t.toString());break;case"bigint":case"number":case"boolean":e.content=Buffer.from(String(t));break;case"function":e.waiting=!0,(async()=>{let b=await t();if(typeof b!="function")i.print(b,{niceJSON:h});else return i.error=new Error("Cant return functions from functions, consider using async/await"),p("error",i,e);let C=e.content;e.content=C,e.events.emit("noWaiting")})();break;case"undefined":e.content=Buffer.from("");break}return i},status(t){return a.statusCode=t,i},printFile(t,n){var W,B;let h=(W=n==null?void 0:n.addTypes)!=null?W:!0,d=(B=n==null?void 0:n.cache)!=null?B:!1;if(h&&(t.endsWith(".pdf")&&i.setHeader("Content-Type","application/pdf"),t.endsWith(".js")&&i.setHeader("Content-Type","text/javascript"),t.endsWith(".html")&&i.setHeader("Content-Type","text/html"),t.endsWith(".css")&&i.setHeader("Content-Type","text/css"),t.endsWith(".csv")&&i.setHeader("Content-Type","text/csv"),t.endsWith(".mpeg")&&i.setHeader("Content-Type","video/mpeg"),t.endsWith(".mp4")&&i.setHeader("Content-Type","video/mp4"),t.endsWith(".webm")&&i.setHeader("Content-Type","video/webm"),t.endsWith(".bmp")&&i.setHeader("Content-Type","image/bmp")),c.has(t))return e.content=c.get(t),i;let b,C=!1;try{b=R.createReadStream(t),e.waiting=!0,b.pipe(a)}catch(A){C=!0,i.error=A,p("error",i,e)}return C||(b.on("data",A=>{var O;let V=(O=c.get(t))!=null?O:Buffer.from("");d&&c.set(t,Buffer.concat([V,A]))}),b.once("end",()=>e.events.emit("noWaiting")),a.once("close",()=>b.close())),i}},E=!1;if(e.execute.dashboard||(E=await p("request",i,e)),!E){if(r.rateLimits.enabled){for(let t of r.rateLimits.list)if(f.path.startsWith(t.path)&&(a.setHeader("X-RateLimit-Limit",t.times),a.setHeader("X-RateLimit-Remaining",t.times-((j=await r.rateLimits.functions.get(y+t.path))!=null?j:0)),a.setHeader("X-RateLimit-Reset-Every",t.timeout),await r.rateLimits.functions.set(y+t.path,((D=await r.rateLimits.functions.get(y+t.path))!=null?D:0)+1),setTimeout(async()=>{var n;await r.rateLimits.functions.set(y+t.path,((n=await r.rateLimits.functions.get(y+t.path))!=null?n:0)-1)},t.timeout),await r.rateLimits.functions.get(y+t.path)>t.times))return a.statusCode=429,E=!0,i.print((M=r.rateLimits.message)!=null?M:"Rate Limited"),a.end()}if(r.dashboard.enabled&&!e.execute.dashboard&&m.requests[new Date().getHours()]++,!await new Promise(t=>{if(!e.waiting)return t(!1);e.events.once("noWaiting",()=>t(!1)),e.events.once("endRequest",()=>t(!0))}))if(e.execute.exists&&!E){if(!e.execute.static)await Promise.resolve(e.execute.route.code(i)).catch(t=>{i.error=t,E=!0,p("error",i,e)});else{if(e.execute.route.data.addTypes&&(e.execute.route.path.endsWith(".pdf")&&i.setHeader("Content-Type","application/pdf"),e.execute.route.path.endsWith(".js")&&i.setHeader("Content-Type","text/javascript"),e.execute.route.path.endsWith(".html")&&i.setHeader("Content-Type","text/html"),e.execute.route.path.endsWith(".css")&&i.setHeader("Content-Type","text/css"),e.execute.route.path.endsWith(".csv")&&i.setHeader("Content-Type","text/csv"),e.execute.route.path.endsWith(".mpeg")&&i.setHeader("Content-Type","video/mpeg"),e.execute.route.path.endsWith(".mp4")&&i.setHeader("Content-Type","video/mp4"),e.execute.route.path.endsWith(".webm")&&i.setHeader("Content-Type","video/webm"),e.execute.route.path.endsWith(".bmp")&&i.setHeader("Content-Type","image/bmp")),!("content"in e.execute.route.data)){let t=Y.resolve(e.execute.route.data.file),n,h=!1;try{n=R.createReadStream(t),e.waiting=!0,n.pipe(a)}catch(d){h=!0,i.error=d,p("error",i,e)}if(h)return i;n.once("end",()=>e.events.emit("noWaiting")),a.once("close",()=>n.close())}e.content=e.execute.route.data.content}await new Promise(t=>{if(!e.waiting)return t(!0);e.events.once("noWaiting",()=>t(!1))}),a.end(e.content,"binary")}else p("notfound",i,e),await new Promise(t=>{if(!e.waiting)return t(!0);e.events.once("noWaiting",()=>t(!1))}),a.end(e.content,"binary")}})});return w.listen(r.port,r.bind),new Promise((o,a)=>{w.once("listening",()=>o({success:!0,port:r.port,message:"WEBSERVER STARTED",rawServer:w})),w.once("error",g=>{w.close(),a({success:!1,error:g,message:"WEBSERVER ERRORED"})})})}};
