var ae=Object.create;var G=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var ie=Object.getOwnPropertyNames;var ue=Object.getPrototypeOf,ce=Object.prototype.hasOwnProperty;var de=(r,t)=>()=>(t||r((t={exports:{}}).exports,t),t.exports);var fe=(r,t,a,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let d of ie(t))!ce.call(r,d)&&d!==a&&G(r,d,{get:()=>t[d],enumerable:!(i=ne(t,d))||i.enumerable});return r};var w=(r,t,a)=>(a=r!=null?ae(ue(r)):{},fe(t||!r||!r.__esModule?G(a,"default",{value:r,enumerable:!0}):a,r));var N=de((ge,M)=>{M.exports=["OPTIONS","DELETE","PATCH","STATIC","POST","PUT","GET"]});var j=w(require("fs")),D=(r,t)=>(t=t||[],j.readdirSync(r).forEach(i=>{if(j.statSync(r+"/"+i).isDirectory())t=D(r+"/"+i,t);else{let d=r+"/"+i;t.push(d)}}),t),K=(r,t,a)=>(a=a||[],a=D(r,a).filter(i=>i.endsWith(t)),a);var I=w(N()),J=w(require("path")),X=w(require("fs")),x=r=>(r=r.replace(/\/{2,}/g,"/"),r.endsWith("/")&&r!=="/"?r.slice(0,-1):!r.startsWith("/")&&r!=="/"?`/${r}`:r.includes("/?")?r.replace("/?","?"):r),A=class{constructor(t,a){t=t!=null?t:[],a=a!=null?a:[],this.routes=t,this.events=a}event(t,a){return this.events.some(i=>i.event===t)?!1:this.events.push({event:t,code:a})-1}set(t,a,i){if(a=x(a),!I.default.includes(t))throw TypeError(`No Valid Request Type: ${t}
Possible Values: ${I.default.join(", ")}`);return this.routes.some(d=>d.method===t&&d.path===a)?!1:this.routes.push({method:t,path:a,pathArray:a.split("/"),code:i,data:{addTypes:!1}})-1}static(t,a,i){var z,B,S;t=x(t);let d=(z=i==null?void 0:i.preload)!=null?z:!1,o=(B=i==null?void 0:i.remHTML)!=null?B:!1,H=(S=i==null?void 0:i.addTypes)!=null?S:!0,m=[];for(let f of D(a)){let u=f.replace(a,"");o&&(u=u.replace("/index.html","/").replace(".html",""));let e=x(u),y=this.routes.push({method:"STATIC",path:e,pathArray:e.split("/"),code:async()=>{},data:{addTypes:H,file:f}});d&&(this.routes[y-1].data.content=X.readFileSync(f)),m.push(y-1)}return m}load(t){let a=K(t,".js"),i=[];for(let d of a){let o=require(J.resolve(d));if(!(!("path"in o)||!("method"in o)||!("code"in o))){if(!I.default.includes(o.method))throw TypeError(`No Valid Request Type: ${o.method}
Possible Values: ${I.default.join(", ")}`);i.push(this.routes.push({method:o.method,path:x(o.path),pathArray:x(o.path).split("/"),code:o.code,data:{addTypes:!1}})-1)}}return i}list(){return{routes:this.routes,events:this.events}}};var W=class{constructor(t){this.data=this.mergeOptions({routes:new A,rateLimits:{enabled:!1,message:"Rate Limited",list:[],functions:new Map},body:{enabled:!0,parse:!0,maxSize:5,message:"Payload too large"},https:{enabled:!1,keyFile:"/ssl/key/path",certFile:"/ssl/cert/path"},dashboard:{enabled:!1,path:"/rjweb-dashboard"},bind:"0.0.0.0",proxy:!1,compress:!0,cors:!1,port:2023,poweredBy:!0},t)}mergeOptions(...t){let a=i=>i&&typeof i=="object";return t.reduce((i,d)=>(Object.keys(d).forEach(o=>{let H=i[o],m=d[o];o!=="functions"&&o!=="routes"?Array.isArray(H)&&Array.isArray(m)?i[o]=H.concat(...m):a(H)&&a(m)?i[o]=this.mergeOptions(H,m):i[o]=m:i[o]=m}),i),{})}getOptions(){return this.data}};var T=class{constructor(t,a){this.data={};t=t!=null?t:{},a=a!=null?a:i=>i;for(let i in t)this.data[i]=a(t[i])}has(t){return t in this.data}get(t){return this.data[t]}set(t,a){let i=t in this.data;return this.data[t]=a,i}objectCount(){return Object.keys(this.data).length}toJSON(t){t=t!=null?t:[];let a={};for(let i in this.data)t.includes(i)||(a[i]=this.data[i]);return a}toArray(t){t=t!=null?t:[];let a=[];for(let i in this.data)t.includes(i)||a.push(this.data[i]);return a}forEach(t,a){t=t!=null?t:()=>{},a=a!=null?a:[];let i=0;for(let d in this.data)a.includes(d)||(t(d,this.data[d]),i++);return i}};var _=(m=>(m.options="OPTIONS",m.delete="DELETE",m.patch="PATCH",m.post="POST",m.put="PUT",m.get="GET",m.static="STATIC",m))(_||{}),Z=_;var Q=require("stream"),Y=w(N()),pe=w(require("http")),me=w(require("https")),ee=w(require("querystring")),k=w(require("zlib")),te=w(require("path")),re=w(require("url")),C=w(require("fs")),se=w(require("os"));module.exports={routeList:A,serverOptions:W,valueCollection:T,types:Z,async start(r){r=new W(r).getOptions();let{routes:t,events:a}=r.routes.list(),i=se.cpus().length,d=new T,o={requests:{total:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0},pageDisplay:"",data:{incoming:{total:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0},outgoing:{total:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0}}},H=(f,u)=>{if(r.compress&&!f.rawRes.headersSent&&f.headers.has("accept-encoding")&&f.headers.get("accept-encoding").includes("gzip")){f.rawRes.setHeader("Content-Encoding","gzip"),f.rawRes.setHeader("Vary","Accept-Encoding");let e=k.createGzip();e.pipe(f.rawRes),e.end(u.content,"binary")}else f.rawRes.end(u.content,"binary")},m=async(f,u,e)=>{switch(f){case"error":{let y=a.find(b=>b.event==="error");y?Promise.resolve(y.code(u)).catch(b=>{console.log(b),u.status(500),e.content=Buffer.from(`An Error occured in your Error Event (what the hell?)
${b.stack}`)}):(console.log(u.error),u.status(500),e.content=Buffer.from(`An Error occured
${u.error.stack}`))}case"request":{let y=!1,b=a.find(l=>l.event==="request");return b&&await Promise.resolve(b.code(u)).catch(l=>{y=!0,console.log(l),u.status(500),e.content=Buffer.from(`An Error occured in your Request Event
${l.stack}`)}),y}case"notfound":{let y=!1,b=a.find(l=>l.event==="notfound");if(b)await Promise.resolve(b.code(u)).catch(l=>{y=!0,console.log(l),u.status(500),e.content=Buffer.from(`An Error occured in your Notfound Event
${l.stack}`)});else{let l="";if(o.pageDisplay)l=o.pageDisplay;else{for(let L of t){let n=L.method==="STATIC"?"GET":L.method;l+=`[-] [${n}] ${L.path}
`}o.pageDisplay=l}u.status(404),e.content=Buffer.from(`[!] COULDNT FIND [${u.url.method}]: ${u.url.pathname.toUpperCase()}
[i] AVAILABLE PAGES:

${l}`)}return y}}},z=()=>Array.from({length:5},(f,u)=>(new Date().getHours()-(4-u)+24)%24),B={};r.https.enabled?B={key:await C.promises.readFile(r.https.keyFile).catch(()=>{throw new Error(`Cant access your HTTPS Key file! (${r.https.keyFile})`)}),cert:await C.promises.readFile(r.https.certFile).catch(()=>{throw new Error(`Cant access your HTTPS Cert file! (${r.https.certFile})`)})}:B={};let S=(r.https.enabled?me:pe).createServer(B,async(f,u)=>{let e={content:Buffer.from(""),events:new Q.EventEmitter,waiting:!1,continue:!0,execute:{route:null,static:!1,exists:!1,dashboard:!1},body:{raw:Buffer.from(""),parsed:""},url:{...re.parse(x(f.url)),method:f.method},previousHours:z()};e.events.on("noWaiting",()=>e.waiting=!1),u.once("close",()=>e.events.emit("endRequest")),r.body.enabled&&f.on("data",y=>{if(e.body.raw=Buffer.concat([e.body.raw,Buffer.from(y)]),e.body.raw.byteLength>=r.body.maxSize*1e6){switch(u.statusCode=413,e.continue=!1,typeof r.body.message){case"object":u.setHeader("Content-Type","application/json"),e.content=Buffer.from(JSON.stringify(r.body.message));break;case"string":e.content=Buffer.from(r.body.message);break;case"symbol":e.content=Buffer.from(r.body.message.toString());break;case"bigint":case"number":case"boolean":e.content=Buffer.from(String(r.body.message));break;case"undefined":e.content=Buffer.from("");break}return H({headers:new T(f.headers,decodeURIComponent),rawRes:u},e)}else o.data.incoming.total+=e.body.raw.byteLength,o.data.incoming[e.previousHours[4]]+=e.body.raw.byteLength}).on("end",()=>{e.continue&&e.events.emit("startRequest")}),e.events.once("startRequest",async()=>{var q,F;if(r.cors&&(u.setHeader("Access-Control-Allow-Headers","*"),u.setHeader("Access-Control-Allow-Origin","*"),u.setHeader("Access-Control-Request-Method","*"),u.setHeader("Access-Control-Allow-Methods",Y.default.join(",")),f.method==="OPTIONS"))return u.end("");let y={},b=e.url.pathname.split("/");for(let s=0;s<=t.length-1;s++){let c=t[s];if(d.has(`route::${e.url.pathname}`)){let h=d.get(`route::${e.url.pathname}`);e.execute.route=h,e.execute.static=h.method==="STATIC",e.execute.exists=!0;break}if(r.dashboard.enabled&&(e.url.pathname===x(r.dashboard.path)||e.url.pathname===x(r.dashboard.path)+"/stats")){e.execute.route={method:"GET",path:c.path,pathArray:c.path.split("/"),code:async h=>{if(h.url.path.endsWith("/stats")){let p=new Date,g=p.getTime(),R=process.cpuUsage(),O=await new Promise(V=>setTimeout(()=>{let v=process.cpuUsage(R),$=(new Date().getTime()-g)*5*i,{user:U,system:oe}=v;V((oe+U)/$)},500));return h.print({requests:[o.requests.total,{hour:e.previousHours[0],amount:o.requests[e.previousHours[0]]},{hour:e.previousHours[1],amount:o.requests[e.previousHours[1]]},{hour:e.previousHours[2],amount:o.requests[e.previousHours[2]]},{hour:e.previousHours[3],amount:o.requests[e.previousHours[3]]},{hour:e.previousHours[4],amount:o.requests[e.previousHours[4]]}],data:{incoming:[o.data.incoming.total,{hour:e.previousHours[0],amount:o.data.incoming[e.previousHours[0]]},{hour:e.previousHours[1],amount:o.data.incoming[e.previousHours[1]]},{hour:e.previousHours[2],amount:o.data.incoming[e.previousHours[2]]},{hour:e.previousHours[3],amount:o.data.incoming[e.previousHours[3]]},{hour:e.previousHours[4],amount:o.data.incoming[e.previousHours[4]]}],outgoing:[o.data.outgoing.total,{hour:e.previousHours[0],amount:o.data.outgoing[e.previousHours[0]]},{hour:e.previousHours[1],amount:o.data.outgoing[e.previousHours[1]]},{hour:e.previousHours[2],amount:o.data.outgoing[e.previousHours[2]]},{hour:e.previousHours[3],amount:o.data.outgoing[e.previousHours[3]]},{hour:e.previousHours[4],amount:o.data.outgoing[e.previousHours[4]]}]},cpu:{time:`${p.getHours()}:${p.getMinutes()}:${p.getSeconds()}`,usage:O.toFixed(2)},memory:{time:`${p.getHours()}:${p.getMinutes()}:${p.getSeconds()}`,usage:(process.memoryUsage().heapUsed/1e3/1e3).toFixed(2)},routes:t.length,cached:d.objectCount()})}else{let p=(await C.promises.readFile(`${__dirname}/stats/index.html`,"utf8")).replaceAll("/rjweb-dashboard",x(r.dashboard.path));return h.print(p)}},data:{addTypes:!1}},e.execute.static=!1,e.execute.exists=!0,e.execute.dashboard=!0;break}if(!(c.method!=="STATIC"&&c.method!==f.method)&&!(c.method==="STATIC"&&f.method!=="GET")&&c.pathArray.length===b.length){if(e.execute.exists)break;if(c.path===e.url.pathname&&c.method===f.method){e.execute.route=c,e.execute.exists=!0,d.set(`route::${e.url.pathname}`,c);break}if(c.path===e.url.pathname&&c.method==="STATIC"){e.execute.route=c,e.execute.static=!0,e.execute.exists=!0,d.set(`route::${e.url.pathname}`,c);break}for(let h=0;h<=c.pathArray.length-1;h++){let p=c.pathArray[h],g=b[h];if(!p.startsWith(":")&&g!==p)break;if(p===g)continue;if(p.startsWith(":")){y[p.substring(1)]=g,e.execute.route=c,e.execute.exists=!0;continue}}if(e.execute.exists)break}}r.poweredBy&&u.setHeader("X-Powered-By","rjweb-server");let l;r.proxy&&f.headers["x-forwarded-for"]?l=f.headers["x-forwarded-for"]:l=f.socket.remoteAddress;let L={};if(f.headers.cookie&&f.headers.cookie.split(";").forEach(s=>{let c=s.split("=");L[c.shift().trim()]=c.join("=")}),f.headers["content-encoding"]==="gzip"&&(e.body.raw=await new Promise(s=>k.gunzip(e.body.raw,(c,h)=>s(h)))),r.body.parse)try{JSON.parse(e.body.raw.toString())}catch(s){e.body.parsed=e.body.raw.toString()}else e.body.parsed=e.body.raw.toString();let n={headers:new T(f.headers,decodeURIComponent),cookies:new T(L,decodeURIComponent),params:new T(y,decodeURIComponent),queries:new T(ee.parse(e.url.query),decodeURIComponent),client:{userAgent:f.headers["user-agent"],httpVersion:f.httpVersion,port:f.socket.remotePort,ip:l},body:e.body.parsed,url:e.url,rawServer:S,rawReq:f,rawRes:u,"@":{},setHeader(s,c){return u.setHeader(s,c),n},setCustom(s,c){return n["@"][s]=c,n},print(s,c){var p;let h=(p=c==null?void 0:c.niceJSON)!=null?p:!1;switch(typeof s){case"object":u.setHeader("Content-Type","application/json"),h?e.content=Buffer.from(JSON.stringify(s,void 0,1)):e.content=Buffer.from(JSON.stringify(s));break;case"string":e.content=Buffer.from(s);break;case"symbol":e.content=Buffer.from(s.toString());break;case"bigint":case"number":case"boolean":e.content=Buffer.from(String(s));break;case"function":e.waiting=!0,(async()=>{let g=await s();if(typeof g!="function")n.print(g,{niceJSON:h});else return n.error=new Error("Cant return functions from functions, consider using async/await"),m("error",n,e);let R=e.content;e.content=R,e.events.emit("noWaiting")})();break;case"undefined":e.content=Buffer.from("");break}return n},status(s){return u.statusCode=s,n},printFile(s,c){var O,V;let h=(O=c==null?void 0:c.addTypes)!=null?O:!0,p=(V=c==null?void 0:c.cache)!=null?V:!1;if(h&&(s.endsWith(".pdf")&&n.setHeader("Content-Type","application/pdf"),s.endsWith(".js")&&n.setHeader("Content-Type","text/javascript"),s.endsWith(".html")&&n.setHeader("Content-Type","text/html"),s.endsWith(".css")&&n.setHeader("Content-Type","text/css"),s.endsWith(".csv")&&n.setHeader("Content-Type","text/csv"),s.endsWith(".mpeg")&&n.setHeader("Content-Type","video/mpeg"),s.endsWith(".mp4")&&n.setHeader("Content-Type","video/mp4"),s.endsWith(".webm")&&n.setHeader("Content-Type","video/webm"),s.endsWith(".bmp")&&n.setHeader("Content-Type","image/bmp")),d.has(`file::${s}`))return o.data.outgoing.total+=d.get(`file::${s}`).byteLength,o.data.outgoing[e.previousHours[4]]+=d.get(`file::${s}`).byteLength,e.content=d.get(`file::${s}`),n;if(d.has(`file::gzip::${s}`))return o.data.outgoing.total+=d.get(`file::gzip::${s}`).byteLength,o.data.outgoing[e.previousHours[4]]+=d.get(`file::gzip::${s}`).byteLength,e.content=d.get(`file::gzip::${s}`),n;let g,R=!1;if(r.compress&&n.headers.has("accept-encoding")&&n.headers.get("accept-encoding").includes("gzip")){n.rawRes.setHeader("Content-Encoding","gzip"),n.rawRes.setHeader("Vary","Accept-Encoding");let v=k.createGzip();try{g=C.createReadStream(s),e.waiting=!0,g.pipe(v),v.pipe(u)}catch(E){R=!0,n.error=E,m("error",n,e)}v.on("data",E=>{var U;o.data.outgoing.total+=E.byteLength,o.data.outgoing[e.previousHours[4]]+=E.byteLength;let $=(U=d.get(`file::gzip::${s}`))!=null?U:Buffer.from("");p&&d.set(`file::gzip::${s}`,Buffer.concat([$,E]))}),v.once("end",()=>{e.events.emit("noWaiting"),e.content=Buffer.from("")}),u.once("close",()=>{g.close(),v.close()})}else{try{g=C.createReadStream(s),e.waiting=!0,g.pipe(u)}catch(v){R=!0,n.error=v,m("error",n,e)}g.on("data",v=>{var $;o.data.outgoing.total+=v.byteLength,o.data.outgoing[e.previousHours[4]]+=v.byteLength;let E=($=d.get(`file::${s}`))!=null?$:Buffer.from("");p&&d.set(`file::${s}`,Buffer.concat([E,v]))}),g.once("end",()=>{e.events.emit("noWaiting"),e.content=Buffer.from("")}),u.once("close",()=>{g.close()})}return n}},P=!1;if(e.execute.dashboard||(P=await m("request",n,e)),!P){if(r.rateLimits.enabled){for(let s of r.rateLimits.list)if(e.url.pathname.startsWith(s.path)&&(u.setHeader("X-RateLimit-Limit",s.times),u.setHeader("X-RateLimit-Remaining",s.times-((q=await r.rateLimits.functions.get(l+s.path))!=null?q:0)),u.setHeader("X-RateLimit-Reset-Every",s.timeout),await r.rateLimits.functions.set(l+s.path,((F=await r.rateLimits.functions.get(l+s.path))!=null?F:0)+1),setTimeout(async()=>{var c;await r.rateLimits.functions.set(l+s.path,((c=await r.rateLimits.functions.get(l+s.path))!=null?c:0)-1)},s.timeout),await r.rateLimits.functions.get(l+s.path)>s.times))return u.statusCode=429,P=!0,n.print(r.rateLimits.message),H(n,e)}if(r.dashboard.enabled&&!e.execute.dashboard&&(o.requests.total++,o.requests[e.previousHours[4]]++),!await new Promise(s=>{if(!e.waiting)return s(!1);e.events.once("noWaiting",()=>s(!1)),e.events.once("endRequest",()=>s(!0))}))if(e.execute.exists&&!P){if(!e.execute.static)await Promise.resolve(e.execute.route.code(n)).catch(s=>{n.error=s,P=!0,m("error",n,e)});else if(e.execute.route.data.addTypes&&(e.execute.route.path.endsWith(".pdf")&&n.setHeader("Content-Type","application/pdf"),e.execute.route.path.endsWith(".js")&&n.setHeader("Content-Type","text/javascript"),e.execute.route.path.endsWith(".html")&&n.setHeader("Content-Type","text/html"),e.execute.route.path.endsWith(".css")&&n.setHeader("Content-Type","text/css"),e.execute.route.path.endsWith(".csv")&&n.setHeader("Content-Type","text/csv"),e.execute.route.path.endsWith(".mpeg")&&n.setHeader("Content-Type","video/mpeg"),e.execute.route.path.endsWith(".mp4")&&n.setHeader("Content-Type","video/mp4"),e.execute.route.path.endsWith(".webm")&&n.setHeader("Content-Type","video/webm"),e.execute.route.path.endsWith(".bmp")&&n.setHeader("Content-Type","image/bmp")),"content"in e.execute.route.data)o.data.outgoing.total+=e.execute.route.data.content.byteLength,o.data.outgoing[e.previousHours[4]]+=e.execute.route.data.content.byteLength,e.content=e.execute.route.data.content;else{let s=te.resolve(e.execute.route.data.file),c,h=!1;if(r.compress&&n.headers.has("accept-encoding")&&n.headers.get("accept-encoding").includes("gzip")){n.rawRes.setHeader("Content-Encoding","gzip"),n.rawRes.setHeader("Vary","Accept-Encoding");let p=k.createGzip();try{c=C.createReadStream(s),e.waiting=!0,c.pipe(p),p.pipe(u)}catch(g){h=!0,n.error=g,m("error",n,e)}p.on("data",g=>{o.data.outgoing.total+=g.byteLength,o.data.outgoing[e.previousHours[4]]+=g.byteLength}),p.once("end",()=>{e.events.emit("noWaiting"),e.content=Buffer.from("")}),u.once("close",()=>{c.close(),p.close()})}else{try{c=C.createReadStream(s),e.waiting=!0,c.pipe(u)}catch(p){h=!0,n.error=p,m("error",n,e)}c.on("data",p=>{o.data.outgoing.total+=p.byteLength,o.data.outgoing[e.previousHours[4]]+=p.byteLength}),c.once("end",()=>{e.events.emit("noWaiting"),e.content=Buffer.from("")}),u.once("close",()=>{c.close()})}if(h)return n}await new Promise(s=>{if(!e.waiting)return s(!0);e.events.once("noWaiting",()=>s(!1))}),e.content?(o.data.outgoing.total+=e.content.byteLength,o.data.outgoing[e.previousHours[4]]+=e.content.byteLength,H(n,e)):u.end()}else m("notfound",n,e),await new Promise(s=>{if(!e.waiting)return s(!0);e.events.once("noWaiting",()=>s(!1))}),e.content?(o.data.outgoing.total+=e.content.byteLength,o.data.outgoing[e.previousHours[4]]+=e.content.byteLength,H(n,e)):u.end()}}),r.body.enabled||e.events.emit("startRequest")});return S.listen(r.port,r.bind),new Promise((f,u)=>{S.once("listening",()=>f({success:!0,port:r.port,message:"WEBSERVER STARTED",rawServer:S})),S.once("error",e=>{S.close(),u({success:!1,error:e,message:"WEBSERVER ERRORED"})})})}};
