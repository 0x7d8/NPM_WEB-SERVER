var ce=Object.create;var J=Object.defineProperty;var pe=Object.getOwnPropertyDescriptor;var me=Object.getOwnPropertyNames;var de=Object.getPrototypeOf,fe=Object.prototype.hasOwnProperty;var he=(s,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let p of me(e))!fe.call(s,p)&&p!==r&&J(s,p,{get:()=>e[p],enumerable:!(n=pe(e,p))||n.enumerable});return s};var C=(s,e,r)=>(r=s!=null?ce(de(s)):{},he(e||!s||!s.__esModule?J(r,"default",{value:s,enumerable:!0}):r,s));var O=C(require("fs")),z=(s,e)=>(e=e||[],O.readdirSync(s).forEach(n=>{if(O.statSync(`${s}/${n}`).isDirectory())e=z(`${s}/${n}`,e);else{let p=`${s}/${n}`;e.push(p)}}),e),X=(s,e,r)=>(r=r||[],r=z(s,r).filter(n=>n.endsWith(e)),r);var L=["OPTIONS","DELETE","PATCH","STATIC","HEAD","POST","PUT","GET"];var _=C(require("path")),Q=C(require("fs")),b=(s,e)=>(s=s.replace(/\/{2,}/g,"/"),s.endsWith("/")&&s!=="/"?s.slice(0,-1):!s.startsWith("/")&&s!=="/"?`/${s}`:s.includes("/?")?s.replace("/?","?"):e&&s==="/"?"":s),B=class{constructor(e,r){e=e!=null?e:[],r=r!=null?r:[],this.routes=e,this.events=r}event(e,r){return this.events.some(n=>n.event===e)?!1:this.events.push({event:e,code:r})-1}set(e,r,n){if(r=b(r),!L.includes(e))throw TypeError(`No Valid Request Type: ${e}, Possible Values: ${L.join(", ")}`);return this.routes.some(p=>p.method===e&&p.path===r)?!1:this.routes.push({method:e,path:r,pathArray:r.split("/"),code:n,data:{addTypes:!1}})-1}setBlock(e,r){e=b(e);let n=[];for(let p=0;p<=r.length-1;p++){let d=r[p];n.push(this.routes.push({method:d.method,path:`${e}${b(d.path,!0)}`,pathArray:`${e}${b(d.path,!0)}`.split("/"),code:d.code,data:{addTypes:!1}})-1)}return n}setRedirects(e){let r=[];for(let n=0;n<=e.length-1;n++){let p=e[n];r.push(this.routes.push({method:p.method,path:b(p.path),pathArray:b(p.path,!0).split("/"),code:async d=>d.redirect(p.destination),data:{addTypes:!1}})-1)}return r}static(e,r,n){var c,i,t;e=b(e);let p=(c=n==null?void 0:n.preload)!=null?c:!1,d=(i=n==null?void 0:n.remHTML)!=null?i:!1,T=(t=n==null?void 0:n.addTypes)!=null?t:!0,g=[];for(let l of z(r)){let y=l.replace(r,"");d&&(y=y.replace("/index.html","/").replace(".html",""));let f=b(y),H=this.routes.push({method:"STATIC",path:f,pathArray:f.split("/"),code:async()=>{},data:{addTypes:T,file:l}});p&&(this.routes[H-1].data.content=Q.readFileSync(l)),g.push(H-1)}return g}load(e){let r=X(e,".js"),n=[];for(let p of r){let d=require(_.resolve(p));if(!(!("path"in d)||!("method"in d)||!("code"in d))){if(!L.includes(d.method))throw TypeError(`No Valid Request Type: ${d.method}, Possible Values: ${L.join(", ")}`);n.push(this.routes.push({method:d.method,path:b(d.path),pathArray:b(d.path).split("/"),code:d.code,data:{addTypes:!1}})-1)}}return n}list(){return{routes:this.routes,events:this.events}}};var x=class{constructor(e){this.data=this.mergeOptions({routes:new B,rateLimits:{enabled:!1,message:"Rate Limited",list:[],functions:new Map},body:{enabled:!0,parse:!0,maxSize:5,message:"Payload too large"},https:{enabled:!1,keyFile:"/ssl/key/path",certFile:"/ssl/cert/path"},dashboard:{enabled:!1,path:"/rjweb-dashboard"},headers:{},bind:"0.0.0.0",proxy:!1,compression:"none",cors:!1,port:2023,poweredBy:!0},e)}mergeOptions(...e){let r=n=>n&&typeof n=="object";return e.reduce((n,p)=>(Object.keys(p).forEach(d=>{let T=n[d],g=p[d];d!=="functions"&&d!=="routes"?Array.isArray(T)&&Array.isArray(g)?n[d]=T.concat(...g):r(T)&&r(g)?n[d]=this.mergeOptions(T,g):n[d]=g:n[d]=g}),n),{})}getOptions(){return this.data}};var w=class{constructor(e,r){this.data={};e=e!=null?e:{},r=r!=null?r:n=>n;for(let n in e)this.data[n]=r(e[n])}has(e){return e in this.data}get(e){return this.data[e]}set(e,r){let n=e in this.data;return this.data[e]=r,n}objectCount(){return Object.keys(this.data).length}clear(e){e=e!=null?e:[];let r=0;for(let n in this.data)e.includes(n)||(delete this.data[n],r++);return r}toJSON(e){e=e!=null?e:[];let r={};for(let n in this.data)e.includes(n)||(r[n]=this.data[n]);return r}toArray(e){e=e!=null?e:[];let r=[];for(let n in this.data)e.includes(n)||r.push(this.data[n]);return r}forEach(e,r){e=e!=null?e:()=>{},r=r!=null?r:[];let n=0;for(let p in this.data)r.includes(p)||(e(p,this.data[p]),n++);return n}};var Y=(c=>(c.options="OPTIONS",c.delete="DELETE",c.patch="PATCH",c.post="POST",c.head="HEAD",c.put="PUT",c.get="GET",c.static="STATIC",c))(Y||{}),Z=Y;var ee=require("stream"),P=C(require("zlib")),$={gzip:"gzip",brotli:"br",deflate:"deflate",none:"none"},G=class extends ee.PassThrough{};function I(s){switch(s){case"gzip":return P.createGzip();case"brotli":return P.createBrotliCompress();case"deflate":return P.createDeflate();default:return new G}}function D(s,e,r){if(!e.compressed&&!s.rawRes.headersSent&&String(s.headers.get("accept-encoding")).includes($[r.compression])){s.rawRes.setHeader("Content-Encoding",$[r.compression]),s.rawRes.setHeader("Vary","Accept-Encoding");let n=I(r.compression);n.pipe(s.rawRes),n.end(e.content,"binary")}else s.rawRes.end(e.content,"binary")}var q=class{constructor(e,r,n){this.globalContext=e,this.optionsCache={},this.server=r,this.options=n,this.globalContext.controller=this}setRoutes(e){let{routes:r,events:n}=e.list();return this.optionsCache.normal=r,this.optionsCache.event=n,this}setOptions(e){return this.options=new x(e).getOptions(),this}start(){return this.globalContext.routes.normal=this.optionsCache.normal,this.globalContext.routes.event=this.optionsCache.event,this.server.listen(this.options.port,this.options.bind),new Promise((e,r)=>{this.server.once("listening",()=>e({success:!0,port:this.options.port,message:"WEBSERVER STARTED"})),this.server.once("error",n=>{this.server.close(),r({success:!1,error:n,message:"WEBSERVER ERRORED"})})})}async reload(){return this.globalContext.pageDisplay="",this.globalContext.cache.files.clear(),this.globalContext.cache.routes.clear(),this.globalContext.routes.normal=this.optionsCache.normal,this.globalContext.routes.event=this.optionsCache.event,this.globalContext.data={incoming:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},outgoing:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}},this.globalContext.requests={total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},await this.stop(),await this.start(),this}stop(){return this.server.close(),this.globalContext.pageDisplay="",this.globalContext.cache.files.clear(),this.globalContext.cache.routes.clear(),this.globalContext.routes.normal=this.optionsCache.normal,this.globalContext.routes.event=this.optionsCache.event,this.globalContext.data={incoming:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},outgoing:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}},this.globalContext.requests={total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},new Promise((e,r)=>{this.server.once("close",()=>e({success:!0,message:"WEBSERVER CLOSED"})),this.server.once("error",n=>{this.server.close(),r({success:!1,error:n,message:"WEBSERVER CLOSING ERRORED"})})})}};var se=require("stream");var te=C(require("fs/promises")),re=C(require("os")),le=re.cpus().length;async function F(s,e,r,n,p){switch(s.url.path.replace(b(n.dashboard.path,!1),"")||"/"){case"/":let T=(await te.readFile(`${__dirname}/stats/index.html`,"utf8")).replaceAll("/rjweb-dashboard",b(n.dashboard.path));return s.print(T);case"/stats":let g=new Date,c=g.getTime(),i=process.cpuUsage(),t=await new Promise(l=>setTimeout(()=>{let y=process.cpuUsage(i),H=(new Date().getTime()-c)*5*le;l((y.system+y.user)/H)},500));return s.print({requests:[e.requests.total,{hour:r.previousHours[0],amount:e.requests[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.requests[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.requests[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.requests[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.requests[r.previousHours[4]]}],data:{incoming:[e.data.incoming.total,{hour:r.previousHours[0],amount:e.data.incoming[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.data.incoming[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.data.incoming[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.data.incoming[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.data.incoming[r.previousHours[4]]}],outgoing:[e.data.outgoing.total,{hour:r.previousHours[0],amount:e.data.outgoing[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.data.outgoing[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.data.outgoing[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.data.outgoing[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.data.outgoing[r.previousHours[4]]}]},cpu:{time:`${g.getHours()}:${g.getMinutes()}:${g.getSeconds()}`,usage:t.toFixed(2)},memory:{time:`${g.getHours()}:${g.getMinutes()}:${g.getSeconds()}`,usage:(process.memoryUsage().heapUsed/1e3/1e3).toFixed(2)},routes:p,cached:e.cache.files.objectCount()+e.cache.routes.objectCount()})}}var ge=C(require("http")),ye=C(require("https")),oe=C(require("querystring")),ne=C(require("zlib")),ae=C(require("path")),ie=C(require("url")),A=C(require("fs"));module.exports={routeList:B,serverOptions:x,valueCollection:w,types:Z,initialize(s){s=new x(s).getOptions();let e={controller:null,requests:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},pageDisplay:"",data:{incoming:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},outgoing:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}},routes:{normal:[],event:[]},cache:{files:new w,routes:new w}},r=async(c,i,t)=>{switch(c){case"error":{let l=e.routes.event.find(y=>y.event==="error");l?Promise.resolve(l.code(i)).catch(y=>{console.log(y),i.status(500),t.content=Buffer.from(`An Error occured in your Error Event (what the hell?)
${y.stack}`)}):(console.log(i.error),i.status(500),t.content=Buffer.from(`An Error occured
${i.error.stack}`))}case"request":{let l=!1,y=e.routes.event.find(f=>f.event==="request");return y&&await Promise.resolve(y.code(i)).catch(f=>{l=!0,console.log(f),i.status(500),t.content=Buffer.from(`An Error occured in your Request Event
${f.stack}`)}),l}case"notfound":{let l=!1,y=e.routes.event.find(f=>f.event==="notfound");if(y)await Promise.resolve(y.code(i)).catch(f=>{l=!0,console.log(f),i.status(500),t.content=Buffer.from(`An Error occured in your Notfound Event
${f.stack}`)});else{let f="";if(e.pageDisplay)f=e.pageDisplay;else{for(let H of e.routes.normal){let u=H.method==="STATIC"?"GET":H.method;f+=`[-] [${u}] ${H.path}
`}e.pageDisplay=f}i.status(404),t.content=Buffer.from(`[!] COULDNT FIND [${i.url.method}]: ${i.url.pathname.toUpperCase()}
[i] AVAILABLE PAGES:

${f}`)}return l}}},n=()=>Array.from({length:5},(c,i)=>(new Date().getHours()-(4-i)+24)%24);setInterval(()=>{let c=n();e.requests[c[0]-1]=0,e.data.incoming[c[0]-1]=0,e.data.outgoing[c[0]-1]=0},3e5);let p={},d,T;if(s.https.enabled){try{d=A.readFileSync(s.https.keyFile),T=A.readFileSync(s.https.certFile)}catch(c){throw new Error(`Cant access your HTTPS Key or Cert file! (${s.https.keyFile} / ${s.https.certFile})`)}p={key:d,cert:T}}let g=(s.https.enabled?ye:ge).createServer(p,async(c,i)=>{let t={content:Buffer.from(""),compressed:!1,events:new se.EventEmitter,waiting:!1,continue:!0,execute:{route:null,static:!1,exists:!1,dashboard:!1},body:{raw:Buffer.from(""),parsed:""},url:{...ie.parse(b(c.url)),method:c.method},previousHours:n()};t.events.on("noWaiting",()=>t.waiting=!1),i.once("close",()=>t.events.emit("endRequest")),s.body.enabled&&c.on("data",l=>{if(t.body.raw=Buffer.concat([t.body.raw,Buffer.from(l)]),t.body.raw.byteLength>=s.body.maxSize*1e6){switch(i.statusCode=413,t.continue=!1,typeof s.body.message){case"object":i.setHeader("Content-Type","application/json"),t.content=Buffer.from(JSON.stringify(s.body.message));break;case"string":t.content=Buffer.from(s.body.message);break;case"symbol":t.content=Buffer.from(s.body.message.toString());break;case"bigint":case"number":case"boolean":t.content=Buffer.from(String(s.body.message));break;case"undefined":t.content=Buffer.from("");break}return D({headers:new w(c.headers,decodeURIComponent),rawRes:i},t,s)}else e.data.incoming.total+=t.body.raw.byteLength,e.data.incoming[t.previousHours[4]]+=t.body.raw.byteLength}).on("end",()=>{t.continue&&t.events.emit("startRequest")}),t.events.once("startRequest",async()=>{var K,M;if(Object.keys(s.headers).forEach(o=>{i.setHeader(o,s.headers[o])}),s.cors&&(i.setHeader("Access-Control-Allow-Headers","*"),i.setHeader("Access-Control-Allow-Origin","*"),i.setHeader("Access-Control-Request-Method","*"),i.setHeader("Access-Control-Allow-Methods",L.join(",")),c.method==="OPTIONS"))return i.end("");let l={},y=t.url.pathname.split("/");for(let o=0;o<=e.routes.normal.length-1;o++){let a=e.routes.normal[o];if(e.cache.routes.has(`route::${t.url.pathname}`)){let h=e.cache.routes.get(`route::${t.url.pathname}`);l=h.params,t.execute.route=h.route,t.execute.static=h.route.method==="STATIC",t.execute.exists=!0;break}if(s.dashboard.enabled&&(t.url.pathname===b(s.dashboard.path)||t.url.pathname===b(s.dashboard.path)+"/stats")){t.execute.route={method:"GET",path:a.path,pathArray:a.path.split("/"),code:async h=>await F(h,e,t,s,e.routes.normal.length),data:{addTypes:!1}},t.execute.static=!1,t.execute.exists=!0,t.execute.dashboard=!0;break}if(!(a.method!=="STATIC"&&a.method!==c.method)&&!(a.method==="STATIC"&&c.method!=="GET")&&a.pathArray.length===y.length){if(t.execute.exists)break;if(a.path===t.url.pathname&&a.method===c.method){t.execute.route=a,t.execute.exists=!0,e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:{}});break}if(a.path===t.url.pathname&&a.method==="STATIC"){t.execute.route=a,t.execute.static=!0,t.execute.exists=!0,e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:{}});break}for(let h=0;h<=a.pathArray.length-1;h++){let m=a.pathArray[h],v=y[h];if(!/^:.*:$/.test(m)&&v!==m)break;if(m===v)continue;if(/^:.*:$/.test(m)){l[m.substring(1,m.length-1)]=v,t.execute.route=a,t.execute.exists=!0;continue}}if(t.execute.exists){e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:l});break}}}s.poweredBy&&i.setHeader("X-Powered-By","rjweb-server");let f;s.proxy&&c.headers["x-forwarded-for"]?f=c.headers["x-forwarded-for"]:f=c.socket.remoteAddress;let H={};if(c.headers.cookie&&c.headers.cookie.split(";").forEach(o=>{let a=o.split("=");H[a.shift().trim()]=a.join("=")}),c.headers["content-encoding"]==="gzip"&&(t.body.raw=await new Promise(o=>ne.gunzip(t.body.raw,(a,h)=>{o(a?t.body.raw:h)}))),s.body.parse)try{JSON.parse(t.body.raw.toString())}catch(o){t.body.parsed=t.body.raw.toString()}else t.body.parsed=t.body.raw.toString();let u={controller:e.controller,headers:new w(c.headers,decodeURIComponent),cookies:new w(H,decodeURIComponent),params:new w(l,decodeURIComponent),queries:new w(oe.parse(t.url.query),decodeURIComponent),client:{userAgent:c.headers["user-agent"],httpVersion:c.httpVersion,port:c.socket.remotePort,ip:f},body:t.body.parsed,url:t.url,rawServer:g,rawReq:c,rawRes:i,"@":{},setHeader(o,a){return i.setHeader(o,a),u},setCustom(o,a){return u["@"][o]=a,u},redirect(o,a){return i.statusCode=a!=null?a:302,i.setHeader("Location",o),u},print(o,a){var S,k,j;let h=(S=a==null?void 0:a.niceJSON)!=null?S:!1,m=(k=a==null?void 0:a.contentType)!=null?k:"",v=(j=a==null?void 0:a.returnFunctions)!=null?j:!1;switch(typeof o){case"object":i.setHeader("Content-Type","application/json"),h?t.content=Buffer.from(JSON.stringify(o,void 0,1)):t.content=Buffer.from(JSON.stringify(o));break;case"string":m&&i.setHeader("Content-Type",m),t.content=Buffer.from(o);break;case"symbol":m&&i.setHeader("Content-Type",m),t.content=Buffer.from(o.toString());break;case"bigint":case"number":case"boolean":m&&i.setHeader("Content-Type",m),t.content=Buffer.from(String(o));break;case"function":t.waiting=!0,(async()=>{let W=await o();if(typeof W!="function")u.print(W,{niceJSON:h,contentType:m});else if(v)u.print(W,{niceJSON:h,contentType:m,returnFunctions:v});else return u.error=new Error("Cant return functions from functions, consider using async/await"),r("error",u,t);let N=t.content;t.content=N,t.events.emit("noWaiting")})();break;case"undefined":m&&i.setHeader("Content-Type",m),t.content=Buffer.from("");break}return u},status(o){return i.statusCode=o!=null?o:200,u},printFile(o,a){var j,W,N;let h=(j=a==null?void 0:a.addTypes)!=null?j:!0,m=(W=a==null?void 0:a.contentType)!=null?W:"",v=(N=a==null?void 0:a.cache)!=null?N:!1;h&&!m?(o.endsWith(".pdf")&&u.setHeader("Content-Type","application/pdf"),o.endsWith(".js")&&u.setHeader("Content-Type","text/javascript"),o.endsWith(".html")&&u.setHeader("Content-Type","text/html"),o.endsWith(".css")&&u.setHeader("Content-Type","text/css"),o.endsWith(".csv")&&u.setHeader("Content-Type","text/csv"),o.endsWith(".mpeg")&&u.setHeader("Content-Type","video/mpeg"),o.endsWith(".mp4")&&u.setHeader("Content-Type","video/mp4"),o.endsWith(".webm")&&u.setHeader("Content-Type","video/webm"),o.endsWith(".bmp")&&u.setHeader("Content-Type","image/bmp")):m&&i.setHeader("Content-Type",m);let S,k=!1;if(u.headers.get("accept-encoding").includes($[s.compression])){if(u.rawRes.setHeader("Content-Encoding",$[s.compression]),u.rawRes.setHeader("Vary","Accept-Encoding"),t.continue=!1,e.cache.files.has(`file::${o}`))return e.data.outgoing.total+=e.cache.files.get(`file::${o}`).byteLength,e.data.outgoing[t.previousHours[4]]+=e.cache.files.get(`file::${o}`).byteLength,t.content=e.cache.files.get(`file::${o}`),t.continue=!0,u;if(e.cache.files.has(`file::${s.compression}::${o}`))return t.compressed=!0,e.data.outgoing.total+=e.cache.files.get(`file::${s.compression}::${o}`).byteLength,e.data.outgoing[t.previousHours[4]]+=e.cache.files.get(`file::${s.compression}::${o}`).byteLength,t.content=e.cache.files.get(`file::${s.compression}::${o}`),t.continue=!0,u;let E=I(s.compression);try{S=A.createReadStream(o),t.waiting=!0,S.pipe(E),E.pipe(i)}catch(R){k=!0,u.error=R,r("error",u,t)}if(k)return;E.on("data",R=>{var U;if(e.data.outgoing.total+=R.byteLength,e.data.outgoing[t.previousHours[4]]+=R.byteLength,v){let ue=(U=e.cache.files.get(`file::${s.compression}::${o}`))!=null?U:Buffer.from("");e.cache.files.set(`file::${s.compression}::${o}`,Buffer.concat([ue,R]))}}),E.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>{S.close(),E.close()})}else{try{S=A.createReadStream(o),t.waiting=!0,S.pipe(i)}catch(E){k=!0,u.error=E,r("error",u,t)}S.on("data",E=>{var R;if(e.data.outgoing.total+=E.byteLength,e.data.outgoing[t.previousHours[4]]+=E.byteLength,v){let U=(R=e.cache.files.get(`file::${s.compression}::${o}`))!=null?R:Buffer.from("");e.cache.files.set(`file::${s.compression}::${o}`,Buffer.concat([U,E]))}}),S.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>S.close())}return u}},V=!1;if(t.execute.dashboard||(V=await r("request",u,t)),!V){if(s.rateLimits.enabled){for(let o of s.rateLimits.list)if(t.url.pathname.startsWith(o.path)&&(i.setHeader("X-RateLimit-Limit",o.times),i.setHeader("X-RateLimit-Remaining",o.times-((K=await s.rateLimits.functions.get(f+o.path))!=null?K:0)),i.setHeader("X-RateLimit-Reset-Every",o.timeout),await s.rateLimits.functions.set(f+o.path,((M=await s.rateLimits.functions.get(f+o.path))!=null?M:0)+1),setTimeout(async()=>{var a;await s.rateLimits.functions.set(f+o.path,((a=await s.rateLimits.functions.get(f+o.path))!=null?a:0)-1)},o.timeout),await s.rateLimits.functions.get(f+o.path)>o.times))return i.statusCode=429,V=!0,u.print(s.rateLimits.message),D(u,t,s)}if(s.dashboard.enabled&&!t.execute.dashboard&&(e.requests.total++,e.requests[t.previousHours[4]]++),!await new Promise(o=>{if(!t.waiting)return o(!1);t.events.once("noWaiting",()=>o(!1)),t.events.once("endRequest",()=>o(!0))}))if(t.execute.exists&&!V){if(!t.execute.static)await Promise.resolve(t.execute.route.code(u)).catch(o=>{u.error=o,V=!0,r("error",u,t)});else if(t.execute.route.data.addTypes&&(t.execute.route.path.endsWith(".pdf")&&u.setHeader("Content-Type","application/pdf"),t.execute.route.path.endsWith(".js")&&u.setHeader("Content-Type","text/javascript"),t.execute.route.path.endsWith(".html")&&u.setHeader("Content-Type","text/html"),t.execute.route.path.endsWith(".css")&&u.setHeader("Content-Type","text/css"),t.execute.route.path.endsWith(".csv")&&u.setHeader("Content-Type","text/csv"),t.execute.route.path.endsWith(".mpeg")&&u.setHeader("Content-Type","video/mpeg"),t.execute.route.path.endsWith(".mp4")&&u.setHeader("Content-Type","video/mp4"),t.execute.route.path.endsWith(".webm")&&u.setHeader("Content-Type","video/webm"),t.execute.route.path.endsWith(".bmp")&&u.setHeader("Content-Type","image/bmp")),t.continue=!1,"content"in t.execute.route.data)e.data.outgoing.total+=t.execute.route.data.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.execute.route.data.content.byteLength,t.content=t.execute.route.data.content;else{let o=ae.resolve(t.execute.route.data.file),a,h=!1;if(s.compression&&String(u.headers.get("accept-encoding")).includes($[s.compression])){u.rawRes.setHeader("Content-Encoding",$[s.compression]),u.rawRes.setHeader("Vary","Accept-Encoding");let m=I(s.compression);try{a=A.createReadStream(o),t.waiting=!0,a.pipe(m),m.pipe(i)}catch(v){h=!0,u.error=v,r("error",u,t)}if(h)return;m.on("data",v=>{e.data.outgoing.total+=v.byteLength,e.data.outgoing[t.previousHours[4]]+=v.byteLength}),m.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>{a.close(),m.close()})}else{try{a=A.createReadStream(o),t.waiting=!0,a.pipe(i)}catch(m){h=!0,u.error=m,r("error",u,t)}a.on("data",m=>{e.data.outgoing.total+=m.byteLength,e.data.outgoing[t.previousHours[4]]+=m.byteLength}),a.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>a.close())}}await new Promise(o=>{if(!t.waiting)return o(!0);t.events.once("noWaiting",()=>o(!1))}),t.content&&t.continue?(e.data.outgoing.total+=t.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.content.byteLength,D(u,t,s)):i.end()}else r("notfound",u,t),await new Promise(o=>{if(!t.waiting)return o(!0);t.events.once("noWaiting",()=>o(!1))}),t.content&&t.continue?(e.data.outgoing.total+=t.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.content.byteLength,D(u,t,s)):i.end()}}),s.body.enabled||t.events.emit("startRequest")});return e.controller=new q(e,g,s),e.controller}};
