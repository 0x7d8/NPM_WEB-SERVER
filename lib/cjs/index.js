var ce=Object.create;var J=Object.defineProperty;var pe=Object.getOwnPropertyDescriptor;var me=Object.getOwnPropertyNames;var de=Object.getPrototypeOf,fe=Object.prototype.hasOwnProperty;var he=(s,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let c of me(e))!fe.call(s,c)&&c!==r&&J(s,c,{get:()=>e[c],enumerable:!(n=pe(e,c))||n.enumerable});return s};var C=(s,e,r)=>(r=s!=null?ce(de(s)):{},he(e||!s||!s.__esModule?J(r,"default",{value:s,enumerable:!0}):r,s));var O=C(require("fs")),z=(s,e)=>(e=e||[],O.readdirSync(s).forEach(n=>{if(O.statSync(`${s}/${n}`).isDirectory())e=z(`${s}/${n}`,e);else{let c=`${s}/${n}`;e.push(c)}}),e),X=(s,e,r)=>(r=r||[],r=z(s,r).filter(n=>n.endsWith(e)),r);var A=["OPTIONS","DELETE","PATCH","STATIC","POST","PUT","GET"];var _=C(require("path")),Q=C(require("fs")),b=(s,e)=>(s=s.replace(/\/{2,}/g,"/"),s.endsWith("/")&&s!=="/"?s.slice(0,-1):!s.startsWith("/")&&s!=="/"?`/${s}`:s.includes("/?")?s.replace("/?","?"):e&&s==="/"?"":s),B=class{constructor(e,r){e=e!=null?e:[],r=r!=null?r:[],this.routes=e,this.events=r}event(e,r){return this.events.some(n=>n.event===e)?!1:this.events.push({event:e,code:r})-1}set(e,r,n){if(r=b(r),!A.includes(e))throw TypeError(`No Valid Request Type: ${e}, Possible Values: ${A.join(", ")}`);return this.routes.some(c=>c.method===e&&c.path===r)?!1:this.routes.push({method:e,path:r,pathArray:r.split("/"),code:n,data:{addTypes:!1}})-1}setBlock(e,r){e=b(e);let n=[];for(let c=0;c<=r.length-1;c++){let d=r[c];n.push(this.routes.push({method:d.method,path:`${e}${b(d.path,!0)}`,pathArray:`${e}${b(d.path,!0)}`.split("/"),code:d.code,data:{addTypes:!1}})-1)}return n}setRedirects(e){let r=[];for(let n=0;n<=e.length-1;n++){let c=e[n];r.push(this.routes.push({method:c.method,path:b(c.path),pathArray:b(c.path,!0).split("/"),code:async d=>d.redirect(c.destination),data:{addTypes:!1}})-1)}return r}static(e,r,n){var p,i,t;e=b(e);let c=(p=n==null?void 0:n.preload)!=null?p:!1,d=(i=n==null?void 0:n.remHTML)!=null?i:!1,T=(t=n==null?void 0:n.addTypes)!=null?t:!0,f=[];for(let g of z(r)){let y=g.replace(r,"");d&&(y=y.replace("/index.html","/").replace(".html",""));let h=b(y),H=this.routes.push({method:"STATIC",path:h,pathArray:h.split("/"),code:async()=>{},data:{addTypes:T,file:g}});c&&(this.routes[H-1].data.content=Q.readFileSync(g)),f.push(H-1)}return f}load(e){let r=X(e,".js"),n=[];for(let c of r){let d=require(_.resolve(c));if(!(!("path"in d)||!("method"in d)||!("code"in d))){if(!A.includes(d.method))throw TypeError(`No Valid Request Type: ${d.method}, Possible Values: ${A.join(", ")}`);n.push(this.routes.push({method:d.method,path:b(d.path),pathArray:b(d.path).split("/"),code:d.code,data:{addTypes:!1}})-1)}}return n}list(){return{routes:this.routes,events:this.events}}};var $=class{constructor(e){this.data=this.mergeOptions({routes:new B,rateLimits:{enabled:!1,message:"Rate Limited",list:[],functions:new Map},body:{enabled:!0,parse:!0,maxSize:5,message:"Payload too large"},https:{enabled:!1,keyFile:"/ssl/key/path",certFile:"/ssl/cert/path"},dashboard:{enabled:!1,path:"/rjweb-dashboard"},headers:{},bind:"0.0.0.0",proxy:!1,compression:"none",cors:!1,port:2023,poweredBy:!0},e)}mergeOptions(...e){let r=n=>n&&typeof n=="object";return e.reduce((n,c)=>(Object.keys(c).forEach(d=>{let T=n[d],f=c[d];d!=="functions"&&d!=="routes"?Array.isArray(T)&&Array.isArray(f)?n[d]=T.concat(...f):r(T)&&r(f)?n[d]=this.mergeOptions(T,f):n[d]=f:n[d]=f}),n),{})}getOptions(){return this.data}};var w=class{constructor(e,r){this.data={};e=e!=null?e:{},r=r!=null?r:n=>n;for(let n in e)this.data[n]=r(e[n])}has(e){return e in this.data}get(e){return this.data[e]}set(e,r){let n=e in this.data;return this.data[e]=r,n}objectCount(){return Object.keys(this.data).length}clear(e){e=e!=null?e:[];let r=0;for(let n in this.data)e.includes(n)||(delete this.data[n],r++);return r}toJSON(e){e=e!=null?e:[];let r={};for(let n in this.data)e.includes(n)||(r[n]=this.data[n]);return r}toArray(e){e=e!=null?e:[];let r=[];for(let n in this.data)e.includes(n)||r.push(this.data[n]);return r}forEach(e,r){e=e!=null?e:()=>{},r=r!=null?r:[];let n=0;for(let c in this.data)r.includes(c)||(e(c,this.data[c]),n++);return n}};var Y=(f=>(f.options="OPTIONS",f.delete="DELETE",f.patch="PATCH",f.post="POST",f.put="PUT",f.get="GET",f.static="STATIC",f))(Y||{}),Z=Y;var ee=require("stream"),P=C(require("zlib")),x={none:"none",gzip:"gzip",brotli:"br",deflate:"deflate"},G=class extends ee.PassThrough{};function I(s){switch(s){case"gzip":return P.createGzip();case"brotli":return P.createBrotliCompress();case"deflate":return P.createDeflate();default:return new G}}function V(s,e,r){if(!e.compressed&&!s.rawRes.headersSent&&String(s.headers.get("accept-encoding")).includes(x[r.compression])){s.rawRes.setHeader("Content-Encoding",x[r.compression]),s.rawRes.setHeader("Vary","Accept-Encoding");let n=I(r.compression);n.pipe(s.rawRes),n.end(e.content,"binary")}else s.rawRes.end(e.content,"binary")}var N=class{constructor(e,r,n){this.globalContext=e,this.optionsCache={},this.server=r,this.options=n,this.globalContext.controller=this}setRoutes(e){let{routes:r,events:n}=e.list();return this.optionsCache.normal=r,this.optionsCache.event=n,this}setOptions(e){return this.options=new $(e).getOptions(),this}start(){return this.globalContext.routes.normal=this.optionsCache.normal,this.globalContext.routes.event=this.optionsCache.event,this.server.listen(this.options.port,this.options.bind),new Promise((e,r)=>{this.server.once("listening",()=>e({success:!0,port:this.options.port,message:"WEBSERVER STARTED"})),this.server.once("error",n=>{this.server.close(),r({success:!1,error:n,message:"WEBSERVER ERRORED"})})})}async reload(){return this.globalContext.pageDisplay="",this.globalContext.cache.files.clear(),this.globalContext.cache.routes.clear(),this.globalContext.routes.normal=this.optionsCache.normal,this.globalContext.routes.event=this.optionsCache.event,this.globalContext.data={incoming:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},outgoing:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}},this.globalContext.requests={total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},await this.stop(),await this.start(),this}stop(){return this.server.close(),new Promise((e,r)=>{this.server.once("close",()=>e({success:!0,message:"WEBSERVER CLOSED"})),this.server.once("error",n=>{this.server.close(),r({success:!1,error:n,message:"WEBSERVER CLOSING ERRORED"})})})}};var se=require("stream");var te=C(require("fs/promises")),re=C(require("os")),le=re.cpus().length;async function F(s,e,r,n,c){switch(s.url.path.replace(b(n.dashboard.path,!1),"")||"/"){case"/":let T=(await te.readFile(`${__dirname}/stats/index.html`,"utf8")).replaceAll("/rjweb-dashboard",b(n.dashboard.path));return s.print(T);case"/stats":let f=new Date,p=f.getTime(),i=process.cpuUsage(),t=await new Promise(g=>setTimeout(()=>{let y=process.cpuUsage(i),H=(new Date().getTime()-p)*5*le;g((y.system+y.user)/H)},500));return s.print({requests:[e.requests.total,{hour:r.previousHours[0],amount:e.requests[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.requests[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.requests[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.requests[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.requests[r.previousHours[4]]}],data:{incoming:[e.data.incoming.total,{hour:r.previousHours[0],amount:e.data.incoming[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.data.incoming[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.data.incoming[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.data.incoming[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.data.incoming[r.previousHours[4]]}],outgoing:[e.data.outgoing.total,{hour:r.previousHours[0],amount:e.data.outgoing[r.previousHours[0]]},{hour:r.previousHours[1],amount:e.data.outgoing[r.previousHours[1]]},{hour:r.previousHours[2],amount:e.data.outgoing[r.previousHours[2]]},{hour:r.previousHours[3],amount:e.data.outgoing[r.previousHours[3]]},{hour:r.previousHours[4],amount:e.data.outgoing[r.previousHours[4]]}]},cpu:{time:`${f.getHours()}:${f.getMinutes()}:${f.getSeconds()}`,usage:t.toFixed(2)},memory:{time:`${f.getHours()}:${f.getMinutes()}:${f.getSeconds()}`,usage:(process.memoryUsage().heapUsed/1e3/1e3).toFixed(2)},routes:c,cached:e.cache.files.objectCount()+e.cache.routes.objectCount()})}}var ge=C(require("http")),ye=C(require("https")),oe=C(require("querystring")),ne=C(require("zlib")),ae=C(require("path")),ie=C(require("url")),L=C(require("fs"));module.exports={routeList:B,serverOptions:$,valueCollection:w,types:Z,initialize(s){s=new $(s).getOptions();let e={controller:null,requests:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},pageDisplay:"",data:{incoming:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0},outgoing:{total:0,0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0}},routes:{normal:[],event:[]},cache:{files:new w,routes:new w}},r=async(p,i,t)=>{switch(p){case"error":{let g=e.routes.event.find(y=>y.event==="error");g?Promise.resolve(g.code(i)).catch(y=>{console.log(y),i.status(500),t.content=Buffer.from(`An Error occured in your Error Event (what the hell?)
${y.stack}`)}):(console.log(i.error),i.status(500),t.content=Buffer.from(`An Error occured
${i.error.stack}`))}case"request":{let g=!1,y=e.routes.event.find(h=>h.event==="request");return y&&await Promise.resolve(y.code(i)).catch(h=>{g=!0,console.log(h),i.status(500),t.content=Buffer.from(`An Error occured in your Request Event
${h.stack}`)}),g}case"notfound":{let g=!1,y=e.routes.event.find(h=>h.event==="notfound");if(y)await Promise.resolve(y.code(i)).catch(h=>{g=!0,console.log(h),i.status(500),t.content=Buffer.from(`An Error occured in your Notfound Event
${h.stack}`)});else{let h="";if(e.pageDisplay)h=e.pageDisplay;else{for(let H of e.routes.normal){let u=H.method==="STATIC"?"GET":H.method;h+=`[-] [${u}] ${H.path}
`}e.pageDisplay=h}i.status(404),t.content=Buffer.from(`[!] COULDNT FIND [${i.url.method}]: ${i.url.pathname.toUpperCase()}
[i] AVAILABLE PAGES:

${h}`)}return g}}},n=()=>Array.from({length:5},(p,i)=>(new Date().getHours()-(4-i)+24)%24);setInterval(()=>{let p=n();e.requests[p[0]-1]=0,e.data.incoming[p[0]-1]=0,e.data.outgoing[p[0]-1]=0},3e5);let c={},d,T;if(s.https.enabled){try{d=L.readFileSync(s.https.keyFile),T=L.readFileSync(s.https.certFile)}catch(p){throw new Error(`Cant access your HTTPS Key or Cert file! (${s.https.keyFile} / ${s.https.certFile})`)}c={key:d,cert:T}}let f=(s.https.enabled?ye:ge).createServer(c,async(p,i)=>{let t={content:Buffer.from(""),compressed:!1,events:new se.EventEmitter,waiting:!1,continue:!0,execute:{route:null,static:!1,exists:!1,dashboard:!1},body:{raw:Buffer.from(""),parsed:""},url:{...ie.parse(b(p.url)),method:p.method},previousHours:n()};t.events.on("noWaiting",()=>t.waiting=!1),i.once("close",()=>t.events.emit("endRequest")),s.body.enabled&&p.on("data",g=>{if(t.body.raw=Buffer.concat([t.body.raw,Buffer.from(g)]),t.body.raw.byteLength>=s.body.maxSize*1e6){switch(i.statusCode=413,t.continue=!1,typeof s.body.message){case"object":i.setHeader("Content-Type","application/json"),t.content=Buffer.from(JSON.stringify(s.body.message));break;case"string":t.content=Buffer.from(s.body.message);break;case"symbol":t.content=Buffer.from(s.body.message.toString());break;case"bigint":case"number":case"boolean":t.content=Buffer.from(String(s.body.message));break;case"undefined":t.content=Buffer.from("");break}return V({headers:new w(p.headers,decodeURIComponent),rawRes:i},t,s)}else e.data.incoming.total+=t.body.raw.byteLength,e.data.incoming[t.previousHours[4]]+=t.body.raw.byteLength}).on("end",()=>{t.continue&&t.events.emit("startRequest")}),t.events.once("startRequest",async()=>{var K,M;if(Object.keys(s.headers).forEach(o=>{i.setHeader(o,s.headers[o])}),s.cors&&(i.setHeader("Access-Control-Allow-Headers","*"),i.setHeader("Access-Control-Allow-Origin","*"),i.setHeader("Access-Control-Request-Method","*"),i.setHeader("Access-Control-Allow-Methods",A.join(",")),p.method==="OPTIONS"))return i.end("");let g={},y=t.url.pathname.split("/");for(let o=0;o<=e.routes.normal.length-1;o++){let a=e.routes.normal[o];if(e.cache.routes.has(`route::${t.url.pathname}`)){let l=e.cache.routes.get(`route::${t.url.pathname}`);g=l.params,t.execute.route=l.route,t.execute.static=l.route.method==="STATIC",t.execute.exists=!0;break}if(s.dashboard.enabled&&(t.url.pathname===b(s.dashboard.path)||t.url.pathname===b(s.dashboard.path)+"/stats")){t.execute.route={method:"GET",path:a.path,pathArray:a.path.split("/"),code:async l=>await F(l,e,t,s,e.routes.normal.length),data:{addTypes:!1}},t.execute.static=!1,t.execute.exists=!0,t.execute.dashboard=!0;break}if(!(a.method!=="STATIC"&&a.method!==p.method)&&!(a.method==="STATIC"&&p.method!=="GET")&&a.pathArray.length===y.length){if(t.execute.exists)break;if(a.path===t.url.pathname&&a.method===p.method){t.execute.route=a,t.execute.exists=!0,e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:{}});break}if(a.path===t.url.pathname&&a.method==="STATIC"){t.execute.route=a,t.execute.static=!0,t.execute.exists=!0,e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:{}});break}for(let l=0;l<=a.pathArray.length-1;l++){let m=a.pathArray[l],v=y[l];if(!/^:.*:$/.test(m)&&v!==m)break;if(m===v)continue;if(/^:.*:$/.test(m)){g[m.substring(1,m.length-1)]=v,t.execute.route=a,t.execute.exists=!0;continue}}if(t.execute.exists){e.cache.routes.set(`route::${t.url.pathname}`,{route:a,params:g});break}}}s.poweredBy&&i.setHeader("X-Powered-By","rjweb-server");let h;s.proxy&&p.headers["x-forwarded-for"]?h=p.headers["x-forwarded-for"]:h=p.socket.remoteAddress;let H={};if(p.headers.cookie&&p.headers.cookie.split(";").forEach(o=>{let a=o.split("=");H[a.shift().trim()]=a.join("=")}),p.headers["content-encoding"]==="gzip"&&(t.body.raw=await new Promise(o=>ne.gunzip(t.body.raw,(a,l)=>{o(a?t.body.raw:l)}))),s.body.parse)try{JSON.parse(t.body.raw.toString())}catch(o){t.body.parsed=t.body.raw.toString()}else t.body.parsed=t.body.raw.toString();let u={controller:e.controller,headers:new w(p.headers,decodeURIComponent),cookies:new w(H,decodeURIComponent),params:new w(g,decodeURIComponent),queries:new w(oe.parse(t.url.query),decodeURIComponent),client:{userAgent:p.headers["user-agent"],httpVersion:p.httpVersion,port:p.socket.remotePort,ip:h},body:t.body.parsed,url:t.url,rawServer:f,rawReq:p,rawRes:i,"@":{},setHeader(o,a){return i.setHeader(o,a),u},setCustom(o,a){return u["@"][o]=a,u},redirect(o,a){return i.statusCode=a!=null?a:302,i.setHeader("Location",o),u},print(o,a){var S,k,j;let l=(S=a==null?void 0:a.niceJSON)!=null?S:!1,m=(k=a==null?void 0:a.contentType)!=null?k:"",v=(j=a==null?void 0:a.returnFunctions)!=null?j:!1;switch(typeof o){case"object":i.setHeader("Content-Type","application/json"),l?t.content=Buffer.from(JSON.stringify(o,void 0,1)):t.content=Buffer.from(JSON.stringify(o));break;case"string":m&&i.setHeader("Content-Type",m),t.content=Buffer.from(o);break;case"symbol":m&&i.setHeader("Content-Type",m),t.content=Buffer.from(o.toString());break;case"bigint":case"number":case"boolean":m&&i.setHeader("Content-Type",m),t.content=Buffer.from(String(o));break;case"function":t.waiting=!0,(async()=>{let W=await o();if(typeof W!="function")u.print(W,{niceJSON:l,contentType:m});else if(v)u.print(W,{niceJSON:l,contentType:m,returnFunctions:v});else return u.error=new Error("Cant return functions from functions, consider using async/await"),r("error",u,t);let q=t.content;t.content=q,t.events.emit("noWaiting")})();break;case"undefined":m&&i.setHeader("Content-Type",m),t.content=Buffer.from("");break}return u},status(o){return i.statusCode=o!=null?o:200,u},printFile(o,a){var j,W,q;let l=(j=a==null?void 0:a.addTypes)!=null?j:!0,m=(W=a==null?void 0:a.contentType)!=null?W:"",v=(q=a==null?void 0:a.cache)!=null?q:!1;l&&!m?(o.endsWith(".pdf")&&u.setHeader("Content-Type","application/pdf"),o.endsWith(".js")&&u.setHeader("Content-Type","text/javascript"),o.endsWith(".html")&&u.setHeader("Content-Type","text/html"),o.endsWith(".css")&&u.setHeader("Content-Type","text/css"),o.endsWith(".csv")&&u.setHeader("Content-Type","text/csv"),o.endsWith(".mpeg")&&u.setHeader("Content-Type","video/mpeg"),o.endsWith(".mp4")&&u.setHeader("Content-Type","video/mp4"),o.endsWith(".webm")&&u.setHeader("Content-Type","video/webm"),o.endsWith(".bmp")&&u.setHeader("Content-Type","image/bmp")):m&&i.setHeader("Content-Type",m);let S,k=!1;if(u.headers.get("accept-encoding").includes(x[s.compression])){if(u.rawRes.setHeader("Content-Encoding",x[s.compression]),u.rawRes.setHeader("Vary","Accept-Encoding"),t.continue=!1,e.cache.files.has(`file::${o}`))return e.data.outgoing.total+=e.cache.files.get(`file::${o}`).byteLength,e.data.outgoing[t.previousHours[4]]+=e.cache.files.get(`file::${o}`).byteLength,t.content=e.cache.files.get(`file::${o}`),t.continue=!0,u;if(e.cache.files.has(`file::${s.compression}::${o}`))return t.compressed=!0,e.data.outgoing.total+=e.cache.files.get(`file::${s.compression}::${o}`).byteLength,e.data.outgoing[t.previousHours[4]]+=e.cache.files.get(`file::${s.compression}::${o}`).byteLength,t.content=e.cache.files.get(`file::${s.compression}::${o}`),t.continue=!0,u;let R=I(s.compression);try{S=L.createReadStream(o),t.waiting=!0,S.pipe(R),R.pipe(i)}catch(E){k=!0,u.error=E,r("error",u,t)}if(k)return;R.on("data",E=>{var U;if(e.data.outgoing.total+=E.byteLength,e.data.outgoing[t.previousHours[4]]+=E.byteLength,v){let ue=(U=e.cache.files.get(`file::${s.compression}::${o}`))!=null?U:Buffer.from("");e.cache.files.set(`file::${s.compression}::${o}`,Buffer.concat([ue,E]))}}),R.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>{S.close(),R.close()})}else{try{S=L.createReadStream(o),t.waiting=!0,S.pipe(i)}catch(R){k=!0,u.error=R,r("error",u,t)}S.on("data",R=>{var E;if(e.data.outgoing.total+=R.byteLength,e.data.outgoing[t.previousHours[4]]+=R.byteLength,v){let U=(E=e.cache.files.get(`file::${s.compression}::${o}`))!=null?E:Buffer.from("");e.cache.files.set(`file::${s.compression}::${o}`,Buffer.concat([U,R]))}}),S.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>S.close())}return u}},D=!1;if(t.execute.dashboard||(D=await r("request",u,t)),!D){if(s.rateLimits.enabled){for(let o of s.rateLimits.list)if(t.url.pathname.startsWith(o.path)&&(i.setHeader("X-RateLimit-Limit",o.times),i.setHeader("X-RateLimit-Remaining",o.times-((K=await s.rateLimits.functions.get(h+o.path))!=null?K:0)),i.setHeader("X-RateLimit-Reset-Every",o.timeout),await s.rateLimits.functions.set(h+o.path,((M=await s.rateLimits.functions.get(h+o.path))!=null?M:0)+1),setTimeout(async()=>{var a;await s.rateLimits.functions.set(h+o.path,((a=await s.rateLimits.functions.get(h+o.path))!=null?a:0)-1)},o.timeout),await s.rateLimits.functions.get(h+o.path)>o.times))return i.statusCode=429,D=!0,u.print(s.rateLimits.message),V(u,t,s)}if(s.dashboard.enabled&&!t.execute.dashboard&&(e.requests.total++,e.requests[t.previousHours[4]]++),!await new Promise(o=>{if(!t.waiting)return o(!1);t.events.once("noWaiting",()=>o(!1)),t.events.once("endRequest",()=>o(!0))}))if(t.execute.exists&&!D){if(!t.execute.static)await Promise.resolve(t.execute.route.code(u)).catch(o=>{u.error=o,D=!0,r("error",u,t)});else if(t.execute.route.data.addTypes&&(t.execute.route.path.endsWith(".pdf")&&u.setHeader("Content-Type","application/pdf"),t.execute.route.path.endsWith(".js")&&u.setHeader("Content-Type","text/javascript"),t.execute.route.path.endsWith(".html")&&u.setHeader("Content-Type","text/html"),t.execute.route.path.endsWith(".css")&&u.setHeader("Content-Type","text/css"),t.execute.route.path.endsWith(".csv")&&u.setHeader("Content-Type","text/csv"),t.execute.route.path.endsWith(".mpeg")&&u.setHeader("Content-Type","video/mpeg"),t.execute.route.path.endsWith(".mp4")&&u.setHeader("Content-Type","video/mp4"),t.execute.route.path.endsWith(".webm")&&u.setHeader("Content-Type","video/webm"),t.execute.route.path.endsWith(".bmp")&&u.setHeader("Content-Type","image/bmp")),t.continue=!1,"content"in t.execute.route.data)e.data.outgoing.total+=t.execute.route.data.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.execute.route.data.content.byteLength,t.content=t.execute.route.data.content;else{let o=ae.resolve(t.execute.route.data.file),a,l=!1;if(s.compression&&String(u.headers.get("accept-encoding")).includes(x[s.compression])){u.rawRes.setHeader("Content-Encoding",x[s.compression]),u.rawRes.setHeader("Vary","Accept-Encoding");let m=I(s.compression);try{a=L.createReadStream(o),t.waiting=!0,a.pipe(m),m.pipe(i)}catch(v){l=!0,u.error=v,r("error",u,t)}if(l)return;m.on("data",v=>{e.data.outgoing.total+=v.byteLength,e.data.outgoing[t.previousHours[4]]+=v.byteLength}),m.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>{a.close(),m.close()})}else{try{a=L.createReadStream(o),t.waiting=!0,a.pipe(i)}catch(m){l=!0,u.error=m,r("error",u,t)}a.on("data",m=>{e.data.outgoing.total+=m.byteLength,e.data.outgoing[t.previousHours[4]]+=m.byteLength}),a.once("end",()=>{t.events.emit("noWaiting"),t.content=Buffer.from("")}),i.once("close",()=>a.close())}}await new Promise(o=>{if(!t.waiting)return o(!0);t.events.once("noWaiting",()=>o(!1))}),t.content&&t.continue?(e.data.outgoing.total+=t.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.content.byteLength,V(u,t,s)):i.end()}else r("notfound",u,t),await new Promise(o=>{if(!t.waiting)return o(!0);t.events.once("noWaiting",()=>o(!1))}),t.content&&t.continue?(e.data.outgoing.total+=t.content.byteLength,e.data.outgoing[t.previousHours[4]]+=t.content.byteLength,V(u,t,s)):i.end()}}),s.body.enabled||t.events.emit("startRequest")});return e.controller=new N(e,f,s),e.controller}};
