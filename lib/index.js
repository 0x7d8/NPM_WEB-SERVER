"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const routeList_1=__importDefault(require("./classes/routeList")),types_1=__importDefault(require("./interfaces/types")),types_2=__importDefault(require("./misc/types")),path=__importStar(require("path")),http=__importStar(require("http")),url=__importStar(require("url")),fs=__importStar(require("fs"));module.exports={routeList:routeList_1.default,types:types_1.default,async start(e){const t=e?.pages??{},r=e?.events??{},o=e?.urls.list()??[],n=e?.proxy??!1,s=e?.rateLimits??{enabled:!1,list:[]},a=e?.bind??"0.0.0.0",i=e?.cors??!1,d=e?.port??5002,c=e?.body??20,p=http.createServer((async(e,a)=>{let d="";if(e.headers["content-length"]){if(parseInt(e.headers["content-length"])>=1e6*c)return a.statusCode=413,a.write("Payload Too Large"),a.end()}e.on("data",(e=>{d+=e})).on("end",(async()=>{let c={...url.parse(e.url),method:e.method};c.path.endsWith("/")&&(c.path=c.path.slice(0,-1));let l="";try{d=JSON.parse(d)}catch(e){}if(i&&(a.setHeader("Access-Control-Allow-Headers","*"),a.setHeader("Access-Control-Allow-Origin","*"),a.setHeader("Access-Control-Request-Method","*"),a.setHeader("Access-Control-Allow-Methods",types_2.default.join(",")),"OPTIONS"===e.method))return a.end("");let h,u=new Map,f=!1;const m=c.pathname.split("/");""===m[m.length-1]&&m.pop();for(const t in o){if(t in o&&t.replace(e.method,"")===c.pathname&&o[t].type===e.method){l=e.method+c.pathname,f=!1,h=!0;break}if(t in o&&t.replace(e.method,"")===c.pathname&&"STATIC"===o[t].type){l=e.method+c.pathname,f=!0,h=!0;break}const r=o[t];if(r.type!==e.method)continue;if(r.array.length!==m.length)continue;if(h&&r.array.join("/")!==l)break;let n=0;for(const t of r.array){const t=r.array[n],o=m[n];if(n++,!t.startsWith(":")&&o!==t)break;t!==o&&(t.startsWith(":")&&(u.set(t.replace(":",""),decodeURIComponent(o)),l=e.method+r.array.join("/"),h=!0))}}let y;y=n&&e.headers["x-forwarded-for"]?e.headers["x-forwarded-for"]:e.socket.remoteAddress;const w=new Map;Object.keys(e.headers).forEach((t=>{w.set(t,e.headers[t])})),w.delete("cookie");const _=new Map;for(const[e,t]of new URLSearchParams(c.search))_.set(e,t);const g=new Map;e.headers.cookie&&e.headers.cookie.split(";").forEach((e=>{let[t,...r]=e.split("=");if(t=t?.trim(),!t)return;const o=r.join("=").trim();o&&g.set(t,decodeURIComponent(o))})),a.setHeader("X-Powered-By","rjweb-server");let b={header:w,cookie:g,param:u,query:_,hostPort:e.socket.remotePort,hostIp:y,reqBody:d,reqUrl:c,rawServer:p,rawReq:e,rawRes:a,"@":{},setHeader:(e,t)=>(a.setHeader(e,t),b),setCustom:(e,t)=>(b["@"][e]=t,b),print(e,r){const o=r?.niceJSON??!1;switch(typeof e){case"object":a.setHeader("Content-Type","application/json"),o?a.write(JSON.stringify(e,void 0,1)):a.write(JSON.stringify(e));break;case"bigint":case"number":case"boolean":a.write(e.toString());break;case"function":a.write(e());break;case"undefined":a.write("");break;default:try{a.write(e)}catch(e){"reqError"in t?(b.error=e,Promise.resolve(t.reqError(b)).catch((e=>{console.log(e),a.statusCode=500,a.write(e),a.end()})).then((()=>a.end())),C=!0):(C=!0,console.log(e),a.statusCode=500,a.end())}}return b},status:e=>(a.statusCode=e,b),printFile(e){const t=fs.readFileSync(e);return a.write(t,"binary"),b}},C=!1;if("request"in r&&await r.request(b).catch((e=>{if(!("reqError"in t))return C=!0,console.log(e),a.statusCode=500,a.end();b.error=e,Promise.resolve(t.reqError(b)).catch((e=>{console.log(e),a.statusCode=500,a.write(e),a.end()})).then((()=>a.end())),C=!0})),!C){if(s.enabled)for(const e of s.list)if(c.path.startsWith(e.path)&&(a.setHeader("X-RateLimit-Limit",e.times),a.setHeader("X-RateLimit-Remaining",e.times-(await s.functions.get(y+e.path)??0)),a.setHeader("X-RateLimit-Reset-Every",e.timeout),await s.functions.set(y+e.path,(await s.functions.get(y+e.path)??0)+1),setTimeout((async()=>{await s.functions.set(y+e.path,(await s.functions.get(y+e.path)??0)-1)}),e.timeout),await s.functions.get(y+e.path)>e.times))return a.statusCode=429,b.print(s.message??"Rate Limited"),a.end();if(h){if(f){if(o[l].addTypes&&(o[l].path.endsWith(".pdf")&&b.setHeader("Content-Type","application/pdf"),o[l].path.endsWith(".js")&&b.setHeader("Content-Type","text/javascript"),o[l].path.endsWith(".html")&&b.setHeader("Content-Type","text/html"),o[l].path.endsWith(".css")&&b.setHeader("Content-Type","text/css"),o[l].path.endsWith(".csv")&&b.setHeader("Content-Type","text/csv"),o[l].path.endsWith(".mpeg")&&b.setHeader("Content-Type","video/mpeg"),o[l].path.endsWith(".mp4")&&b.setHeader("Content-Type","video/mp4"),o[l].path.endsWith(".webm")&&b.setHeader("Content-Type","video/webm"),o[l].path.endsWith(".bmp")&&b.setHeader("Content-Type","image/bmp")),!("content"in o[l])){let e;const t=path.resolve(o[l].file);try{e=fs.readFileSync(t)}catch(e){return console.log(e),a.end()}return a.write(e,"binary"),a.end()}return a.write(o[l].content,"binary"),a.end()}Promise.resolve(o[l].code(b)).catch((e=>{"reqError"in t?(b.error=e,Promise.resolve(t.reqError(b)).catch((e=>{console.log(e),a.statusCode=500,a.write(e),a.end()})).then((()=>a.end()))):(console.log(e),a.statusCode=500,a.write(e),a.end())})).then((()=>a.end()))}else if("notFound"in t)Promise.resolve(t.notFound(b)).catch((e=>{"reqError"in t?(b.error=e,t.reqError(b).catch((e=>{console.log(e),a.statusCode=500,a.write(e),a.end()})).then((()=>a.end()))):(console.log(e),a.statusCode=500,a.write(e),a.end())})).then((()=>a.end()));else{let e="";for(const t in o){const r=o[t];e+=`[-] [${"STATIC"===r.type?"GET":r.type}] ${r.path}\n`}a.statusCode=404,a.write(`[!] COULDNT FIND ${c.pathname.toUpperCase()}\n[i] AVAILABLE PAGES:\n\n${e}`),a.end()}}}))}));return p.on("upgrade",((e,t,r)=>{t.write("HTTP/1.1 101 Web Socket Protocol Handshake\r\nUpgrade: WebSocket\r\nConnection: Upgrade\r\n\r\n"),t.pipe(t)})),p.listen(d,a),new Promise(((e,t)=>{p.once("listening",(()=>e({success:!0,port:d,message:"WEBSERVER STARTED",rawServer:p}))),p.once("error",(e=>t({success:!1,error:e,message:"WEBSERVER ERRORED"})))}))}};