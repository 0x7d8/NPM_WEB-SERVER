<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="https://img.rjansen.de/rjweb/icon.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <title>rjweb-server Dashboard</title>
</head>
<body class="bg-gray-900">
  <header class="flex justify-between bg-gray-600 p-4 text-white">
    <h1 class="flex flex-row text-5xl">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-adjustments-alt self-center" width="48" height="48" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <rect x="4" y="8" width="4" height="4"></rect>
        <line x1="6" y1="4" x2="6" y2="8"></line>
        <line x1="6" y1="12" x2="6" y2="20"></line>
        <rect x="10" y="14" width="4" height="4"></rect>
        <line x1="12" y1="4" x2="12" y2="14"></line>
        <line x1="12" y1="18" x2="12" y2="20"></line>
        <rect x="16" y="5" width="4" height="4"></rect>
        <line x1="18" y1="4" x2="18" y2="5"></line>
        <line x1="18" y1="9" x2="18" y2="20"></line>
      </svg>
      <div class="flex flex-col">
        RJWEB
        <p class="text-sm text-gray-300">1.1.1</p>
      </div>
    </h1>
    <a
      class="flex justify-center self-center bg-slate-900 w-12 h-12 rounded hover:bg-slate-800"
      href="https://github.com/rotvproHD/NPM_WEB-SERVER"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github self-center" width="32" height="32" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path>
      </svg>
    </a>
  </header>
  <main>
    <div class="mt-8 flex flex-wrap justify-center">

      <div class="w-96 mx-4 mb-8 text-center">
        <div class="p-1 bg-slate-600 rounded">
          <h1 class="text-white">Requests</h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 id="stat-requests" class="flex justify-center text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-loader-2 animate-spin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M12 3a9 9 0 1 0 9 9"></path>
            </svg>
          </h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 class="flex justify-center text-white">
            <canvas id="stat-requests-chart"></canvas>
          </h1>
        </div>
      </div>

      <div class="w-96 mx-4 mb-8 text-center">
        <div class="p-1 bg-slate-600 rounded">
          <h1 class="text-white">WebSockets Opened</h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 id="stat-websocketsOpened" class="flex justify-center text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-loader-2 animate-spin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M12 3a9 9 0 1 0 9 9"></path>
            </svg>
          </h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 class="flex justify-center text-white">
            <canvas id="stat-websocketsOpened-chart"></canvas>
          </h1>
        </div>
      </div>

      <div class="w-96 mx-4 mb-8 text-center">
        <div class="p-1 bg-slate-600 rounded">
          <h1 class="text-white">WebSocket Messages</h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 id="stat-websocketMessages" class="flex justify-center text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-loader-2 animate-spin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M12 3a9 9 0 1 0 9 9"></path>
            </svg>
          </h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 class="flex justify-center text-white">
            <canvas id="stat-websocketMessages-chart"></canvas>
          </h1>
        </div>
      </div>

      <div class="w-96 mx-4 mb-8 text-center">
        <div class="p-1 bg-slate-600 rounded">
          <h1 class="text-white">Network Traffic</h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 id="stat-network" class="flex justify-center text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-loader-2 animate-spin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M12 3a9 9 0 1 0 9 9"></path>
            </svg>
          </h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 class="flex justify-center text-white">
            <canvas id="stat-network-chart"></canvas>
          </h1>
        </div>
      </div>

      <div class="w-96 mx-4 mb-8 text-center">
        <div class="p-1 bg-slate-600 rounded">
          <h1 class="text-white">CPU Usage</h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 id="stat-cpu" class="flex justify-center text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-loader-2 animate-spin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M12 3a9 9 0 1 0 9 9"></path>
            </svg>
          </h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 class="flex justify-center text-white">
            <canvas id="stat-cpu-chart"></canvas>
          </h1>
        </div>
      </div>

      <div class="w-96 mx-4 mb-8 text-center">
        <div class="p-1 bg-slate-600 rounded">
          <h1 class="text-white">Memory Usage</h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 id="stat-memory" class="flex justify-center text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-loader-2 animate-spin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M12 3a9 9 0 1 0 9 9"></path>
            </svg>
          </h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 class="flex justify-center text-white">
            <canvas id="stat-memory-chart"></canvas>
          </h1>
        </div>
      </div>

    </div>

    <div class="mt-16 flex flex-wrap justify-center">

      <div class="w-96 mx-4 mb-8 text-center">
        <div class="p-1 bg-slate-600 rounded">
          <h1 class="text-white">User Routes</h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 id="stat-userRoutes" class="flex justify-center text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-loader-2 animate-spin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M12 3a9 9 0 1 0 9 9"></path>
            </svg>
          </h1>
        </div>
      </div>

      <div class="w-96 mx-4 mb-8 text-center">
        <div class="p-1 bg-slate-600 rounded">
          <h1 class="text-white">Automatic Routes</h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 id="stat-automaticRoutes" class="flex justify-center text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-loader-2 animate-spin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M12 3a9 9 0 1 0 9 9"></path>
            </svg>
          </h1>
        </div>
      </div>

      <div class="w-96 mx-4 mb-8 text-center">
        <div class="p-1 bg-slate-600 rounded">
          <h1 class="text-white">Static Files</h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 id="stat-staticFiles" class="flex justify-center text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-loader-2 animate-spin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M12 3a9 9 0 1 0 9 9"></path>
            </svg>
          </h1>
        </div>
      </div>

      <div class="w-96 mx-4 mb-8 text-center">
        <div class="p-1 bg-slate-600 rounded">
          <h1 class="text-white">Cached Objects</h1>
        </div>
        <div class="mt-2 p-2 bg-slate-600 rounded">
          <h1 id="stat-cached" class="flex justify-center text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-loader-2 animate-spin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M12 3a9 9 0 1 0 9 9"></path>
            </svg>
          </h1>
        </div>
      </div>

    </div>
  </main>
</body>
<script>
  Chart.defaults.color = '#fff'

  const requestChart = new Chart(document.querySelector('#stat-requests-chart'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Requests',
        data: [],
        fill: 'start',
        tension: 0.4
      }]
    }, options: {
      plugins: {
        legend: {
          display: false
        }, filler: {
          propagate: false,
        }
      }, interaction: {
        intersect: false,
      }, scales: {
        y: {
          min: 0,
          suggestedMax: 10
        }
      }
    },
  }), websocketsOpenedChart = new Chart(document.querySelector('#stat-websocketsOpened-chart'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'WebSockets Opened',
        data: [],
        fill: 'start',
        tension: 0.4
      }]
    }, options: {
      plugins: {
        legend: {
          display: false
        }, filler: {
          propagate: false,
        }
      }, interaction: {
        intersect: false,
      }, scales: {
        y: {
          min: 0,
          suggestedMax: 10
        }
      }
    },
  }), websocketMessagesChart = new Chart(document.querySelector('#stat-websocketMessages-chart'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Outgoing',
        data: [],
        fill: 'start',
        tension: 0.4
      }, {
        label: 'Incoming',
        data: [],
        fill: 'start',
        tension: 0.4
      }]
    }, options: {
      plugins: {
        legend: {
          display: false
        }, filler: {
          propagate: false,
        }
      }, interaction: {
        intersect: false,
      }, scales: {
        y: {
          min: 0,
          suggestedMax: 10
        }
      }
    },
  }), networkChart = new Chart(document.querySelector('#stat-network-chart'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Outgoing',
        data: [],
        fill: 'start',
        tension: 0.4
      }, {
        label: 'Incoming',
        data: [],
        fill: 'start',
        tension: 0.4
      }]
    }, options: {
      plugins: {
        legend: {
          display: false
        }, filler: {
          propagate: false,
        }, tooltip: {
          callbacks: {
            label: (value) => `${value.dataset.label}: ${formatBytes(value.parsed.y).amount}${formatBytes(value.parsed.y).format}`
          }
        }
      }, interaction: {
        intersect: false,
      }, scales: {
        y: {
          ticks: {
            callback: (value) => `${formatBytes(value).amount}${formatBytes(value).format}`
          }, min: 0
        }
      }
    },
  }), cpuChart = new Chart(document.querySelector('#stat-cpu-chart'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'CPU Usage',
        data: [],
        fill: 'start',
        tension: 0.4,
        pointRadius: 0
      }]
    }, options: {
      hover: { mode: null },
      plugins: {
        legend: {
          display: false
        }, filler: {
          propagate: false,
        }, tooltip: {
          enabled: false
        }
      }, interaction: {
        intersect: false,
      }, scales: {
        y: {
          ticks: {
            callback: (value) => `${value}%`
          }, min: 0,
          suggestedMax: 5
        }
      }
    },
  }), memoryChart = new Chart(document.querySelector('#stat-memory-chart'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Memory Usage',
        data: [],
        fill: 'start',
        tension: 0.4,
        pointRadius: 0
      }]
    }, options: {
      hover: { mode: null },
      plugins: {
        legend: {
          display: false
        }, filler: {
          propagate: false,
        }, tooltip: {
          enabled: false
        }
      }, interaction: {
        intersect: false,
      }, scales: {
        y: {
          ticks: {
            callback: (value) => `${value}MB`
          }, min: 0
        }
      }
    },
  })

  Number.prototype.toFixedNum = function(decimals) {
    return parseInt(this.toFixed(decimals))
  }

  function formatBytes(bytes) {
    if (bytes < 1024) return { amount: (bytes), format: 'B' }
    else if (bytes < 1048576) return { amount: (bytes / 1024).toFixed(2), format: 'KB' }
    else if (bytes < 1073741824) return { amount: (bytes / 1048576).toFixed(2), format: 'MB' }
    else return { amount: (bytes / 1073741824).toFixed(2), format: 'GB' }
  }


  let socket, password = ''
  if (/* PWD */ true) password = encodeURIComponent(prompt('Please enter the Dashboard Password'))
  try {
    socket = new WebSocket(`ws://${window.location.hostname}:${window.location.port}/rjweb-dashboard/ws?password=${password}`)
  } catch {
    socket = new WebSocket(`wss://${window.location.hostname}:${window.location.port}/rjweb-dashboard/ws?password=${password}`)
  }

  socket.addEventListener('message', (event) => {
    const data = JSON.parse(event.data)

    document.querySelector('#stat-cpu').innerText = data.cpu.usage + '%'
    document.querySelector('#stat-memory').innerText = data.memory.usage + 'MB'
    document.querySelector('#stat-userRoutes').innerText = data.user_routes
    document.querySelector('#stat-automaticRoutes').innerText = data.automatic_routes
    document.querySelector('#stat-staticFiles').innerText = data.static_files
    document.querySelector('#stat-cached').innerText = data.cached

    for (let stat = 2; stat < data.requests.length; stat++) {
      const { hour, amount } = data.requests[stat]

      requestChart.data.labels[stat - 2] = `${hour}:00`
      requestChart.data.datasets[0].data[stat - 2] = amount
    }; requestChart.update()
    document.querySelector('#stat-requests').innerText = `${data.requests[0]} (${data.requests[1].toFixedNum(2)}/s)`
    for (let stat = 2; stat < data.web_sockets.opened.length; stat++) {
      const { hour, amount } = data.web_sockets.opened[stat]

      websocketsOpenedChart.data.labels[stat - 2] = `${hour}:00`
      websocketsOpenedChart.data.datasets[0].data[stat - 2] = amount
    }; websocketsOpenedChart.update()
    document.querySelector('#stat-websocketsOpened').innerText = `${data.web_sockets.opened[0]} (${data.web_sockets.opened[1].toFixedNum(2)}/s)`
    for (let stat = 2; stat < data.data.outgoing.length; stat++) {
      const { hour, amount } = data.web_sockets.messages.outgoing[stat]

      websocketMessagesChart.data.labels[stat - 2] = `${hour}:00`
      websocketMessagesChart.data.datasets[0].data[stat - 2] = amount
    }; for (let stat = 2; stat < data.data.incoming.length; stat++) {
      const { hour, amount } = data.web_sockets.messages.incoming[stat]

      websocketMessagesChart.data.labels[stat - 2] = `${hour}:00`
      websocketMessagesChart.data.datasets[1].data[stat - 2] = amount
    }; websocketMessagesChart.update()
    document.querySelector('#stat-websocketMessages').innerText = `${data.web_sockets.messages.outgoing[0]} (${data.web_sockets.messages.outgoing[1].toFixedNum(2)}/s) | ${data.web_sockets.messages.incoming[0]} (${data.web_sockets.messages.incoming[1].toFixedNum(2)}/s)`
    for (let stat = 2; stat < data.data.outgoing.length; stat++) {
      const { hour, amount } = data.data.outgoing[stat]

      networkChart.data.labels[stat - 2] = `${hour}:00`
      networkChart.data.datasets[0].data[stat - 2] = amount
    }; for (let stat = 2; stat < data.data.incoming.length; stat++) {
      const { hour, amount } = data.data.incoming[stat]

      networkChart.data.labels[stat - 2] = `${hour}:00`
      networkChart.data.datasets[1].data[stat - 2] = amount
    }; networkChart.update()
    document.querySelector('#stat-network').innerText = `${formatBytes(data.data.outgoing[0]).amount}${formatBytes(data.data.outgoing[0]).format} (${formatBytes(data.data.outgoing[1]).amount}${formatBytes(data.data.outgoing[1]).format}/s) | ${formatBytes(data.data.incoming[0]).amount}${formatBytes(data.data.incoming[0]).format} (${formatBytes(data.data.incoming[1]).amount}${formatBytes(data.data.incoming[1]).format}/s)`

    cpuChart.data.labels.push('')
    cpuChart.data.datasets[0].data.push(data.cpu.usage)
    if (cpuChart.data.labels.length >= 20) {
      cpuChart.data.labels.shift()
      cpuChart.data.datasets[0].data.shift()
    }; cpuChart.update()
    memoryChart.data.labels.push('')
    memoryChart.data.datasets[0].data.push(data.memory.usage)
    if (memoryChart.data.labels.length >= 20) {
      memoryChart.data.labels.shift()
      memoryChart.data.datasets[0].data.shift()
    }; memoryChart.update()
  })

  socket.addEventListener('close', () => {
    window.location.reload()
  })
</script>
</html>